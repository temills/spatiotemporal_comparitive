---
title: "estimate_model_probs"
output: html_document
---

```{r, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=4, fig.height=3,fig.align = "center",cache=TRUE)
library(ggplot2)
library(reshape)
library(grid)
library(purrr)
library(dplyr)
library(gridExtra)
library(lme4)
library(ggimage)
library(reghelper)
library(RColorBrewer)
library(robustbase)
library(tidylog)
library(hash)
library(rstan)
library(png)
library(gtable)
library(stringr)
library(tidyr)

paper_theme <- theme_light() + theme( axis.title.x = element_text(size=22),
                                      axis.text.x=element_text(
                                        size = 18), 
                                      axis.title.y = element_text(size = 22, vjust = 1),
                                      axis.text.y  = element_text(size = 18),
                             strip.text=element_text(size=16),
                                      axis.line.x = element_line(colour = "black"), 
                                      axis.line.y = element_line(colour = "black"),
                                      legend.title=element_text(size=20),
                                      legend.text=element_text(size=16),
                                      panel.grid.major=element_blank(),
                                      panel.grid.minor=element_blank())  

is_repeat_df <- read.csv("data/next_is_repeat.csv")

preprocess_df_human <- function(df) {
  df <- df %>%
        filter(!(is.na(trial_idx))) %>%
        rename(x_curr = prev_x, y_curr = prev_y, x_next = true_x, y_next = true_y,
               x_pred = response_x, y_pred = response_y, func.type = seq_id)
  df <- merge(df, is_repeat_df, by = c("func.type", "tpt"), suffixes=c("", ".temp")) %>%
        subset(select = -c(X, X.temp, x_next.temp, y_next.temp))
  df <- df[order(df$tpt),]
  return(df)
}

preprocess_df_monkey <- function(df) {
  df <- df[order(df$n),] %>%
      rename(tpt = n, subject_id = monkey_name) %>%
      group_by(subject_id, r_id, tpt) %>%
      ungroup() %>%
      mutate(tpt = tpt+1) %>%
      filter(tpt<15) %>%
      filter(tpt>2)
  df <- merge(df, is_repeat_df, by = c("func.type", "tpt"), suffixes=c("", ".temp")) %>%
        subset(select = -c(X, X.temp, x_next.temp, y_next.temp))
  df <- df[order(df$tpt),]
  return(df)
}

preprocess_df_model <- function(df) {
  get_posterior <- function(df) {
    logsumexp <- function(x) {
      max_x <- max(x)
      max_x + log(sum(exp(x - max_x)))
    }
    df <- df %>%
          group_by(tpt, func.type) %>%
          mutate(norm = logsumexp(score)) %>%
          ungroup() %>%
          mutate(posterior = exp(score - norm)) 
    return(df)
  }
  df <- df %>%
        rename(func.type = seq_id, x_pred=pred_x, y_pred=pred_y) %>%
        get_posterior()
  return(df)
}
```


# Load participant data
```{r, message=F}
df_kid <- preprocess_df_human(read.csv("data/participants/kids.csv"))
df_adult <-  preprocess_df_human(read.csv("data/participants/adults.csv"))
df_monkey <-  preprocess_df_monkey(read.csv("data/participants/monkeys_1.csv"))
```
# Load model data
```{r}
df_lot <- preprocess_df_model(read.csv("data/models/lot.csv"))
df_gpnc <- preprocess_df_model(read.csv("data/models/gpnc.csv"))
df_gpsl <- preprocess_df_model(read.csv("data/models/gpsl.csv"))
df_lin <- preprocess_df_model(read.csv("data/models/linear.csv"))
df_ridge <- preprocess_df_model(read.csv("data/models/ridge.csv"))
```

# Stan model helpers
```{r}
get_stan_df <- function(human_df, model_df_list, model_name_list) {
  bounds_df <- human_df %>%
               select(c("func.type", "tpt", "min_x", "max_x", "min_y", "max_y")) %>%
               group_by(func.type, tpt) %>%
               summarize(min_x = mean(min_x, na.rm=T), min_y=mean(min_y, na.rm=T),
                         max_x=mean(max_x, na.rm=T), max_y=mean(max_y, na.rm=T))
  
  df <- human_df
  #scale all model predictions
  for(i in seq_along(model_name_list)) {
      model_name <- model_name_list[i]
      
      model_df <- model_df_list[[i]] %>%
            merge(bounds_df, by=c("func.type", "tpt")) %>%
            mutate(scale_by = (max_x-min_x)) %>%
            mutate(x_pred = (x_pred-min_x)/(scale_by),
                   y_pred = (y_pred-min_y)/(scale_by),
                   sd_x = sd_x/(scale_by),
                   sd_y = sd_y/(scale_by)) %>%
            mutate(x_pred = ifelse(x_pred < 0, 0, x_pred),
                   x_pred = ifelse(x_pred > 1, 1, x_pred),
                   y_pred = ifelse(y_pred < 0, 0, y_pred),
                   y_pred = ifelse(y_pred > 1, 1, y_pred)) %>%
            group_by(func.type, tpt) %>%
            arrange(particle) %>%
            summarise(!!paste0(model_name, "_x_pred") := list(x_pred),
                      !!paste0(model_name, "_y_pred") := list(y_pred),
                      !!paste0(model_name, "_posterior") := list(posterior),
                      !!paste0(model_name, "_sd_x") := list(sd_x),
                      !!paste0(model_name, "_sd_y") := list(sd_y)) %>%
            ungroup()
      df <- merge(df, model_df, by=c("func.type", "tpt"))
  }
  #scale true points and human predictions
  stan_df <- df %>%
            filter(!is.na(x_pred) & (!is.na(y_pred))) %>%
            mutate(scale_by = (max_x-min_x)) %>%
            mutate(upper_bound_y = (max_y-min_y)/(max_x-min_x)) %>%
            mutate(x_curr = (x_curr-min_x)/scale_by,
                   x_pred = (x_pred-min_x)/scale_by,
                   y_curr = (y_curr-min_y)/scale_by,
                   y_pred = (y_pred-min_y)/scale_by) %>%
            mutate(guess_num = tpt - 2) %>%
            mutate(guess_num_std = (guess_num - min(guess_num))/(max(guess_num)-min(guess_num)))
  return(stan_df)
}

get_stan_data <- function(stan_df, model_name_list) {
  N = length(stan_df$x_pred)
  M = length(model_name_list)
  P = 20
  
  model_x_pred <- array(NA, dim = c(N, M, P))
  model_y_pred <- array(NA, dim = c(N, M, P))
  model_posterior <- array(NA, dim = c(N, M, P))
  model_sd_x <- array(NA, dim = c(N, M, P))
  model_sd_y <- array(NA, dim = c(N, M, P))
  
  for (i in 1:N) {
    for (m in 1:M) {
      model_x_pred[i, m, ] <- unlist(stan_df[[paste0(model_name_list[m], "_x_pred")]][i])
      model_y_pred[i, m, ] <- unlist(stan_df[[paste0(model_name_list[m], "_y_pred")]][i])
      model_sd_x[i, m, ] <- unlist(stan_df[[paste0(model_name_list[m], "_sd_x")]][i])
      model_sd_y[i, m, ] <- unlist(stan_df[[paste0(model_name_list[m], "_sd_y")]][i])
      model_posterior[i, m, ] <- unlist(stan_df[[paste0(model_name_list[m], "_posterior")]][i])
    }
  }
  
  stan_data <- list(
    N = N,
    M = M,
    P = P,
    x_pred = stan_df$x_pred,
    y_pred = stan_df$y_pred,
    x_curr = stan_df$x_curr,
    y_curr = stan_df$y_curr,
    model_x_pred = model_x_pred,
    model_y_pred = model_y_pred,
    model_sd_x = model_sd_x,
    model_sd_y = model_sd_y,
    upper_bound_y = stan_df$upper_bound_y,
    model_particle_score = model_posterior,
    n_subjs = length(unique(stan_df$subject_id)),
    subj = setNames(var_maps$subject_id[stan_df$subject_id], NULL)
  )
  return(stan_data)
}

run_inference <- function(stan_df, n_iter, n_chains, model_name_list) {
  stan_data <- get_stan_data(stan_df, model_name_list)
  model_path <- "stan_models/infer_p_models.stan"
  fit <- stan(file=model_path, data=stan_data, iter=n_iter, chains=n_chains, cores=n_chains)
  return(fit)
}

refactor_posterior <- function(posterior_samples) {
  refactored_post <- posterior_samples %>%
                     rename_with(~ gsub("posterior_probs\\.(\\d+)\\.(\\d+)", "posterior_probs.\\2.\\1", .x)) %>%
                     rename_with(~ gsub("log_likelihoods\\.(\\d+)\\.(\\d+)", "log_likelihoods.\\2.\\1", .x)) %>%
                     rename_with(~ gsub("p_lapse_type\\.(\\d+)\\.(\\d+)", "p_lapse_type.\\2.\\1", .x)) %>%
                     pivot_longer(cols = matches("p_lapse\\.\\d+|lapse_sd\\.\\d+|motor_sd\\.\\d+|posterior_probs\\.\\d+|log_likelihoods\\.\\d+|p_lapse_type\\.\\d+"),
                                  names_to = c(".value", "subj"),
                                  names_pattern = "(p_lapse|lapse_sd|motor_sd|posterior_probs.\\d+|log_likelihoods.\\d+|p_lapse_type.\\d+)\\.(\\d+)")          
  refactored_post$subject_id <- names(var_maps$subject_id)[match(refactored_post$subj, var_maps$subject_id)]
  return(refactored_post)
}

run_inference_mixture <- function(stan_df, n_iter, n_chains, model_name_list) {
  stan_data <- get_stan_data(stan_df, model_name_list)
  model_path <- "/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/spatiotemporal_comparitive/stan_models/infer_p_models_mixture.stan"
  fit <- stan(file=model_path, data=stan_data, iter=n_iter, chains=n_chains, cores=n_chains)
  return(fit)
}

refactor_posterior_mixture <- function(posterior_samples) {
  refactored_post <- posterior_samples %>%
                     rename_with(~ gsub("p_models_ind\\.(\\d+)\\.(\\d+)", "p_models_ind_\\2.\\1", .), 
                     starts_with("p_models_ind")) %>%
                     pivot_longer(cols = starts_with("p_models_ind"),
                                  names_to = c("model_num", "subj"),
                                  names_pattern = "p_models_ind_(\\d+)\\.(\\d+)",
                                  values_to = "value") %>%
                     pivot_wider(names_from = model_num, values_from = value, names_prefix = "p_models_ind_")
  
  #refactored_post$subj <- as.numeric(gsub("p_models_ind.", "", refactored_post$subj))
  refactored_post$subject_id <- names(var_maps$subject_id)[match(refactored_post$subj, var_maps$subject_id)]

  return(refactored_post)
}

```


# Compute posterior for kids
# Assume participants use one model
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_kid, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_children <- run_inference(stan_df, 10, 4, model_names)
summ <- data.frame(summary(fit_children))
#saveRDS(fit_children, file = "model_fits/infer_p_models_fit_kids.rds")
```
# Assume participants use mixture of models
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_kid, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_children_mixture <- run_inference_mixture(stan_df, 1000, 4, model_names)
summ <- data.frame(summary(fit_children_mixture))
saveRDS(fit_children_mixture, file = "model_fits/infer_p_models_fit_kids_mixture.rds")
```

# Analyze kids
# Non-mixture
```{r}
#fit_children <- readRDS("model_fits/infer_p_models_fit_kids.rds")
posterior_samples_lst <- rstan::extract(fit_children)
posterior_samples <- as.data.frame(posterior_samples_lst)
get_max_index <- function(slice) {
  apply(slice, 1, function(x) which.max(x))
}
model_posterior_probs <- posterior_samples_lst$posterior_probs
most_likely_strategies <- apply(model_posterior_probs, 1, get_max_index)
mean_model_posterior_probs <- apply(model_posterior_probs, c(2, 3), mean)
mls <- apply(mean_model_posterior_probs, 1, function(x) which.max(x))
print(table(mls))
post <- refactor_posterior(posterior_samples)
```
# Group posterior
```{r}
# ggplot(data=post) +
#   geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
#   scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
#   paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
#   scale_x_continuous(limits=c(0,1), breaks=scales::pretty_breaks(n = 2)) +
#   xlab("P(model)") +
#   ylab("N. posterior samples")
# ggsave("figs/infer_p_models_kids_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post %>%
        group_by(subj) %>% 
        mutate(mean_post_1 = mean(posterior_probs.1),
               mean_post_2 = mean(posterior_probs.2),
               mean_post_3 = mean(posterior_probs.3),
               mean_post_4 = mean(posterior_probs.4),
               mean_post_5 = mean(posterior_probs.5)) %>%
        mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df  <- plot_df [order(plot_df $top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)

ggsave("figs/infer_p_models_kids__wogroup.png", plot=last_plot(), width=15,height=6, dpi=500)
```
```{r}
ggplot(data=post) +
  geom_boxplot(aes(y=motor_sd, x=subject_id)) 
```

# Mixture
```{r}
#fit_children_mixture <- readRDS("model_fits/infer_p_models_fit_kids_mixture.rds")
posterior_samples_lst_mixture <- rstan::extract(fit_children_mixture)
posterior_samples_mixture <- as.data.frame(posterior_samples_lst_mixture)
post_mixture <- refactor_posterior_mixture(posterior_samples_mixture)
```
# Group posterior
```{r}
ggplot(data=post_mixture) +
  geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
  paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples")
ggsave("figs/infer_p_models_kids_mixture_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post_mixture %>%
           group_by(subj) %>% 
           mutate(mean_post_1 = mean(p_models_ind_1),
                 mean_post_2 = mean(p_models_ind_2),
                 mean_post_3 = mean(p_models_ind_3),
                 mean_post_4 = mean(p_models_ind_4),
                 mean_post_5 = mean(p_models_ind_5)) %>%
          mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df<- plot_df[order(plot_df$top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=p_models_ind_1, fill=model_names[1]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_2, fill=model_names[2]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_3, fill=model_names[3]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_4, fill=model_names[4]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_5, fill=model_names[5]), binwidth=0.1, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(0,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)
ggsave("figs/infer_p_models_kids_mixture.png", plot=last_plot(), width=15,height=6, dpi=500)
```


# Compute posterior for adults
# Assume participants use one model
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_adult, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_adults <- run_inference(stan_df, 1000, 4, model_names)
summ <- data.frame(summary(fit_adults))
saveRDS(fit_adults, file = "model_fits/infer_p_models_fit_adults.rds")
```

# Assume participants use mixture of models
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_adult, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_adults_mixture <- run_inference_mixture(stan_df, 1000, 4, model_names)
summ <- data.frame(summary(fit_adults_mixture))
saveRDS(fit_adults_mixture, file = "model_fits/infer_p_models_fit_adults_mixture.rds")
```

# Analyze adults
# Non-mixture
```{r}
#fit_adults <- readRDS("model_fits/infer_p_models_fit_adults.rds")
posterior_samples_lst <- rstan::extract(fit_adults)
posterior_samples <- as.data.frame(posterior_samples_lst)
get_max_index <- function(slice) {
  apply(slice, 1, function(x) which.max(x))
}
model_posterior_probs <- posterior_samples_lst$posterior_probs
most_likely_strategies <- apply(model_posterior_probs, 1, get_max_index)
mean_model_posterior_probs <- apply(model_posterior_probs, c(2, 3), mean)
mls <- apply(mean_model_posterior_probs, 1, function(x) which.max(x))
print(table(mls))
post <- refactor_posterior(posterior_samples)
```
# Group posterior
```{r}
# ggplot(data=post) +
#   geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
#   scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
#   paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
#   scale_x_continuous(limits=c(0,1), breaks=scales::pretty_breaks(n = 2)) +
#   xlab("P(model)") +
#   ylab("N. posterior samples")
# ggsave("figs/infer_p_models_adults_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post %>%
        group_by(subj) %>% 
        mutate(mean_post_1 = mean(posterior_probs.1),
               mean_post_2 = mean(posterior_probs.2),
               mean_post_3 = mean(posterior_probs.3),
               mean_post_4 = mean(posterior_probs.4),
               mean_post_5 = mean(posterior_probs.5)) %>%
        mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df  <- plot_df [order(plot_df $top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)

ggsave("figs/infer_p_models_adults_wogroup.png", plot=last_plot(), width=15,height=6, dpi=500)
```
```{r}
ggplot(data=post) +
  geom_boxplot(aes(y=motor_sd, x=subject_id)) 
```

# Mixture
```{r}
#fit_adults_mixture <- readRDS("model_fits/infer_p_models_fit_adults_mixture.rds")
posterior_samples_lst_mixture <- rstan::extract(fit_adults_mixture)
posterior_samples_mixture <- as.data.frame(posterior_samples_lst_mixture)
post_mixture <- refactor_posterior_mixture(posterior_samples_mixture)
```
# Group posterior
```{r}
ggplot(data=post_mixture) +
  geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
  paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples")
ggsave("figs/infer_p_models_adults_mixture_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post_mixture %>%
           group_by(subj) %>% 
           mutate(mean_post_1 = mean(p_models_ind_1),
                 mean_post_2 = mean(p_models_ind_2),
                 mean_post_3 = mean(p_models_ind_3),
                 mean_post_4 = mean(p_models_ind_4),
                 mean_post_5 = mean(p_models_ind_5)) %>%
          mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df<- plot_df[order(plot_df$top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=p_models_ind_1, fill=model_names[1]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_2, fill=model_names[2]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_3, fill=model_names[3]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_4, fill=model_names[4]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_5, fill=model_names[5]), binwidth=0.1, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(0,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)
ggsave("figs/infer_p_models_adults_mixture.png", plot=last_plot(), width=15,height=6, dpi=500)
```





# Compute posterior for monkeys
# Assume participants use one model
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_monkey, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_monkeys <- run_inference(stan_df, 1000, 4, model_names)
summ <- data.frame(summary(fit_monkeys))
saveRDS(fit_monkeys, file = "model_fits/infer_p_models_fit_monkeys.rds")
```

# Assume participants use mixture of models
```{r}
model_names <- c("gpnc", "gpsl", "lin", "lot", "ridge")
model_dfs <- list(df_gpnc, df_gpsl, df_lin, df_lot, df_ridge)
stan_df <- get_stan_df(df_monkeys, model_dfs, model_names)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_monkeys_mixture <- run_inference_mixture(stan_df, 1000, 4, model_names)
summ <- data.frame(summary(fit_monkeys_mixture))
saveRDS(fit_monkeys_mixture, file = "model_fits/infer_p_models_fit_monkeys_mixture.rds")
```

# Analyze adults
# Non-mixture
```{r}
#fit_adults <- readRDS("model_fits/infer_p_models_fit_monkeys.rds")
posterior_samples_lst <- rstan::extract(fit_monkeys)
posterior_samples <- as.data.frame(posterior_samples_lst)
get_max_index <- function(slice) {
  apply(slice, 1, function(x) which.max(x))
}
model_posterior_probs <- posterior_samples_lst$posterior_probs
most_likely_strategies <- apply(model_posterior_probs, 1, get_max_index)
mean_model_posterior_probs <- apply(model_posterior_probs, c(2, 3), mean)
mls <- apply(mean_model_posterior_probs, 1, function(x) which.max(x))
print(table(mls))
post <- refactor_posterior(posterior_samples)
```
# Group posterior
```{r}
# ggplot(data=post) +
#   geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
#   geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
#   scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
#   paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
#   scale_x_continuous(limits=c(0,1), breaks=scales::pretty_breaks(n = 2)) +
#   xlab("P(model)") +
#   ylab("N. posterior samples")
# ggsave("figs/infer_p_models_monkeys_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post %>%
        group_by(subj) %>% 
        mutate(mean_post_1 = mean(posterior_probs.1),
               mean_post_2 = mean(posterior_probs.2),
               mean_post_3 = mean(posterior_probs.3),
               mean_post_4 = mean(posterior_probs.4),
               mean_post_5 = mean(posterior_probs.5)) %>%
        mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df  <- plot_df [order(plot_df $top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)

ggsave("figs/infer_p_models_monkeys_wogroup.png", plot=last_plot(), width=15,height=6, dpi=500)
```
```{r}
ggplot(data=post) +
  geom_boxplot(aes(y=motor_sd, x=subject_id)) 
```

# Mixture
```{r}
#fit_adults_mixture <- readRDS("model_fits/infer_p_models_fit_monkeys_mixture.rds")
posterior_samples_lst_mixture <- rstan::extract(fit_adults_mixture)
posterior_samples_mixture <- as.data.frame(posterior_samples_lst_mixture)
post_mixture <- refactor_posterior_mixture(posterior_samples_mixture)
```
# Group posterior
```{r}
ggplot(data=post_mixture) +
  geom_histogram(aes(x=p_models_group.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  geom_histogram(aes(x=p_models_group.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSl", "lin"="Linear", "lot"="LoT", "ridge"="Ridge"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4")) +
  paper_theme + theme(strip.text=element_blank(), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(-0.01,1), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples")
ggsave("figs/infer_p_models_monkeys_mixture_group.png", plot=last_plot(), width=10,height=6, dpi=500)
```
# Individual posteriors
```{r}
plot_df <- post_mixture %>%
           group_by(subj) %>% 
           mutate(mean_post_1 = mean(p_models_ind_1),
                 mean_post_2 = mean(p_models_ind_2),
                 mean_post_3 = mean(p_models_ind_3),
                 mean_post_4 = mean(p_models_ind_4),
                 mean_post_5 = mean(p_models_ind_5)) %>%
          mutate(top = case_when(
                  mean_post_1 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 1,
                  mean_post_2 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 2,
                  mean_post_3 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 3,
                  mean_post_4 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 4,
                  mean_post_5 == pmax(mean_post_1, mean_post_2, mean_post_3, mean_post_4, mean_post_5) ~ 5
          ))
plot_df<- plot_df[order(plot_df$top), ]
plot_df$subject_id <- factor(plot_df$subject_id, levels = unique(plot_df$subject_id[order(plot_df$top)]))
ggplot(data=plot_df) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.1, fill=model_names[1]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.2, fill=model_names[2]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.3, fill=model_names[3]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.4, fill=model_names[4]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=(1-p_lapse)*posterior_probs.5, fill=model_names[5]), binwidth=0.03, alpha=0.5) +
  # geom_histogram(aes(x=p_lapse, fill="lapse"),  binwidth=0.03, alpha=0.5) +
  
  geom_histogram(aes(x=p_models_ind_1, fill=model_names[1]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_2, fill=model_names[2]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_3, fill=model_names[3]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_4, fill=model_names[4]), binwidth=0.1, alpha=0.5) +
  geom_histogram(aes(x=p_models_ind_5, fill=model_names[5]), binwidth=0.1, alpha=0.5) +
  scale_fill_manual(labels=c("gpnc" = "GP", "gpsl"="GPSL", "lin"="Linear", "lot"="LoT", "ridge"="Ridge", "lapse"="Lapse"), values=c("gpnc"="#EC913C", "gpsl"="#FC4DB4", "lin"="blue", "lot"="#15CF6A", "ridge"="#C790F4", "lapse"="gray")) +
  paper_theme + theme(strip.text=element_text(color="black", size=5), strip.background=element_blank(), legend.title=element_blank()) +
  scale_x_continuous(limits=c(0,1.01), breaks=scales::pretty_breaks(n = 2)) +
  xlab("P(model)") +
  ylab("N. posterior samples") +
  facet_wrap(~subject_id, ncol=10)
ggsave("figs/infer_p_models_monkeys_mixture.png", plot=last_plot(), width=15,height=6, dpi=500)
```
