---
title: "analysis"
output: html_document
date: "2024-01-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### load libraries
```{r}
library(ggplot2)
library(grid)
library(dplyr)
library(ggforce)
library(ggdist)
library(ggimage)
library(forcats)
library(stringr)
```
### helper functions
```{r}
paper_theme <- theme_light() + theme( axis.title.x = element_text(size=22),
                                      axis.text.x=element_text(
                                        size = 18), 
                                      axis.title.y = element_text(size = 22, vjust = 1),
                                      axis.text.y  = element_text(size = 18),
                             strip.text=element_text(size=16),
                                      axis.line.x = element_line(colour = "black"), 
                                      axis.line.y = element_line(colour = "black"),
                                      legend.title=element_text(size=20),
                                      legend.text=element_text(size=16),
                                      panel.grid.major=element_blank(),
                #   panel.background = element_rect(color = NA), 
                                      panel.grid.minor=element_blank())  

add_png_to_facet <- function(ggplot_object, data, facet_var, x_loc,y_loc, width, height, out_file) {
  # Get the ggplotGrob
  gtable <- ggplotGrob(ggplot_object)
  # Get the unique facet labels in the order they appear in the data
  facet_labels <- unique(data[[facet_var]])
  # Extract panel positions from the layout
  panel_positions <- subset(gtable$layout, grepl("panel", name))
  # Order the panels by their left (l) and top (t) positions
  ordered_panel_positions <- with(panel_positions, order(t, l))
  # Ensure the facet labels order matches the plot
  # For each ordered panel position, add the PNG
  for (i in seq_along(ordered_panel_positions)) {
    panel_index <- ordered_panel_positions[i]
    facet_label <- facet_labels[i]
    if (!is.na(facet_label)) {
      img <- readPNG(paste0("../figs/func_ims/", facet_label, ".png"))
      # Convert to raster and add it to the gtable
      g <- rasterGrob(img, interpolate = TRUE, width = unit(0.24, "npc"), height = unit(0.3, "npc"))
      g <- editGrob(g, vp = viewport(x = x_loc, y = y_loc, just = c("right", "top")))
      gtable <- gtable_add_grob(gtable, g, t = panel_positions$t[panel_index], l = panel_positions$l[panel_index])
    }
  }
  #png(filename = out_file, res = 400)
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(gtable)
  dev.off()
}

preprocess_df_human <- function(df) {
  df <- df[order(df$tpt),] %>%
      rename(x_curr = prev_x, y_curr = prev_y, x_next = true_x, y_next = true_y, x_pred = response_x, y_pred = response_y, func_id = seq_id) %>%
      group_by(subject_id, trial_idx, tpt) %>%
      mutate(true_dist=((x_next-x_curr)**2. + (y_next-y_curr)**2.)**0.5) %>%
      mutate(x_err=x_pred-x_next) %>%
      mutate(y_err=y_pred-y_next) %>%
      mutate(abs_err = ((x_err**2)+(y_err)**2) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(abs_rel_err_below_1 = abs_rel_err < 1) %>%
      mutate(dist_from_prev = (((x_pred-x_curr)**2)+((y_pred-y_curr)**2)) **0.5) %>%
      ungroup() %>%
      mutate(scaled_err = scale(abs_rel_err)[,1])
  return(df)
}

preprocess_df_monkey <- function(df) {
  df <- df[order(df$n),] %>%
      rename(tpt = n, subject_id = monkey_name) %>%
      group_by(subject_id, game_n, tpt) %>%
      mutate(true_dist=((x_next-x_curr)**2. + (y_next-y_curr)**2.)**0.5) %>%
      mutate(x_err=x_pred-x_next) %>%
      mutate(y_err=y_pred-y_next) %>%
      mutate(abs_err = ((x_err**2)+(y_err)**2) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(abs_rel_err_below_1 = abs_rel_err < 1) %>%
      mutate(dist_from_prev = (((x_pred-x_curr)**2)+((y_pred-y_curr)**2)) **0.5) %>%
      ungroup() %>%
      mutate(scaled_err = scale(abs_rel_err)[,1])
  return(df)
}
```
### load stimuli
```{r}
stimuli <- read.csv('data/stimuli.csv')
stimuli <- stimuli[order(stimuli$tpt),]
```

### load data
```{r, message=F}
df_kid <- read.csv("data/participants/kids.csv")
df_true <- df_kid[order(df_kid$tpt),] %>% rename(func_id = seq_id)
df_kid <- preprocess_df_human(df_kid)
df_adult <- preprocess_df_human(read.csv("data/participants/adults.csv"))
df_monkey <- preprocess_df_monkey(read.csv("data/participants/monkeys_1.csv"))
```

```{r}
(unique(df_kid$subject_id))
```
#Plot all sequences
```{r}
df <- df[order(df$tpt),]

# Mapping of existing names to new names
name_mapping <- c('plus'='plus sign', 'hourglass_1'='hourglass', 'zigzag_2'='zigzag 2', 'radial_1'='radial', 'spiral_outward'='spiral', 'square_spiral'='square spiral', 'stairs_2'='steps 2', 'hexagon'='hexagon', 'zigzag_1'='zigzag 1', 'sine'='sine', 'zigzag_widening'='widening zigzag','alternating_diff_1'='alternating 1', 'alternating_diff_2'='alternating 2', 'f_curly_2'='curlicue', 'stairs'='steps 1', '3_pts'='3 points', 'increasing_lines'='growing lines', 'square_2'='square', 'triangle_1'='triangle', 'zigzag_3'='zigzag 3', 'line'='line')

# Create a new column with mapped names
df <- df %>%
  mutate(pretty_seq_id = name_mapping[func.type])

p <- ggplot() +
  geom_path(data=df, aes(x=true_x, y=true_y), linetype="dashed") +
  geom_point(data=df, aes(x=true_x, y=true_y, color=tpt), size=4) +
  paper_theme + theme(panel.background = element_rect(fill = "white"), strip.background=element_blank(), strip.text = element_text(color="black", size=18)) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank()) +
  scale_color_continuous(low="blueviolet", high="orange",  name = "Tpt") +
  guides(alpha="none") +
  facet_wrap(~pretty_seq_id, scales="free", ncol=11)
p + theme(legend.position = c(1, 0), legend.justification = c(1.3, -0.1))
fname <- "figs/patterns.pdf"
ggsave(fname, plot = last_plot(), width = 21, height = 5, units = "in", bg="white")
print(knitr::include_graphics(fname))
```

#Plot all predictions together
```{r}
ggplot() +
  geom_point(data=df_adult, aes(x=x_curr, y=y_curr, alpha=tpt+1), size=1) +
  geom_path(data=df_adult, aes(x=x_curr, y=y_curr, alpha=tpt+1), linetype="solid") +
  geom_point(data=df_adult, aes(x=x_pred, y=y_pred), color = "cyan", size=.2, alpha=0.5) +
  geom_point(data=df_kid, aes(x=x_pred, y=y_pred), color = "pink", size=.2, alpha=0.8) +
  geom_point(data=df_monkey, aes(x=x_pred, y=y_pred), color = "gold", size=.2, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  guides(color="none", alpha="none") +
  facet_wrap(~func.type, scales="free")
```

```{r}
f <- "zigzag_widening"
ggplot() +
  geom_point(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), size=3) +
  geom_path(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), linetype="solid") +
  #geom_rect(data=df, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="blue", fill="white", alpha=0.5) +
  #geom_point(data=df_adult, aes(x=x_pred, y=y_pred), color = "cyan", size=.2, alpha=0.5) +
  #geom_point(data=df, aes(x=x_pred, y=y_pred), color = "pink", size=.2, alpha=0.8) +
  geom_point(data=df_monkey, aes(x=x_curr, y=y_curr), color = "green", size=.2, alpha=0.5) +
  geom_point(data=df_monkey, aes(x=x_pred, y=y_pred), color = "gold", size=.2, alpha=0.5) +
  #geom_rect(data=df_monkey, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="gold", fill=NA, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  guides(color="none", alpha="none") +
  facet_wrap(~func.type, scales="free")
```

```{r}
length(unique(df_kid$subject_id))
ggplot() +
  geom_point(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), size=1) +
  geom_path(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), linetype="solid") +
  geom_point(data=df_kid, aes(x=x_pred, y=y_pred, color=tpt), size=0.6, alpha=0.5) +
  #geom_point(data=mean_kid,aes(x=x_pred, y=y_pred, color=tpt),size=0.6) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  scale_color_gradient(low = "purple", high = "orange") +
  guides(color="none", alpha="none") +
  facet_wrap(~func_id, scales="free")
```


# DEMOGRAPHICS
```{r}
df <- df_kid %>% group_by(subject_id) %>% summarize(age=mean(age), n_sequences = n_distinct(func_id))
mean(df$age)
sd(df$age)
mean(df$n_sequences)
table(df$n_sequences)
sd(df$n_sequences)
```


### Adults, kids, monkeys
```{r, fig.width=5}
library(stringr)
funcs <- c("square_2", "triangle_1", "line", "zigzag_1", "spiral_outward", "increasing_lines")

df_monkey <- df_monkey %>% filter(str_detect(Current_time, "Feb"))

fm <- list(
  "square_2" = c(6, 1.5, 0.5), #range, shift_x, shift_y
  "triangle_1" = c(5, 1.5, 1.5),
  "line" = c(24, -4, 1),
  "zigzag_1" = c(11, 10, 4),
  "spiral_outward"= c(12, 5, 3),
  "increasing_lines" = c(13, 9, 2.5)
  # "square_2" = c(6, 1, 0), #range, shift_x, shift_y
  # "triangle_1" = c(4.5, 2.5, 1),
  # "line" = c(30, 5, 0),
  # "zigzag_1" = c(13, 11, 4),
  # "spiral_outward"= c(16, 8, 2.5),
  # "increasing_lines" = c(15, 5, 4)
)
square_range = 6
square_shift_x = 1
square_shift_y = 0

df <- df_kid %>%
      filter(func_id %in% funcs) %>%
      mutate(temp = fm[func_id]) %>%
      mutate(range = as.numeric(map_chr(temp, ~ .x[[1]]))) %>%
      mutate(shift_x = as.numeric(map_chr(temp, ~ .x[[2]]))) %>%
      mutate(shift_y = as.numeric(map_chr(temp, ~ .x[[3]]))) %>%
      mutate(x_pred = (x_pred+shift_x)/range) %>%
      mutate(y_pred = (y_pred+shift_y)/range)

df_true2 <- df_true %>%
          filter(func_id %in% funcs) %>%
          mutate(temp = fm[func_id]) %>%
          mutate(range = as.numeric(map_chr(temp, ~ .x[[1]]))) %>%
          mutate(shift_x = as.numeric(map_chr(temp, ~ .x[[2]]))) %>%
          mutate(shift_y = as.numeric(map_chr(temp, ~ .x[[3]]))) %>%
          mutate(true_x = (true_x+shift_x)/range) %>%
          mutate(true_y = (true_y+shift_y)/range)
  

ggplot() +
  geom_point(data=df%>%filter(func_id %in% funcs), aes(x=x_pred, y=y_pred, color=tpt), alpha=0.8, size=1.5) +
  geom_point(data=df_true2%>%filter(func_id %in% funcs), aes(x=true_x, y=true_y, alpha=tpt), size=1.3) +
  geom_path(data=df_true2%>%filter(func_id %in% funcs), aes(x=true_x, y=true_y, alpha=tpt), linetype="solid") +
  paper_theme + theme(panel.background = element_rect(fill = "white"), strip.background=element_blank(), strip.text = element_blank()) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks.x = element_blank(), axis.ticks.y = element_blank(),  axis.title.x = element_blank(), axis.title.y = element_blank()) +
  scale_color_continuous(low="blueviolet", high="orange",  name = "Tpt") +
  guides(alpha="none") +
  facet_wrap(~func_id, nrow=1) +
  scale_y_continuous(limits = c(0,0.7)) +
  scale_x_continuous(limits = c(0,1)) 

fname <- "figs/predictions_kid.png"
ggsave(fname, plot = last_plot(), width = 13, height = 2, units = "in", bg="white")
print(knitr::include_graphics(fname)) 
```

# Kids only
```{r, fig.width=5}
mean_kid <- df_kid %>% group_by(func_id, tpt) %>% summarize(x_pred = mean(x_pred, na.rm=T), y_pred = mean(y_pred, na.rm=T))
ggplot() +
  geom_point(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), size=1) +
  geom_path(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), linetype="solid") +
  #geom_point(data=df_kid, aes(x=x_pred, y=y_pred, color=tpt), size=0.6, alpha=0.5) +
  geom_point(data=mean_kid,aes(x=x_pred, y=y_pred, color=tpt),size=0.6) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  scale_color_gradient(low = "purple", high = "orange") +
  guides(color="none", alpha="none") +
  facet_wrap(~func_id, scales="free")
ggsave("figs/mean_kid.png", plot = last_plot(), width = 10, height = 8, units = "in", bg="white")
```
# Adults only
```{r, fig.width=5}
ggplot() +
  geom_point(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), size=1) +
  geom_path(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), linetype="solid") +
  geom_point(data=df_adult, aes(x=x_pred, y=y_pred, color=tpt), size=0.6, shape=3, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  scale_color_gradient(low = "purple", high = "orange") +
  guides(color="none", alpha="none") +
  facet_wrap(~func_id, scales="free")
```

### Monkeys only
```{r, fig.width=5}
ggplot() +
  geom_path(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), linetype="solid") +
  geom_point(data=df_true, aes(x=true_x, y=true_y, alpha=tpt+1), size=1) +
  geom_point(data=df_monkey, aes(x=x_pred, y=y_pred, color=tpt), size=0.6, alpha=0.7) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  scale_color_gradient(low = "purple", high = "orange") +
  guides(color="none", alpha="none") +
  facet_wrap(~func_id, scales="free")
```

```{r}
kid_corr <- df_kid %>% group_by(func_id, subject_id) %>% summarize(correct = mean(correct, na.rm=T)) %>% group_by(func_id) %>% summarize(mean_correct = mean(correct, na.rm=T), sd_correct = sd(correct, na.rm=T))
print(mean(kid_corr$sd_correct))
#kid_corr <- kid_corr[order(kid_corr$sd_correct)]
```

# Accuracy by function
```{r}
df_monkey_new <- df_monkey
unique(df_kid$func_id)
kid_corr <- df_kid %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T)) %>% mutate(agent="Children")
mean(kid_corr$correct, na.rm=T)
mean((kid_corr %>% filter(tpt>11))$correct, na.rm=T)
unique(df_adult$func_id)
adult_corr <- df_adult %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Adults")
mean(adult_corr$correct, na.rm=T)
mean((adult_corr %>% filter(tpt>11))$correct, na.rm=T)
unique(df_monkey$func_id)
monkey_corr <- df_monkey %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Monkeys")

bp22_corr <- df_monkey_new %>% filter(subject_id=="BP22") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Monkey 1")
bp24_corr <- df_monkey_new %>% filter(subject_id=="BP24") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Monkey 2")
mean(monkey_corr$correct, na.rm=T)
mean((monkey_corr %>% filter(tpt>13))$correct, na.rm=T)

#plot_df <- merge(merge(kid_corr, adult_corr), monkey_corr) %>% group_by(func_id) %>% mutate(mean_kid_correct = mean(kid_correct, na.rm=T))
plot_df <- rbind(kid_corr, adult_corr, bp22_corr, bp24_corr) %>% group_by(func_id, subject_id, agent) %>% summarize(correct = mean(correct, na.rm=T))

order_df <- kid_corr %>% group_by(func_id) %>% summarize(mean_kid_correct = mean(correct, na.rm=T))

plot_df <- merge(plot_df, order_df, by="func_id")

add_png_to_plot <- function(ggplot_object, data, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.85, xmax = i+.85, ymin = y_loc-0.28, ymax = y_loc)
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}

p <- ggplot(plot_df, aes(x = fct_rev(reorder(func_id, mean_kid_correct)))) +
  stat_summary(aes(y=correct, color=agent, fill=agent), fun = "mean", na.rm = TRUE, geom = "point", size=2,  position = position_dodge(width = .8), shape=8, stroke=1) +
  geom_point(aes(y=correct, color=agent, fill=agent, group=agent), size=1, alpha=0.7, position = position_dodge(width = .8)) +
  scale_color_manual(values = c("orchid", "#106430", "cornflowerblue", "darkblue")) +
  scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  coord_cartesian(clip = 'off') +
  paper_theme + theme(legend.title=element_blank(), legend.position="top", plot.margin = unit(c(0, 0, 15, 0), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="P(correct)")

fname <- "figs/accuracy_monkeys_comp.png"
add_png_to_plot(p, plot_df, -0.05,440,100, fname)
print(knitr::include_graphics(fname))
```

# just monkey accuracy
```{r}
#df_monkey_old <- df_monkey %>% filter(!str_detect(Current_time, "Apr|May"))
df_monkey_new <- df_monkey 
unique(df_kid$func_id)
kid_corr <- df_kid %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T)) %>% mutate(agent="Children")
mean(kid_corr$correct, na.rm=T)
mean((kid_corr %>% filter(tpt>11))$correct, na.rm=T)
unique(df_adult$func_id)
adult_corr <- df_adult %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Adults")
mean(adult_corr$correct, na.rm=T)
mean((adult_corr %>% filter(tpt>11))$correct, na.rm=T)
unique(df_monkey$func_id)
monkey_corr <- df_monkey %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Monkeys")

bp22_new_corr <- df_monkey_new %>% filter(subject_id=="BP22") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="New monkey 1")
bp24_new_corr <- df_monkey_new %>% filter(subject_id=="BP24") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="New monkey 2")

#bp22_old_corr <- df_monkey_old %>% filter(subject_id=="BP22") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Old monkey 1")
#bp24_old_corr <- df_monkey_old %>% filter(subject_id=="BP24") %>% select(-subject_id) %>% rename(subject_id = r_id) %>% mutate(subject_id = as.character(subject_id)) %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Old monkey 2")

mean(monkey_corr$correct, na.rm=T)
mean((monkey_corr %>% filter(tpt>13))$correct, na.rm=T)

#plot_df <- merge(merge(kid_corr, adult_corr), monkey_corr) %>% group_by(func_id) %>% mutate(mean_kid_correct = mean(kid_correct, na.rm=T))
plot_df <- rbind(bp22_new_corr, bp22_old_corr, bp24_new_corr, bp24_old_corr) %>% group_by(func_id, subject_id, agent) %>% summarize(correct = mean(correct, na.rm=T))

order_df <- bp22_new_corr %>% group_by(func_id) %>% summarize(mean_kid_correct = mean(correct, na.rm=T))

plot_df <- merge(plot_df, order_df, by="func_id")

add_png_to_plot <- function(ggplot_object, data, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("../figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.85, xmax = i+.85, ymin = y_loc-0.28, ymax = y_loc)
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}

p <- ggplot(plot_df, aes(x = fct_rev(reorder(func_id, mean_kid_correct)))) +
  stat_summary(aes(y=correct, color=agent, fill=agent), fun = "mean", na.rm = TRUE, geom = "point", size=2,  position = position_dodge(width = .8), shape=8, stroke=1) +
  geom_point(aes(y=correct, color=agent, fill=agent, group=agent), size=1, alpha=0.7, position = position_dodge(width = .8)) +
  scale_color_manual(values = c("#EE7EC5", "#9C0766", "cornflowerblue", "darkblue")) +
  scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  coord_cartesian(clip = 'off') +
  paper_theme + theme(legend.title=element_blank(), legend.position="top", plot.margin = unit(c(0, 0, 15, 0), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="P(correct)")

fname <- "figs/revisions/accuracy_monkeys_comp.png"
add_png_to_plot(p, plot_df, -0.05,440,100, fname)
print(knitr::include_graphics(fname))
```


```{r}
bp22_corr <- df_monkey %>% filter(subject_id=="BP22") %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="BP22")
bp24_corr <- df_monkey %>% filter(subject_id=="BP24") %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="BP24")
plot_df <- rbind(kid_corr, adult_corr, bp22_corr, bp24_corr) %>% group_by(func_id, subject_id, tpt, agent) %>% summarize(correct = mean(correct, na.rm=T))
ggplot(plot_df, aes(x = tpt, y = correct)) +
  stat_summary(aes(color=agent, fill=agent), fun = "mean", na.rm = TRUE, geom = "line", size=0.7,  position = position_dodge(width = .7)) +
  #geom_point(aes(y=correct, color=agent, fill=agent, group=agent), size=1, alpha=0.7, position = position_dodge(width = .7)) +
  scale_color_manual(values = c("orchid", "#106430", "cornflowerblue", "blue")) +
  #scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  #coord_cartesian(clip = 'off') +sition="top", plot.margin = unit(c(0, 0, 15, 0), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  facet_wrap(~func_id) +
  labs(x="", y="P(correct)")

```

# correlation between monkeys
```{r}
monkey_corr <- df_monkey %>% mutate(tpt=tpt+1) %>% group_by(func_id, subject_id, tpt) %>% summarize(correct = mean(correct, na.rm=T))  %>% mutate(agent="Monkeys")
df <- monkey_corr %>%
      pivot_wider(names_from = subject_id, values_from = correct, names_prefix = "correct_") %>%
      group_by(func_id) %>%
      summarize(correct_BP22 = mean(correct_BP22, na.rm=T), correct_BP24 = mean(correct_BP24, na.rm=T))
beta(lm(data=df, correct_BP22 ~ correct_BP24))

for (seq in unique(df_monkey$func_id)) {
  temp <- df_monkey %>%
          filter(func_id == seq) %>%
          mutate(tpt=tpt+1) %>%
          group_by(subject_id, tpt) %>%
          summarize(correct = mean(correct, na.rm=T)) %>%
          ungroup() %>%
          pivot_wider(names_from = subject_id, values_from = correct, names_prefix = "correct_") %>%
          group_by(tpt) %>% filter(tpt>2) %>% filter(tpt<15) %>%
          summarize(correct_BP22 = mean(correct_BP22, na.rm=T), correct_BP24 = mean(correct_BP24, na.rm=T))
  print(seq)
  print(t.test(temp$correct_BP22, temp$correct_BP24, paired=T))
  break
}

```

# Some correlation analyses: effect of age on children
```{r}
df <- df_kid %>%
      group_by(func_id, subject_id, tpt) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T))
  
beta(lm(data=df, correct ~ age))
```
```{r}
df <- df_kid %>%
      group_by(func_id, subject_id, tpt) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T))
#also group by tpt?
df <- df %>%
      group_by(func_id, subject_id) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T)) %>%
      group_by(subject_id) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T))

#beta(lm(data=df, correct ~ age))
#df$func_id.factor <- factor(df$func_id)
#beta(lm(correct ~ func_id.factor + age, data=df))
beta(lm(data=df, correct ~ age))
ggplot(data=df, aes(x=age, y=correct)) +
  geom_point(aes(color=subject_id)) +
  stat_smooth(method="lm",se=TRUE,alpha=0.1) +
  stat_smooth(method="lm",se=FALSE)

```

# effect of trial num
```{r}
df <- df_kid %>%
      group_by(trial_idx, func_id, subject_id, tpt) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T))
#also group by tpt?
df2 <- df %>%
      group_by(trial_idx, func_id, subject_id) %>%
      summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T)) %>%
      filter(!is.na(correct))
      #group_by(subject_id) %>%
      #summarize(correct = mean(correct, na.rm=T), age = mean(age, na.rm=T))

#beta(lm(data=df, correct ~ age))
#df$func_id.factor <- factor(df$func_id)
#beta(lm(correct ~ func_id.factor + age, data=df))
beta(lm(data=df2, correct ~ trial_idx))
ggplot(data=df2, aes(x=trial_idx, y=correct)) +
  geom_line(aes(group=subject_id, color=subject_id), alpha=0.5) +
  stat_smooth(method="lm",se=TRUE,alpha=0.1) +
  stat_smooth(method="lm",se=FALSE) +
  geom_point(aes(group=subject_id), alpha=0.5)

df2$func_id.factor <- factor(df2$func_id)
beta(lm(correct ~ func_id.factor + trial_idx, data=df2))
```




# How far off are kids in terms of angle, vs in terms of distance?
# or, are they getting it along the line?
```{r}

df_kid <- df_kid %>% mutate(vec_x = x_pred-x_curr, vec_y = y_pred-y_curr, true_vec_y = y_next-y_curr, true_vec_x = x_next-x_curr) %>% mutate(dist_err = abs((((vec_x**2 + vec_y**2)**0.5) - ((true_vec_x**2 + true_vec_y**2)**0.5))), angle_err = (atan2(vec_y, vec_x) - atan2(true_vec_y, true_vec_x))) %>% mutate(angle_err = abs((angle_err + pi) %% (2*pi) - pi))
                                                                                                                                             
df_adult <- df_adult %>% mutate(vec_x = x_pred-x_curr, vec_y = y_pred-y_curr, true_vec_y = y_next-y_curr, true_vec_x = x_next-x_curr) %>% mutate(dist_err = abs((((vec_x**2 + vec_y**2)**0.5) - ((true_vec_x**2 + true_vec_y**2)**0.5))), angle_err = (atan2(vec_y, vec_x) - atan2(true_vec_y, true_vec_x))) %>% mutate(angle_err = abs((angle_err + pi) %% (2*pi) - pi))

df_monkey <- df_monkey %>% mutate(vec_x = x_pred-x_curr, vec_y = y_pred-y_curr, true_vec_y = y_next-y_curr, true_vec_x = x_next-x_curr) %>% mutate(dist_err = abs((((vec_x**2 + vec_y**2)**0.5) - ((true_vec_x**2 + true_vec_y**2)**0.5))), angle_err = (atan2(vec_y, vec_x) - atan2(true_vec_y, true_vec_x))) %>% mutate(angle_err = abs((angle_err + pi) %% (2*pi) - pi))

#df_monkey <- df_monkey %>% mutate(vec_x = x_pred-x_curr, vec_y = y_pred-y_curr, true_vec_y = y_next-y_curr, true_vec_x = x_next-x_curr)
```
```{r}
ggplot() +
  #geom_line(data=df_kid, aes(x=tpt, y=angle_err, color=subject_id), alpha=0.4) +
  stat_summary(data=df_kid, geom="line", aes(x=tpt, y=angle_err), color="magenta", fun="mean") + 
  stat_summary(data=df_adult, geom="line", aes(x=tpt, y=angle_err), color="blue", fun="mean") + 
  #stat_summary(data=df_monkey, geom="line", aes(x=tpt, y=angle_err), color="orange", fun="mean") + 
  facet_wrap(~func_id)
```
```{r}
ggplot() +
  #geom_line(data=df_kid, aes(x=tpt, y=angle_err, color=subject_id), alpha=0.4) +
  stat_summary(data=df_kid, geom="line", aes(x=tpt, y=dist_err), color="magenta", fun="mean") + 
  stat_summary(data=df_adult, geom="line", aes(x=tpt, y=dist_err), color="blue", fun="mean") + 
  #stat_summary(data=df_monkey, geom="line", aes(x=tpt, y=dist_err), color="orange", fun="mean") + 
  facet_wrap(~func_id, scales="free")
```
```{r}
df <- rbind(df_kid%>%select(angle_err,dist_err,tpt,func_id)%>%mutate(agent="Children"), df_adult%>%select(angle_err,dist_err,tpt,func_id)%>%mutate(agent="Adults"), df_monkey%>%select(angle_err,dist_err,tpt,func_id)%>%mutate(agent="Monkeys")) %>% group_by(func_id, agent)
df <- df %>% summarize(angle_err = mean(angle_err, na.rm=T), dist_err = mean(dist_err, na.rm=T))

ggplot() +
  #geom_line(data=df_kid, aes(x=tpt, y=angle_err, color=subject_id), alpha=0.4) +
  stat_summary(data=df%>%filter(agent!="Monkeys"), geom="point", aes(x=func_id, y=angle_err, color=agent), fun="mean")
  #stat_summary(data=df_adult, geom="line", aes(x=func_id, y=dist_err), color="blue", fun="mean") + 
  #stat_summary(data=df_monkey, geom="line", aes(x=tpt, y=angle_err), color="orange", fun="mean") 
```
```{r}
ggplot() +
  #geom_line(data=df_kid, aes(x=tpt, y=angle_err, color=subject_id), alpha=0.4) +
  stat_summary(data=df%>%filter(agent!="Monkeys"), geom="point", aes(x=func_id, y=dist_err, color=agent), fun="mean")
```

#Correlations between groups
```{r}
df <- plot_df %>%
      group_by(func_id, agent) %>%
      summarize(correct = mean(correct, na.rm=T)) %>%
      pivot_wider(names_from = agent, values_from = correct, names_prefix = "correct_") %>%
      group_by(func_id) %>%
      summarize(correct_Monkeys = mean(correct_Monkeys, na.rm=T), correct_Adults = mean(correct_Adults, na.rm=T), correct_Children = mean(correct_Children, na.rm=T))
beta(lm(data=df, correct_Children~ correct_Monkeys))
beta(lm(data=df, correct_Children~ correct_Adults))
#t.test(df$correct_BP22, df$correct_BP24, paired=T)
```

# Scatter monkeys and kids w images
```{r, message=FALSE}
#remove large outliers: >3sd in 
df_kid_outlier <- df_kid %>% filter(scaled_err > 3, na.rm=TRUE)
df_monkey_outlier <- df_monkey %>% filter(scaled_err > 3, na.rm=TRUE)
df_adult_outlier <- df_adult %>% filter(scaled_err > 3, na.rm=TRUE)

df_kid2 <- df_kid %>% filter(scaled_err < 3, na.rm=TRUE)
df_monkey2 <- df_monkey %>% filter(scaled_err < 3, na.rm=TRUE)
df_adult2 <- df_adult %>% filter(scaled_err < 3, na.rm=TRUE)
```

```{r, message=FALSE}
#want a df with mean err for monkeys, kids, adults 
kid_agg <- df_kid2 %>% group_by(func_id) %>% summarize(mean_err_kid = mean(abs_rel_err, na.rm=TRUE), mean_accuracy_kid = mean(correct, na.rm = TRUE), mean_err_bel_1_kid = mean(abs_rel_err_below_1, na.rm=TRUE))
monkey_agg <- df_monkey2 %>% group_by(func_id) %>% summarize(mean_err_monkey = mean(abs_rel_err, na.rm=TRUE), mean_accuracy_monkey = mean(correct, na.rm = TRUE), mean_err_bel_1_monkey = mean(abs_rel_err_below_1, na.rm=TRUE))
adult_agg <- df_adult2 %>% group_by(func_id) %>% summarize(mean_err_adult = mean(abs_rel_err, na.rm=TRUE), mean_accuracy_adult = mean(correct, na.rm = TRUE), mean_err_bel_1_adult = mean(abs_rel_err_below_1, na.rm=TRUE))
agg <- merge(kid_agg, monkey_agg, by="func_id")
agg <- merge(agg, adult_agg, by="func_id")
agg <- agg %>%
      mutate(image_path = sprintf("figs/func_ims/%s.png", func_id))
```

### Mean error by func by group
```{r}
cor(agg$mean_err_kid, agg$mean_err_adult)
cor(agg$mean_err_kid, agg$mean_err_monkey)
cor(agg$mean_err_adult, agg$mean_err_monkey)
```
```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_err_kid, y=mean_err_adult, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1.8),ylim=c(0,1.8)) + ggtitle("Mean error, kids vs adults") +
  paper_theme +
  labs(x="Relative error (Children)", y="Relative error (Adults)")
#ggsave("figs/adult-kid_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```

```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_err_kid, y=mean_err_monkey, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,2.9),ylim=c(0,2.9)) + ggtitle("Mean error, kids vs monkeys") +
  paper_theme +
  labs(x="Relative error (Children)", y="Relative error (Monkeys)")
#ggsave("figs/monkey-kid_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```
```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_err_monkey, y=mean_err_adult, image = image_path), size=0.07) +
  ggtitle("Mean error, kids vs monkeys") +
  coord_fixed(xlim=c(0,2.9),ylim=c(0,2.9)) +
  paper_theme +
  labs(x="Relative error (Monkeys)", y="Relative error (Adults)")
#ggsave("figs/monkey-kid_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```
###Accuracy
```{r}
cor(agg$mean_accuracy_kid, agg$mean_accuracy_adult)
cor(agg$mean_accuracy_kid, agg$mean_accuracy_monkey)
cor(agg$mean_accuracy_adult, agg$mean_accuracy_monkey)
```

```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_accuracy_kid, y=mean_accuracy_adult, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1)) + ggtitle("Mean accuracy, kids vs adults") +
  paper_theme +
  labs(x="P(correct) (Children)", y="P(correct) (Adults)")
#ggsave("figs/adult-kid_accuracy_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```

```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_accuracy_kid, y=mean_accuracy_monkey, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1)) + ggtitle("Mean accuracy, kids vs monkeys") +
  paper_theme +
  labs(x="P(correct) (Children)", y="P(correct) (Monkeys)")
#ggsave("figs/monkey-kid_accuracy_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```


# differences in average err between kids and monkeys
```{r}
add_png_to_plot <- function(ggplot_object, data, x_loc, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.9, xmax = i+.9, ymin = -2.3, ymax = -1.9)
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}
plot_df <- agg %>% mutate("mean_err_kid_monkey_dif" = mean_err_kid - mean_err_monkey)
p <- ggplot(plot_df, aes(x = reorder(func_id, mean_err_kid_monkey_dif), y = mean_err_kid_monkey_dif)) +
  geom_point(fill="orange2", color="orange2", shape=22, size=3) +
  #scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  coord_cartesian(clip = 'off') +
  #coord_cartesian(ylim = c(0, 1), clip = 'off') +
  #theme(legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size=12))+
  paper_theme + theme(legend.title=element_blank(), plot.margin = unit(c(15, 15, 15, 15), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="Rel. error (Children) -\nRel. error (Monkeys)")

fname <- "figs/rel_err_km_dif.png"
add_png_to_plot(p, plot_df, 1.3,1.3,340,100, fname)
print(knitr::include_graphics(fname))
```


```{r}
add_png_to_plot <- function(ggplot_object, data, x_loc, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.9, xmax = i+.9, ymin = -0.75, ymax = -0.9)
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}

agg <- agg %>% mutate("mean_err_adult_kid_dif" = mean_err_adult - mean_err_kid) %>% 
               mutate("mean_accuracy_adult_kid_dif" = mean_accuracy_adult - mean_accuracy_kid)
cor(agg$mean_err_adult_kid_dif, agg$mean_accuracy_adult_kid_dif)
cor(agg$mean_err_adult, agg$mean_accuracy_adult)
cor(agg$mean_err_kid, agg$mean_accuracy_kid)
cor(agg$mean_err_monkey, agg$mean_accuracy_monkey)
#ggplot() +
#  geom_abline(slope = -1, intercept = 1, color = "gray", linetype = "dashed") +
#  geom_image(data=agg, aes(x=scale(mean_err_kid), y=scale(mean_accuracy_kid), image = image_path), size=0.07) +
#  stat_smooth(data=agg,aes(x=scale(mean_err_kid), y=scale(mean_accuracy_kid)), method=lm) +
  #coord_cartesian(xlim=c(0,1),ylim=c(0,1)) + ggtitle("Mean err vs accuracy") +
#  paper_theme +
#  labs(x="err", y="acc")
plot_df <- agg
#lets add accuracy to this
p <- ggplot(plot_df) +
  geom_point(fill="orange2", color="orange2", aes(x = reorder(func_id, mean_err_adult_kid_dif), y = mean_err_adult_kid_dif), shape=22, size=3) +
  #geom_point(fill="cornflowerblue", color="cornflowerblue", aes(x = reorder(func_id, mean_err_adult_kid_dif), y = mean_accuracy_adult_kid_dif), shape=22, size=3) +
  coord_cartesian(clip = 'off') +
  paper_theme + theme(legend.title=element_blank(), plot.margin = unit(c(15, 15, 15, 15), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="Rel. error (Adults) -\nRel. error (Children)")
fname <- "figs/rel_err_ak_dif.png"
add_png_to_plot(p, plot_df, 1.3,1.3,340,100, fname)
print(knitr::include_graphics(fname))
```


###P rel err < 1
```{r}
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_err_bel_1_kid, y=mean_err_bel_1_adult, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1))
  paper_theme +
  labs(x="P(relative error < 1) (Children)", y="P(relative error < 1) (Adults)")
ggsave("figs/adult-kid_eb1_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=agg, aes(x=mean_err_bel_1_kid, y=mean_err_bel_1_monkey, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1)) +
  paper_theme +
  labs(x="P(relative error < 1) (Children)", y="P(relative error < 1) (Monkeys)")
#ggsave("../figs/monkey-kid_eb1_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```

```{r}
#long df
kid_drop <- df_kid2 %>% mutate(agent = "Children") %>% select(abs_rel_err, abs_rel_err_below_1, correct, tpt, func_id, subject_id, agent)
monkey_drop <- df_monkey2 %>% mutate(agent = "Monkeys") %>% select(abs_rel_err, abs_rel_err_below_1, correct, tpt, func_id, subject_id, agent)
adult_drop <- df_adult2 %>% mutate(agent = "Adults") %>% select(abs_rel_err, abs_rel_err_below_1, correct, tpt, func_id, subject_id, agent)
agg_long <- rbind(kid_drop, monkey_drop, adult_drop)
agg_long <- agg_long %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_id))
```

#rel err over time
```{r, fig.show='hold'}
plot_df <- agg_long %>% filter(func_id != "line")
fname <- "figs/rel_err_all.png"

plot_df$func.type <- factor(plot_df$func_id, levels=unique(plot_df$func_id))
p.1 <- ggplot(plot_df, aes(x = tpt, y = abs_rel_err, color=agent)) +
      #geom_line(aes(group=subject_id), alpha=0.2) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=1) +
      stat_summary(fun.data="mean_se", na.rm = TRUE, geom="errorbar", width=0.1) +
      coord_cartesian(xlim=c(1,15)) +
      scale_color_manual(values = c("orchid", "gold", "cornflowerblue")) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func.type, ncol=7) +
      paper_theme + theme(legend.text=element_text(size=22), axis.title.x=element_text(size=26), axis.title.y=element_text(size=26), legend.title=element_blank(), strip.background=element_rect(fill="white", color="white"), strip.text=element_blank()) +
      labs(x="Timepoint", y="Relative error")
add_png_to_facet(p.1, plot_df, "func_id",  1.35,1.3,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```
```{r, fig.show='hold'}
plot_df <- agg_long %>% filter(func_id != "line") %>% filter(agent != "Monkeys")
fname <- "figs/rel_err_all.png"

plot_df$func.type <- factor(plot_df$func_id, levels=unique(plot_df$func_id))
p.1 <- ggplot(plot_df, aes(x = tpt, y = abs_rel_err, color=agent)) +
      #stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=1) +
      geom_line(aes(group=subject_id), alpha=0.5) +
      #stat_summary(fun.data="mean_se", na.rm = TRUE, geom="errorbar", width=0.1) +
      coord_cartesian(xlim=c(1,15)) +
      scale_color_manual(values = c("orchid", "gold", "cornflowerblue")) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func.type, ncol=7) +
      paper_theme + theme(legend.text=element_text(size=22), axis.title.x=element_text(size=26), axis.title.y=element_text(size=26), legend.title=element_blank(), strip.background=element_rect(fill="white", color="white"), strip.text=element_blank()) +
      labs(x="Timepoint", y="Relative error")
add_png_to_facet(p.1, plot_df, "func_id",  1.35,1.3,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```

### Accuracy over time
```{r}
plot_df <- agg_long
fname <- "figs/accuracy_all.png"

plot_df$func.type <- factor(plot_df$func_id, levels=unique(plot_df$func_id))
p.1 <- ggplot(plot_df, aes(x = tpt, y = correct, group=agent, color=agent)) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=1) +
      stat_summary(fun.data="mean_se", na.rm = TRUE, geom="errorbar", width=0.1) +
      coord_cartesian(xlim=c(1,15)) +
      scale_color_manual(values = c("orchid", "gold", "cornflowerblue")) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func.type, ncol=7) +
      paper_theme + theme(legend.text=element_text(size=22), axis.title.x=element_text(size=26), axis.title.y=element_text(size=26), legend.title=element_blank(), strip.background=element_rect(fill="white", color="white"), strip.text=element_blank()) +
      labs(x="Timepoint", y="P(correct)")
add_png_to_facet(p.1, plot_df, "func_id",  1.35,0.69,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```