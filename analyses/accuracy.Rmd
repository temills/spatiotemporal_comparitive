---
title: "model comparison"
output: html_document
---

```{r, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=4, fig.height=3,fig.align = "center",cache=TRUE)
library(ggplot2)
library(reshape)
library(grid)
library(dplyr)
library(gridExtra)
library(lme4)
library(reghelper)
library(RColorBrewer)
library(robustbase)
library(tidylog)
library(brms)
library(tidyr)
library(hash)
library(rstan)
library(png)
library(gtable)
library(ggimage)
library(hash)
library(purrr)
library(stringr)
library(ggforce)

paper_theme <- theme_light() + theme(
  axis.text.x=element_text(colour="#292929",
                           size = 14), 
axis.title.x = element_text(size=18, family="Georgia"),
  axis.title.y = element_text(size = 18, vjust = 1,  family="Georgia"),
  axis.text.y  = element_text(size = 14, colour="#292929", family="Georgia"),
  strip.text=element_text(size=16,color="black", family="Georgia"),
strip.background = element_rect(colour = "grey50", fill = "white"),
panel.background = element_rect(fill = "white", colour = "grey50"),
  axis.ticks.x=element_blank(),axis.ticks.y=element_blank(),
  axis.line.x = element_line(colour = "black"), 
  axis.line.y = element_line(colour = "black"),
  legend.title=element_text(size=18, family="Georgia"),
  legend.text=element_text(size=15, family="Georgia"),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank())


get_ll <- function(df) {
  logsumexp <- function(x) {
    max_x <- max(x)
    max_x + log(sum(exp(x - max_x)))
  }
  df <- df %>%
    group_by(tpt, seq_id) %>%
    mutate(norm = logsumexp(score)) %>%
    ungroup() %>%
    mutate(posterior = exp(score - norm)) 
  return(df)
}

preprocess_df_human <- function(df) {
  sm <- 1e-10
  df$id <- seq_len(nrow(df))
  df$n <- df$tpt
  df <- df[order(df$tpt),] %>%
      rename(pred_x = response_x, pred_y = response_y, func.name = seq_id, subj_id = subject_id) %>%
      group_by(subj_id, trial_idx, tpt) %>%
      mutate(r_id = subj_id) %>%
      mutate(true_dist=((true_x-prev_x)**2. + (true_y-prev_y)**2.)**0.5) %>%
      mutate(err_x=pred_x-true_x) %>%
      mutate(err_y=pred_y-true_y) %>%
      mutate(norm_err_x = err_x/(true_dist+sm)) %>%
      mutate(norm_err_y = err_y/(true_dist+sm)) %>%
      mutate(abs_err = ((err_x**2)+(err_y**2)) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(dist_from_prev = (((pred_x-true_x)**2)+((pred_y-true_y)**2)) **0.5) %>%
      ungroup() %>%
      mutate(scaled_err = scale(abs_rel_err)[,1])
  return(df)
}


preprocess_df_monkey <- function(df) {
  df$id <- seq_len(nrow(df))
  df <- df[order(df$n),] %>%
      rename(true_x=x_next, true_y=y_next, prev_x=x_curr, prev_y=y_curr, pred_x=x_pred, subj_id = monkey_name, pred_y=y_pred, func.name=func_id) %>%
      rename(tpt = n) %>%
      mutate(func.name=ifelse(func.name=="example_line", "line", func.name)) %>%
      group_by(r_id, game_n, tpt) %>%
      mutate(true_dist=((true_x-prev_x)**2. + (true_y-prev_y)**2.)**0.5) %>%
      mutate(err_x=pred_x-true_x) %>%
      mutate(err_y=pred_y-true_y) %>%
      mutate(abs_err = ((err_x**2)+(err_y**2)) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(dist_from_prev = (((pred_x-true_x)**2)+((pred_y-true_y)**2)) **0.5) %>%
      ungroup() %>%
      mutate(n=tpt) %>%
      mutate(r_id = as.character(r_id))
  return(df)
}

```


# Plot all stimuli
```{r}
df_stim <- read.csv("data/models/lot.csv") %>%
           distinct(tpt, true_x, true_y, seq_id)
lims <- df_stim %>%
  group_by(seq_id) %>%
  summarize(xmin = min(true_x),
            xmax = max(true_x),
            ymin = min(true_y),
            ymax = max(true_y),
            .groups = "drop") %>%
  rowwise() %>%
  mutate(xrange = xmax - xmin,
        yrange = ymax - ymin,
        maxrange = max(xrange, yrange),
        xmid = (xmin + xmax)/2,
        ymid = (ymin + ymax)/2,
        xmin = xmid - maxrange/2,
        xmax = xmid + maxrange/2,
        ymin = ymid - maxrange/2,
        ymax = ymid + maxrange/2)

plot_func <- function(f, lw) {
  lim <- lims %>% filter(seq_id == f)
  ggplot(df_stim %>% filter(seq_id == f)) +
    geom_path(aes(x = true_x, y = true_y), linetype = "dotted") +
    geom_point(aes(x = true_x, y = true_y, alpha = tpt)) +
    paper_theme +
    theme(axis.text.x  = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y  = element_blank(),
          axis.line.x  = element_blank(), 
          axis.line.y  = element_blank(), 
          panel.border = element_rect(linewidth=lw, color="black"),
          strip.text = element_blank()) +
    coord_fixed(xlim = c(lim$xmin, lim$xmax),
                ylim = c(lim$ymin, lim$ymax),
                ratio = 1) +
    guides(alpha = "none")
}

plots <- list()
func_order <- c("line1", "stairs", "stairs_2", "square_spiral", "alternating_diff_2", "square_2", "alternating_diff_1", "123",
                "radial_1", "zigzag_widening", "hourglass_1", "zigzag_1", "3_pts", "sine", "plus", "decreasing_y",
                "triangle_1", "increasing_lines", "zigzag_3", "f_curly_2", "spiral_outward", "zigzag_2", "hexagon", "radial_increasing")
i=0
for (f in func_order) {
  i=i+1
  if (i%%8==0) {
    lw = 1
  } else {
    lw= 0.1
  }
  plots[[length(plots) + 1]] <- plot_func(f, lw) + theme(plot.margin = margin(0.01, 0.01, 0.01, 0.01, "in"))
}

p <- grid.arrange(grobs=plots, nrow=3)
ggsave(plot=p, "figs/stimuli.png", width=8, height=3, dpi=1000)
```


# Load participant data
```{r}
df_adult <- preprocess_df_human(read.csv("data/participants/adults.csv")) %>% filter(n>2) %>% mutate(agent="Adults")
df_kid <- preprocess_df_human(read.csv("data/participants/kids_chs.csv")) %>% filter(n>2) %>% mutate(agent="Kids")
df_monkey_1 <- preprocess_df_monkey(read.csv("data/participants/monkeys_1.csv")) %>% filter(n>2)
df_monkey_2 <- preprocess_df_monkey(read.csv("data/participants/monkeys_2.csv")) %>% filter(n>2)
df_monkey <- preprocess_df_monkey(read.csv("data/participants/monkeys_all.csv")) %>% filter(n>2) %>% mutate(agent="Monkeys")
df_all <- bind_rows(df_adult, df_monkey, df_kid)
```
```{r}
df_kid <- preprocess_df_human(read.csv("data/participants/kids_chs.csv")) %>% filter(n>2) %>% mutate(agent="Kids")

# If sessions occur less than one hour apart, count them as a single session
# (likely to due to accidentally leaving the browser)

df_kid <- df_kid %>%
          group_by(subj_id) %>%
          mutate(session = session-min(session)+1) %>%
          mutate(n_sessions = max(session)) %>%
          ungroup()

time_bt_sessions <- df_kid %>%
                    distinct(subj_id, session, start_time) %>%
                    group_by(subj_id) %>%
                    mutate(time_bt_first_and_last_session = max(start_time)-min(start_time)) %>%
                    arrange(subj_id, session) %>%
                    mutate(time_since_last_session = start_time - lag(start_time)) %>%
                    ungroup() %>%
                    select(-c("start_time"))
  
# Time since last session
df_kid <- df_kid %>%
          merge(time_bt_sessions, by=c("subj_id", "session"))
       
session_offsets <- df_kid %>%
                    group_by(subj_id, session) %>%
                    summarize(trials_per_session = max(trial_idx), .groups = "drop") %>%
                    arrange(subj_id, session) %>%
                    group_by(subj_id) %>%
                    mutate(trials_in_prev_session = lag(trials_per_session, default = 0)) %>%
                    mutate(trials_before_session = lag(cumsum(trials_per_session), default = 0)) 

df_kid <- df_kid %>%
       merge(session_offsets, by = c("subj_id", "session")) %>%
       mutate(trial_idx_across_sessions = trial_idx + trials_before_session)


# if less than 1 hour between sessions, count it as a single session
min_time_between_sessions = 1/24
df_kid <- df_kid %>%
          mutate(session = ifelse((session>1) & (time_since_last_session<min_time_between_sessions),
                                  session - 1,
                                  session),
              trial_idx = ifelse((session>1) & (time_since_last_session<min_time_between_sessions),
                                 trial_idx + trials_in_prev_session,
                                 trial_idx)) %>%
      group_by(subj_id) %>%
      mutate(time_bt_first_and_last_session = max(start_time)-min(start_time)) %>%
      mutate(n_sessions = max(session)) %>%
      group_by(subj_id, session) %>%
      mutate(trials_per_session = max(trial_idx)) %>%
      ungroup() %>%
      # no longer meaningful
      select(-c(time_since_last_session, trials_before_session, trials_in_prev_session))


df_kid <- df_kid %>%
          # session duration is start_time 
          group_by(subj_id) %>%
          mutate(n_trials_total = max(trial_idx_across_sessions)) %>%
          group_by(subj_id, session, tpt) %>%
          mutate(trial_1_time_since_start = ifelse(trial_idx==1, trial_time_since_start, NA),
                 trial_1_time_since_start = mean(trial_1_time_since_start, na.rm=T),
                 trial_duration_sum = sum(trial_duration),
                 session_duration = trial_1_time_since_start + trial_duration_sum) %>%
          ungroup()

```
```{r}
# mean n sessions
n_session_df <- df_kid %>%
                distinct(subj_id, n_sessions, n_trials_total) %>%
                summarize(n_sessions=mean(n_sessions), n_trials_total=mean(n_trials_total))
              
per_session_df <- df_kid %>%
                  distinct(session, subj_id, trials_per_session, session_duration) %>%
                  summarize(session_duration=mean(session_duration),
                            trials_per_session=mean(trials_per_session))
            
```






# Check overall and final timepoint accuracy by agent 
```{r}
mean_df <- df_all %>%
           group_by(agent, func.name, n, subj_id) %>%
           summarize(correct=mean(correct, na.rm=T), .groups="drop") %>%
           group_by(agent, func.name, n) %>%
           summarize(correct=mean(correct, na.rm=T))

print(mean_df%>%group_by(agent)%>%summarize(correct=mean(correct)))
print(mean_df%>%filter(n==14)%>%group_by(agent)%>%summarize(correct=mean(correct, na.rm=T)))
```

# Check highest and lowest accuracy patterns
```{r}
func_mean_df <- mean_df %>% group_by(agent, func.name) %>% summarize(correct=mean(correct), .groups="drop") %>% pivot_wider(names_from=agent, values_from=correct)
```

# Check accuracy by age
```{r}
age_df <- df_kid %>%
          group_by(subj_id, func.name, n) %>%
          summarize(correct=mean(correct), age=mean(age), .groups="drop")

print(age_df%>%group_by(func.name, age) %>% summarize(correct=mean(correct)), .groups="drop") %>% group_by(age) %>% summarize(correct=mean(correct))
print(age_df %>% filter(n==14) %>% 
               group_by(func.name, age) %>%
               summarize(correct=mean(correct), .groups="drop") %>%
               group_by(age) %>% summarize(correct=mean(correct)))
```

# Effect of age on correctness
```{r}
exact_age_df <- df_kid %>%
                select(c(exact_age, age, subj_id, func.name, n, correct)) %>%
                mutate(exact_age_std = scale(exact_age)[,1],
                       n_std = scale(n)[,1],)

m <- glmer(correct ~ 1 + exact_age_std + n_std + (exact_age_std:n_std) + (1+n_std|func.name) + (1+n_std|subj_id),
           data=exact_age_df,
           family = binomial(link = "logit"), control=glmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1000000)))

summary(m)
```

# Correlation of kids with adults
```{r}
df_comp <- bind_rows(df_adult, df_monkey, df_kid %>% mutate(agent=as.character(age))) %>%
           group_by(agent, subj_id, func.name) %>%
           summarize(accuracy=mean(correct, na.rm=T), .groups="drop") %>%
           group_by(agent, func.name) %>%
           summarize(accuracy=mean(accuracy, na.rm=T), .groups="drop") %>%
           pivot_wider(names_from="agent", values_from=accuracy) %>%
           na.omit()

for (x in 3:7) {
  print(paste0("age ", x))
  print(cor.test(df_comp$Adults, df_comp[[as.character(x)]], method="pearson"))
}

```
# Monkey accuracy by subj
```{r}
mean_df <- df_monkey %>%
           group_by(func.name, n, subj_id) %>%
           summarize(correct=mean(correct, na.rm=T), .groups="drop")

print(mean_df%>%group_by(subj_id)%>%summarize(correct=mean(correct)))
print(mean_df%>%filter(n==14)%>%group_by(subj_id)%>%summarize(correct=mean(correct, na.rm=T)))
```
# Highest and lowest accuracy patterns
```{r}
func_mean_df <- mean_df %>% group_by(subj_id, func.name) %>% summarize(correct=mean(correct)) %>% pivot_wider(names_from=subj_id, values_from=correct)
```
# Correlation between monkeys
```{r}
print(cor.test(func_mean_df$BP22, func_mean_df$BP24, method="pearson"))
```

# Correlation of humans with monkeys
```{r}
df_comp <- bind_rows(df_adult, df_monkey, df_kid %>% mutate(agent=as.character(age))) %>%
           group_by(agent, subj_id, func.name) %>%
           summarize(accuracy=mean(correct, na.rm=T), .groups="drop") %>%
           group_by(agent, func.name) %>%
           summarize(accuracy=mean(accuracy, na.rm=T), .groups="drop") %>%
           pivot_wider(names_from="agent", values_from=accuracy) %>%
           na.omit()

df_comp <- bind_rows(df_adult, df_monkey, df_kid %>% mutate(agent=as.character(age))) %>%
           group_by(agent, n, func.name) %>%
           summarize(accuracy=mean(correct, na.rm=T), .groups="drop") %>%
           group_by(agent, func.name) %>%
           summarize(accuracy=mean(accuracy, na.rm=T), .groups="drop") %>%
           pivot_wider(names_from="agent", values_from=accuracy) %>%
           na.omit()


print("Adults")
print(cor.test(df_comp$Monkeys, df_comp$Adults, method="pearson"))
for (x in 3:7) {
  print(paste0("age ", x))
  print(cor.test(df_comp$Monkeys, df_comp[[as.character(x)]], method="pearson"))
}

```

# Slopes within patterns
# frequentist trash
```{r}
compute_fit <- function(df) {
  m <- glmer(
            correct ~ 1 +                          # fixed intercept
                      tpt_std +                    # fixed slope 
                      (1 + tpt_std | subj_id) +    # random intercept + slope for subject
                      (1 + tpt_std | func.name),   # random intercept + slope for function
            data = df,
            family = binomial(link = "logit")
  )
  return(m)
}

df_std <- df_all %>%
          mutate(agent = ifelse(agent=="Kids", paste0(age, " y/o"), agent)) %>%
          filter(n>2) %>%
          select(c("agent", "correct", "tpt", "func.name", "subj_id")) %>%
          mutate(tpt_std = scale(tpt)[,1])

for (agent_df in split(df_std, df_std$agent)) {
  print(unique(agent_df$agent))
  m<- compute_fit(agent_df)
  print(summary(m))
}

# Now analyze fit: primarily interested in overall effect of tpt

```
# Bayez
```{r}
# within each group:
# p_correct = logit(alpha + alpha_subj + alpha_func + (beta_tpt + beta_func_tpt) * tpt)

# fixed effects
# alpha ~ normal(0, 3)
# beta_tpt ~ normal(0, 3)

# random effects
# alpha_subj ~ normal(0, sd_subj)
# alpha_func ~ normal(0, sd_func)
# beta_func_tpt ~ normal(0, sd_func_tpt)

# hyperparams
# sd_func_tpt ~ exponential(1)
# sd_subj ~ exponential(1)
# sd_func ~ exponential(1)

compute_fit <- function(df) {
  fit <- brm(
    correct ~ 1 +                          # fixed intercept
              tpt_std +                    # fixed slope 
              (1 + tpt_std | subj_id) +              # random intercept for subject
              (1 + tpt_std | func.name),   # random intercept + slope for function
    data = df,
    family = bernoulli(link = "logit"),
    prior = c(
      prior(normal(0, 3), class = "Intercept"), # prior for fixed intercept
      prior(normal(0, 3), class = "b"),         # prior for fixed slope
      prior(exponential(1), class = "sd")       # hyperprior for random intercepts and slopes
    ),
    cores = 4, chains = 4, iter = 1000
  )
  return(fit)
}

df_std <- df_all %>%
          mutate(agent = ifelse(agent=="Kids", paste0(age, " y/o"), agent)) %>%
          filter(n>2) %>%
          select(c("agent", "correct", "tpt", "func.name", "subj_id")) %>%
          #group_by(func.name, subj_id, agent) %>%
          mutate(tpt_std = scale(tpt)[,1])

samples <- data.frame()
for (agent_df in split(df_std, df_std$agent)) {
  print(unique(agent_df$agent))
  agent_fit <- compute_fit(agent_df)
  print(summary(agent_fit))
  agent_samples <- as_draws_df(agent_fit) %>% mutate(agent = agent_df$agent[[1]])
  samples <- bind_rows(samples, agent_samples)
}

# Now analyze fit: primarily interested in overall effect of tpt

```

```{r}
ggplot(samples, aes(x = b_Intercept)) +
  geom_density(aes(fill=agent), alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "Posterior distribution of beta_tpt (standardized)",
    x = "beta_tpt",
    y = "Density"
  ) +
  facet_wrap(~agent)

summ <- samples %>%
        group_by(agent) %>%
        summarize(
          lower_90 = quantile(b_tpt_std, 0.05),
          lower_95 = quantile(b_tpt_std, 0.025),
          median = quantile(b_tpt_std, 0.5),
          upper_95 = quantile(b_tpt_std, 0.975),
          upper_90 = quantile(b_tpt_std, 0.95),
          .groups="drop"
        )
```




# Analogous p_true results
# Check overall and final timepoint accuracy by agent 
```{r}
df_adult_modeled <- read.csv('p_true_analyses/posterior_means/mean_adult.csv') %>%
                    mutate(agent="Adults") %>%
                    rename(subj_id = r_id, func.name = func.type, n = tpt)
df_kid_modeled <- read.csv('p_true_analyses/posterior_means/mean_kid_chs.csv') %>%
                  mutate(agent="Kids") %>%
                  rename(subj_id = r_id, func.name = func.type, n = tpt)
df_monkey_modeled <- read.csv('p_true_analyses/posterior_means/mean_monkey.csv') %>%
                     mutate(agent="Monkeys") %>%
                     rename(subj_id = r_id, func.name = func.type, n = tpt)
df_all_modeled <- bind_rows(df_adult_modeled, df_kid_modeled, df_monkey_modeled)
```

# Relationship bt accuracy and p_true
```{r}
acc_true_df <- df_all_modeled %>%
               mutate(agent=ifelse(agent=="Monkeys", subj_id, agent)) %>%
               mutate(agent=ifelse(agent=="Kids", paste0(substr(group, 9, 11), " y/o"), agent)) %>%
               group_by(agent, func.name, n, subj_id) %>%
               summarize(p_true=mean(prob_true, na.rm=T), .groups="drop") %>%
               group_by(agent, func.name) %>%
               summarize(p_true=mean(p_true, na.rm=T))


acc_true_df <- acc_true_df %>%
               merge(df_all %>%
                     mutate(agent=ifelse(agent=="Monkeys", subj_id, agent)) %>%
                     mutate(agent=ifelse(agent=="Kids", paste0(age, " y/o"), agent)) %>%
                     group_by(agent, func.name, n, subj_id) %>%
                     summarize(accuracy=mean(correct, na.rm=T), .groups="drop") %>%
                     group_by(agent, func.name) %>%
                     summarize(accuracy=mean(accuracy, na.rm=T)) %>%
                     select(c("accuracy", "func.name", "agent")),
                     
                     by = c("agent", "func.name")) %>%
              filter(func.name != "radial_increasing")


ggplot(data=acc_true_df) +
      geom_point(aes(x=p_true, y=accuracy, color=func.name)) +
      geom_abline(slope=1, linetype="dashed") +
      
      facet_wrap(~agent, ncol=2)
  
               

```
```{r}
ggplot(df_monkey_modeled) +
    geom_histogram(data=df_kid_modeled, aes(x=motor_sd), alpha=0.5) +
  geom_vline(aes(xintercept=motor_sd, group=subj_id, color=subj_id))

```

# Mean p_true
```{r}
mean_df <- df_all_modeled %>%
           group_by(agent, func.name, n, subj_id) %>%
           summarize(correct=mean(prob_true, na.rm=T), .groups="drop") %>%
           group_by(agent, func.name, n) %>%
           summarize(correct=mean(correct, na.rm=T))

print(mean_df%>%group_by(agent)%>%summarize(correct=mean(correct)))
print(mean_df%>%filter(n==14)%>%group_by(agent)%>%summarize(correct=mean(correct, na.rm=T)))
```
# Check highest and lowest accuracy patterns
```{r}
func_mean_df <- mean_df %>% group_by(agent, func.name) %>% summarize(correct=mean(correct), .groups="drop") %>% pivot_wider(names_from=agent, values_from=correct)
```
# Check accuracy by age
```{r}
age_df <- df_all_modeled %>%
         group_by(group, func.name, n, subj_id) %>%
         summarize(correct=mean(prob_true, na.rm=T), .groups="drop") %>%
         group_by(group, func.name, n) %>%
         summarize(correct=mean(correct, na.rm=T))

print(age_df %>%
      group_by(func.name, group) %>%
      summarize(correct=mean(correct)), .groups="drop") %>%
      group_by(group) %>% summarize(correct=mean(correct))

print(age_df %>%
      filter(n==14) %>% 
      group_by(func.name, group) %>%
      summarize(correct=mean(correct), .groups="drop") %>%
      group_by(group) %>%
      summarize(correct=mean(correct)))
```
# Correlation of kids with adults
```{r}
df_comp <- df_all_modeled %>%
           group_by(group, subj_id, func.name) %>%
           summarize(accuracy=mean(prob_true, na.rm=T), .groups="drop") %>%
           group_by(group, func.name) %>%
           summarize(accuracy=mean(accuracy, na.rm=T), .groups="drop") %>%
           pivot_wider(names_from="group", values_from=accuracy) %>%
           na.omit()

for (x in 3:7) {
  print(paste0("age ", x))
  print(cor.test(df_comp$adults, df_comp[[paste0("kid_chs_", x)]], method="pearson"))
}

```
# Monkey accuracy by subj
```{r}
mean_df <- df_monkey_modeled %>%
           group_by(func.name, n, subj_id) %>%
           summarize(correct=mean(prob_true, na.rm=T), .groups="drop")

print(mean_df%>%group_by(subj_id)%>%summarize(correct=mean(correct)))
print(mean_df%>%filter(n==14)%>%group_by(subj_id)%>%summarize(correct=mean(correct, na.rm=T)))
```
# Highest and lowest accuracy patterns
```{r}
func_mean_df <- mean_df %>% group_by(subj_id, func.name) %>% summarize(correct=mean(correct)) %>% pivot_wider(names_from=subj_id, values_from=correct)
```
# Correlation between monkeys
```{r}
print(cor.test(func_mean_df$BP22, func_mean_df$BP24, method="pearson"))
```

# Correlation between humans and monkeys
```{r}
print("Adults")
print(cor.test(df_comp$monkeys, df_comp$adults, method="pearson"))
for (x in 3:7) {
  print(paste0("age ", x))
  print(cor.test(df_comp$monkeys, df_comp[[paste0("kid_chs_", x)]], method="pearson"))
}

```


# Other kids analyses
## Accuracy across sessions


```{r}
# Trial idx, across sessions

# Trial idx, within sessions

# Effect of within-session idx

# Effect of session #
compute_fit <- function(df) {
  m <- glmer(
            correct ~ 1 +                          # fixed intercept
                      #trial_idx_across_sessions_std +
                      trial_idx_std +                  # fixed slope for trial
                      session_std +
                      tpt_std +                    # fixed slope on tpt
                      (trial_idx_std:session_std) +        # interaction of trial idx and session
                      (1 + tpt_std + trial_idx_std + session_std | subj_id) +  # random intercept + slopes for subject
                      (1 + tpt_std | func.name),  # random intercept + slopes for function
            data = df,
            family = binomial(link = "logit"),
            control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5))
  )
  return(m)
}

df_std <- df_kid %>%
          select(c("agent", "age", "correct", "tpt", "func.name", "subj_id", "session", "trial_idx", "trial_idx_across_sessions")) %>%
          mutate(tpt_std = scale(tpt)[,1],
                 trial_idx_std = scale(trial_idx)[,1],
                 session_std = scale(session)[,1],
                 trial_idx_across_sessions_std = scale(trial_idx_across_sessions)[,1])

for (age_df in split(df_std, df_std$age)) {
  print(unique(age_df$age))
  m <- compute_fit(age_df)
  print(summary(m))
}

```

# Brm
```{r}
compute_fit <- function(df) {
  fit <- brm(
              correct ~ 1 +                          # fixed intercept
                #trial_idx_across_sessions_std +
                trial_idx_std +                  # fixed slope for trial
                session_std +
                tpt_std +                    # fixed slope on tpt
                (trial_idx_std:session_std) +        # interaction of trial idx and session
                #(1 + tpt_std | subj_id) +
                (1 + tpt_std + trial_idx_std + session_std | subj_id) +              # random intercept + slopes for subject
                (1 + tpt_std | func.name),            # random intercept + slopes for function
    data = df,
    family = bernoulli(link = "logit"),
    prior = c(
      prior(normal(0, 3), class = "Intercept"), # prior for fixed intercept
      prior(normal(0, 3), class = "b"),         # prior for fixed slope
      prior(exponential(1), class = "sd")       # hyperprior for random intercepts and slopes
    ),
    cores = 4, chains = 4, iter = 1000
  )
  return(fit)
}

df_std <- df_kid %>%
          select(c("agent", "age", "correct", "tpt", "func.name", "subj_id", "session", "trial_idx", "trial_idx_across_sessions")) %>%
          mutate(tpt_std = scale(tpt)[,1],
                 trial_idx_std = scale(trial_idx)[,1],
                 session_std = scale(session)[,1],
                 trial_idx_across_sessions_std = scale(trial_idx_across_sessions)[,1])

samples <- data.frame()
for (age_df in split(df_std, df_std$age)) {
  print(unique(age_df$age))
  age_fit <- compute_fit(age_df)
  print(summary(age_fit))
  age_samples <- as_draws_df(age_fit) %>% mutate(age = age_df$age[[1]])
  samples <- bind_rows(samples, age_samples)
}

```

```{r}
ggplot(samples) +
  geom_density(aes(x = b_trial_idx_std), fill="green", alpha = 0.6) +
  geom_density(aes(x = b_session_std), fill="purple", alpha = 0.6) +
  geom_density(aes(x = b_tpt_std), fill="gold", alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "Posterior distribution of beta_tpt (standardized)",
    x = "beta_tpt",
    y = "Density"
  ) +
  facet_wrap(~age)

summ <- samples %>%
        group_by(age) %>%
        summarize(
          lower_90 = quantile(b_tpt_std, 0.05),
          lower_95 = quantile(b_tpt_std, 0.025),
          median = quantile(b_tpt_std, 0.5),
          upper_95 = quantile(b_tpt_std, 0.975),
          upper_90 = quantile(b_tpt_std, 0.95),
          .groups="drop"
        )
```
#GLMER over all ages
```{r}
# Effect of session #
compute_fit <- function(df) {
  m <- glmer(
            correct ~ 1 +                          # fixed intercept
                      trial_idx_across_sessions_std +
                      #trial_idx_std +                  # fixed slope for trial
                      #session_std +
                      age_std +
                      tpt_std +                    # fixed slope on tpt
                      (age_std:tpt_std) +
                      (age_std:trial_idx_across_sessions_std) +
                      (tpt_std:trial_idx_across_sessions_std) +
                      #(age_std:trial_idx_std) +
                      #(age_std:session_std) +
                      #(tpt_std:trial_idx_std) +
                      #(tpt_std:session_std) +
                      #(trial_idx_std:session_std) +        # interaction of trial idx and session
                      (1 + tpt_std + trial_idx_across_sessions_std | subj_id) + # random intercept + slopes for subject
                      (1 + tpt_std | func.name),            # random intercept + slopes for function
            data = df,
            family = binomial(link = "logit"),
            control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5))
  )
  return(m)
}

df_std <- df_kid %>%
          select(c("agent", "exact_age", "correct", "tpt", "func.name", "subj_id", "session", "trial_idx", "trial_idx_across_sessions")) %>%
          mutate(tpt_std = scale(tpt)[,1],
                 trial_idx_std = scale(trial_idx)[,1],
                 session_std = scale(session)[,1],
                 trial_idx_across_sessions_std = scale(trial_idx_across_sessions)[,1],
                 age_std = scale(exact_age)[,1])

m <- compute_fit(df_std)
print(summary(m))

```

```{r}
# Effect of session #
compute_fit <- function(df) {
  m <- glmer(
            correct ~ 1 +                          # fixed intercept
                      #trial_idx_across_sessions_std +
                      trial_idx_std +                  # fixed slope for trial
                      tpt_std +                    # fixed slope on tpt
                      (trial_idx_std:tpt_std) +
                      (1 + tpt_std + trial_idx_std | subj_id) + # random intercept + slopes for subject
                      (1 + tpt_std | func.name),            # random intercept + slopes for function
            data = df,
            family = binomial(link = "logit"),
            control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5))
  )
  return(m)
}

df_std <- df_adult %>%
          select(c("agent", "correct", "tpt", "func.name", "subj_id", "trial_idx")) %>%
          mutate(tpt_std = scale(tpt)[,1],
                 trial_idx_std = scale(trial_idx)[,1])

m <- compute_fit(df_std)
print(summary(m))

```





```{r}
ggplot(df_kid) +
  stat_summary(geom="line", aes(x=session, y=correct)) +
  geom_line(aes(x=session, y=correct, color=subj_id), alpha=0.5) +
  guides(color="none") +
  facet_wrap(~age)

```
## Including kids who failed IC
```{r}
df_kid_pre <- preprocess_df_human(read.csv("../human_experiments/dots_app_kids/data/clean_data/data_pre_exclusion.csv")) %>% filter(n>2) %>% mutate(agent="Kids")

```
```{r}
ic_df <- df_kid_pre %>%
               distinct(subj_id, passed_ic, age)

ggplot(ic_df) +
  geom_bar(aes(x=age, group=passed_ic, fill=passed_ic))


ic_df %>%
group_by(age, passed_ic) %>%
summarize(count = n())
  
  
```

## How close did kids get to failing IC?
```{r}

```


















```{r}
df_lot <- preprocess_model(read.csv('data/models/lot.csv'))
df_acc <- df_adult %>% group_by(func.name) %>% summarize(acceptance_dist = mean(acceptance_dist, na.rm=T))
df_lot <- merge(df_lot, df_acc) %>% mutate(correct = (acceptance_dist>=abs_err)*1) %>% group_by(func.name, n) %>%
        mutate(norm_correct = sum(correct * posterior, na.rm=T))

```
```{r}
tmp <- df_adult %>%
       group_by(func.name, n) %>%
       summarize(correct=mean(correct)) %>%
       merge(df_lot %>%
             group_by(func.name, n) %>%
             summarize(model_correct = mean(norm_correct), .groups="drop")) %>%
       filter(n>2)

cor.test(tmp$model_correct, tmp$correct)

tmp2 <- tmp %>%
        group_by(func.name) %>%
        summarize(correct = mean(correct),
                  model_correct=mean(model_correct))
       

cor.test(tmp2$model_correct, tmp2$correct)
```
```{r}
ggplot(data=tmp) +
  geom_line(aes(x=n, y=model_correct), color="limegreen") +
  geom_line(aes(x=n, y=correct)) +
  facet_wrap(~func.name)
```