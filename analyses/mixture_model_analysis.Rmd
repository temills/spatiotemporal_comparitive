---
title: "mixture_model_analysis"
output: html_document
---

```{r, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=4, fig.height=3,fig.align = "center",cache=TRUE)
library(ggplot2)
library(reshape)
library(grid)
library(dplyr)
library(gridExtra)
library(lme4)
library(reghelper)
library(RColorBrewer)
library(robustbase)
library(tidylog)
library(hash)
library(rstan)
library(png)
library(gtable)
#library(rjson)
library(tidyr)

paper_theme <- theme_light() + theme( axis.title.x = element_text(size=22),
                                      axis.text.x=element_text(
                                        size = 18), 
                                      axis.title.y = element_text(size = 22, vjust = 1),
                                      axis.text.y  = element_text(size = 18),
                             strip.text=element_text(size=16),
                                      axis.line.x = element_line(colour = "black"), 
                                      axis.line.y = element_line(colour = "black"),
                                      legend.title=element_text(size=20),
                                      legend.text=element_text(size=16),
                                      panel.grid.major=element_blank(),
                #   panel.background = element_rect(color = NA), 
                                      panel.grid.minor=element_blank())  
out_folder <- "figs/"

capitalize_words <- function(s) {
  words <- str_split(s, " ")[[1]]
  words <- ifelse(words == "to", "to", str_to_title(words))
  paste(words, collapse = " ")
}
add_png_to_facet <- function(ggplot_object, data, facet_var, x_loc,y_loc, width, height, out_file) {
  # Get the ggplotGrob
  gtable <- ggplotGrob(ggplot_object)
  # Get the unique facet labels in the order they appear in the data
  facet_labels <- rev(unique(data[[facet_var]]))
  # Extract panel positions from the layout
  panel_positions <- subset(gtable$layout, grepl("panel", name))
  # Order the panels by their left (l) and top (t) positions
  ordered_panel_positions <- with(panel_positions, order(t, l))
  # Ensure the facet labels order matches the plot
  # For each ordered panel position, add the PNG
  for (i in seq_along(ordered_panel_positions)) {
    panel_index <- ordered_panel_positions[i]
    facet_label <- facet_labels[i]
    if (!is.na(facet_label)) {
      img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
      # Convert to raster and add it to the gtable
      g <- rasterGrob(img, interpolate = TRUE, width = unit(0.24, "npc"), height = unit(0.3, "npc"))
      g <- editGrob(g, vp = viewport(x = x_loc, y = y_loc, just = c("right", "top")))
      gtable <- gtable_add_grob(gtable, g, t = panel_positions$t[panel_index], l = panel_positions$l[panel_index])
    }
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(gtable)
  dev.off()
}


f_weighted_sd <- function(means, sds, weights)  {
  var_wtd = sum(weights * sds**2) + sum(weights * means**2) - (sum(weights*means)**2)
  return (var_wtd**0.5)
}

inv_logit <- function(x) { exp(x)/(1+exp(x))}

add_sim_data <- function(df) {
  true_l <- list(
    x_curr = (1:20)/21,
    y_curr = (1:20)/21,
    x_next = (2:21)/21,
    y_next = (2:21)/21,
    x_pred = sapply((2:21)/21, function(x) rnorm(1, mean = x, sd = 0.01)),
    y_pred = sapply((2:21)/21, function(x) rnorm(1, mean = x, sd = 0.01))
  )
  df_true <- data.frame(true_l)
  df_true$func.type <- "true"
  df_true$min_x <- min(c(df_true$x_pred, df_true$x_curr, df_true$x_next))
  df_true$max_x <- max(c(df_true$x_pred, df_true$x_curr, df_true$x_next))
  df_true$min_y <- min(c(df_true$y_pred, df_true$y_curr, df_true$y_next))
  df_true$max_y <- max(c(df_true$y_pred, df_true$y_curr, df_true$y_next))
  rand_l <- list(
    x_curr = (1:20)/21,
    y_curr = (1:20)/21,
    x_next = (2:21)/21,
    y_next = (2:21)/21,
    x_pred = sapply((1:20)/101, function(x) rnorm(1, mean = x, sd = 0.01)),
    y_pred = sapply((1:20)/101, function(x) rnorm(1, mean = x, sd = 0.01))
  )
  df_rand$func.type <- "rand"
  df_rand$min_x <- min(c(df_rand$x_pred, df_rand$x_curr, df_rand$x_next))
  df_rand$max_x <- max(c(df_rand$x_pred, df_rand$x_curr, df_rand$x_next))
  df_rand$min_y <- min(c(df_rand$y_pred, df_rand$y_curr, df_rand$y_next))
  df_rand$max_y <- max(c(df_rand$y_pred, df_rand$y_curr, df_rand$y_next))
  df_sim <- bind_rows(df_rand, df_true)
  return(bind_rows(df, df_sim))
}

preprocess_df_human <- function(df) {
  df <- df[order(df$tpt),] %>%
      rename(x_curr = prev_x, y_curr = prev_y, x_next = true_x, y_next = true_y, x_pred = response_x, y_pred = response_y, func.type = seq_id) %>%
      group_by(subject_id, trial_idx, tpt) %>%
      mutate(true_dist=((x_next-x_curr)**2. + (y_next-y_curr)**2.)**0.5) %>%
      mutate(x_err=x_pred-x_next) %>%
      mutate(y_err=y_pred-y_next) %>%
      mutate(abs_err = ((x_err**2)+(y_err)**2) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(dist_from_prev = (((x_pred-x_curr)**2)+((y_pred-y_curr)**2)) **0.5) %>%
      ungroup() %>%
      mutate(scaled_err = scale(abs_rel_err)[,1])
  return(df)
}

preprocess_df_monkey <- function(df) {
  df <- df[order(df$n),] %>%
      rename(tpt = n, subject_id = monkey_name) %>%
      group_by(subject_id, game_n, tpt) %>%
      mutate(true_dist=((x_next-x_curr)**2. + (y_next-y_curr)**2.)**0.5) %>%
      mutate(x_err=x_pred-x_next) %>%
      mutate(y_err=y_pred-y_next) %>%
      mutate(abs_err = ((x_err**2)+(y_err)**2) **0.5) %>%  
      mutate(abs_rel_err = abs_err/(true_dist)) %>%
      mutate(dist_from_prev = (((x_pred-x_curr)**2)+((y_pred-y_curr)**2)) **0.5) %>%
      ungroup() %>%
      mutate(tpt = tpt+1) %>%
      filter(tpt<15) %>%
      filter(tpt>2)
  return(df)
}
```

#Plot all sequences
```{r}
df <- df[order(df$tpt),]

# Mapping of existing names to new names
name_mapping <- c('plus'='plus sign', 'hourglass_1'='hourglass', 'zigzag_2'='zigzag 2', 'radial_1'='radial', 'spiral_outward'='spiral', 'square_spiral'='square spiral', 'stairs_2'='steps 2', 'hexagon'='hexagon', 'zigzag_1'='zigzag 1', 'sine'='sine', 'zigzag_widening'='widening zigzag','alternating_diff_1'='alternating 1', 'alternating_diff_2'='alternating 2', 'f_curly_2'='curlicue', 'stairs'='steps 1', '3_pts'='3 points', 'increasing_lines'='growing lines', 'square_2'='square', 'triangle_1'='triangle', 'zigzag_3'='zigzag 3', 'line'='line')

# Create a new column with mapped names
df <- df %>%
  mutate(pretty_seq_id = name_mapping[seq_id])

p <- ggplot() +
  geom_path(data=df, aes(x=true_x, y=true_y), linetype="dashed") +
  geom_point(data=df, aes(x=true_x, y=true_y, color=tpt), size=4) +
  paper_theme + theme(panel.background = element_rect(fill = "white"), strip.background=element_blank(), strip.text = element_text(color="black", size=18)) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(), axis.title.x = element_blank(), axis.title.y = element_blank()) +
  scale_color_continuous(low="blueviolet", high="orange",  name = "Tpt") +
  guides(alpha="none") +
  facet_wrap(~pretty_seq_id, scales="free", ncol=11)
p + theme(legend.position = c(1, 0), legend.justification = c(1.3, -0.1))
fname <- "figs/patterns.pdf"
ggsave(fname, plot = last_plot(), width = 21, height = 5, units = "in", bg="white")
print(knitr::include_graphics(fname))
```

#Load data
```{r, message=F}
df <- read.csv("/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/dots_app_kids/data/clean_data/data.csv")
df <- preprocess_df_human(df) %>% filter(func.type != "example_line")
df_adult <- read.csv("/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/dots_app_kids_adult_vsn/data/clean_data/data.csv")
df_adult <- preprocess_df_human(df_adult)# %>% rename(line = example_line)
df_monkey <- read.csv("/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/monkey_game/data/monkeys_clean.csv")
df_monkey <- preprocess_df_monkey(df_monkey) #%>% rename(line = example_line)
```

```{r}
unique((df_monkey %>% filter(subject_id=="BP22"))$func.type)
```

#Plot all predictions together
```{r}
ggplot() +
  geom_point(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), size=1) +
  geom_path(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), linetype="solid") +
  geom_point(data=df_adult, aes(x=x_pred, y=y_pred), color = "cyan", size=.2, alpha=0.5) +
  geom_point(data=df, aes(x=x_pred, y=y_pred), color = "pink", size=.2, alpha=0.8) +
  geom_point(data=df_monkey, aes(x=x_pred, y=y_pred), color = "gold", size=.2, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  guides(color="none", alpha="none") +
  facet_wrap(~func.type, scales="free")
```

```{r}
f <- "zigzag_widening"
ggplot() +
  geom_point(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), size=3) +
  geom_path(data=df, aes(x=x_curr, y=y_curr, alpha=tpt+1), linetype="solid") +
  #geom_rect(data=df, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="blue", fill="white", alpha=0.5) +
  #geom_point(data=df_adult, aes(x=x_pred, y=y_pred), color = "cyan", size=.2, alpha=0.5) +
  #geom_point(data=df, aes(x=x_pred, y=y_pred), color = "pink", size=.2, alpha=0.8) +
  geom_point(data=df_monkey, aes(x=x_curr, y=y_curr), color = "green", size=.2, alpha=0.5) +
  geom_point(data=df_monkey, aes(x=x_pred, y=y_pred), color = "gold", size=.2, alpha=0.5) +
  #geom_rect(data=df_monkey, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="gold", fill=NA, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  guides(color="none", alpha="none") +
  facet_wrap(~func.type, scales="free")
```

#Stan model helpers
```{r}
get_stan_df <- function(df, add_sim=FALSE) {
  stan_df <- df
  if(add_sim) {
      stan_df <- add_sim_data(stan_df)
  }
  stan_df <- stan_df %>%
            filter(!is.na(x_pred) & (!is.na(y_pred))) %>%
            mutate(x_curr = (x_curr-min_x)/(max_x-min_x), x_pred = (x_pred-min_x)/(max_x-min_x), x_next = (x_next-min_x)/(max_x-min_x),
                y_curr = (y_curr-min_y)/(max_y-min_y), y_pred =(y_pred-min_y)/(max_y-min_y), y_next = (y_next-min_y)/(max_y-min_y))
  return(stan_df)
}


get_posterior_flat <- function(stan_df, n_iter, func_str_to_num) {
  stan_data <- list(
    N = length(stan_df$x_pred),
    x_pred = stan_df$x_pred,
    y_pred = stan_df$y_pred,
    x_next = stan_df$x_next,
    y_next = stan_df$y_next,
    x_curr = stan_df$x_curr,
    y_curr = stan_df$y_curr,
    #n_kids = length(unique(stan_df$subject_id)),
    #kid = as.numeric(as.factor(stan_df$subject_id)),
    n_func_types = length(unique(stan_df$func.type)),
    func_type = setNames(func_str_to_num[stan_df$func.type], NULL)
  )
  fit <- stan(file="/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/model.stan", data=stan_data, iter=n_iter, chains=1, cores=1)
  posterior_samples_lst <- rstan::extract(fit)
  posterior_samples <- as.data.frame(posterior_samples_lst)
  return(posterior_samples)
}

get_posterior_hier <- function(stan_df, n_iter, n_chains) {
  stan_data <- list(
    N = length(stan_df$x_pred),
    x_pred = stan_df$x_pred,
    y_pred = stan_df$y_pred,
    x_next = stan_df$x_next,
    y_next = stan_df$y_next,
    x_curr = stan_df$x_curr,
    y_curr = stan_df$y_curr,
    guess_num = as.integer(stan_df$tpt - 2),
    n_kids = length(unique(stan_df$subject_id)),
    kid = setNames(var_maps$subject_id[stan_df$subject_id], NULL),
    n_func_types = length(unique(stan_df$func.type)),
    func_type = setNames(var_maps$func_type[stan_df$func.type], NULL)
  )
  fit <- stan(file="/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/stan_models/model.stan", data=stan_data, iter=n_iter, chains=n_chains, cores=1)
  return (fit)
}

get_posterior_w_age <- function(stan_df, n_iter, n_chains) {
  stan_data <- list(
    N = length(stan_df$x_pred),
    x_pred = stan_df$x_pred,
    y_pred = stan_df$y_pred,
    x_next = stan_df$x_next,
    y_next = stan_df$y_next,
    x_curr = stan_df$x_curr,
    y_curr = stan_df$y_curr,
    age = scale(stan_df$age)[, 1],
    guess_num = as.integer(stan_df$tpt - 2),
    n_kids = length(unique(stan_df$subject_id)),
    kid = setNames(var_maps$subject_id[stan_df$subject_id], NULL),
    n_func_types = length(unique(stan_df$func.type)),
    func_type = setNames(var_maps$func_type[stan_df$func.type], NULL)
  )
  
  fit <- stan(file="/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/model_w_age.stan", data=stan_data, iter=n_iter, chains=n_chains, cores=1)
  return (fit)
}

opt <- function(stan_df) {
    stan_data <- list(
    N = length(stan_df$x_pred),
    x_pred = stan_df$x_pred,
    y_pred = stan_df$y_pred,
    x_next = stan_df$x_next,
    y_next = stan_df$y_next,
    x_curr = stan_df$x_curr,
    y_curr = stan_df$y_curr,
    guess_num = as.integer(stan_df$tpt - 2),
    n_kids = length(unique(stan_df$subject_id)),
    kid = setNames(var_maps$subject_id[stan_df$subject_id], NULL),
    n_func_types = length(unique(stan_df$func.type)),
    func_type = setNames(var_maps$func_type[stan_df$func.type], NULL)
  )
  sm <- stan_model("/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/stan_models/model.stan")
  return(optimizing(sm, data = stan_data, hessian = TRUE, iter = 10000))
}


#could refactor posterior_samples to have col for func type, then beta based on that
refactor_posterior <- function(posterior_samples) {
  post <- posterior_samples %>%
    gather(key = "func_type", value = "beta_func_type", starts_with("beta_func_type.")) %>%
    mutate(func_type = as.numeric(gsub("beta_func_type\\.", "", func_type)))
  post$func_type_str <- names(var_maps$func_type)[match(post$func_type, var_maps$func_type)]
  post <- post %>%
    gather(key = "kid", value = "use_true_icpt_kid", starts_with("use_true_icpt_kid.")) %>%
    mutate(kid = as.numeric(gsub("use_true_icpt_kid\\.", "", kid)))
  post$subject_id <- names(var_maps$subject_id)[match(post$kid, var_maps$subject_id)]
  #post <- post %>%
  #  gather(key = "guess_num", value = "beta_guess_num", starts_with("beta_guess_num.")) %>%
  #  mutate(guess_num = as.numeric(gsub("beta_guess_num\\.", "", guess_num)))
  return(post)
}
```


###Kids:
```{r}
df_kid <- read.csv("/Users/traceymills/Dropbox (MIT)/cocosci_projects/dots/kids/dots_app_kids/data/clean_data/data.csv")
df_kid <- preprocess_df_human(df_kid) %>% filter(func.type != "example_line")
stan_df <- get_stan_df(df_kid)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit <- get_posterior_hier(stan_df, 5000, 1)
posterior_samples_lst <- rstan::extract(fit)
posterior_samples <- as.data.frame(posterior_samples_lst)
post_kids <- refactor_posterior(posterior_samples)
write.csv(post_kids, 'posteriors_kids.csv')

#fit_w_age <- get_posterior_w_age(stan_df, 1000, 1)
#posterior_samples_lst <- rstan::extract(fit_w_age)
#posterior_samples <- as.data.frame(posterior_samples_lst)
#post_kids_w_age <- refactor_posterior(posterior_samples)
#write.csv(post_kids_w_age, 'posteriors_kids_w_age.csv')
```


###Monkeys:
```{r}
stan_df <- get_stan_df(df_monkey)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_monkeys <- get_posterior_hier(stan_df,5000, 1)
posterior_samples_lst <- rstan::extract(fit_monkeys)
posterior_samples <- as.data.frame(posterior_samples_lst)

post_monkeys <- refactor_posterior(posterior_samples)
write.csv(post_monkeys, 'posteriors_monkeys.csv')
```
###Monkeys individually
```{r}
stan_df <- get_stan_df(df_monkey%>%filter(subject_id=='BP22'))
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_monkeys <- get_posterior_hier(stan_df,5000, 1)
posterior_samples_lst <- rstan::extract(fit_monkeys)
posterior_samples <- as.data.frame(posterior_samples_lst)
posterior_samples$kid <- 1
post_monkeys <- refactor_posterior(posterior_samples)
write.csv(post_monkeys, 'posteriors_monkeys_BP22.csv')
stan_df <- get_stan_df(df_monkey%>%filter(subject_id=='BP24'))
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_monkeys <- get_posterior_hier(stan_df,5000, 1)
posterior_samples_lst <- rstan::extract(fit_monkeys)
posterior_samples <- as.data.frame(posterior_samples_lst)
posterior_samples$kid <- 2
post_monkeys <- refactor_posterior(posterior_samples)
write.csv(post_monkeys, 'posteriors_monkeys_BP24.csv')
```


###Adults:
```{r}
stan_df <- get_stan_df(df_adult)
func_to_num_map <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
subj_to_num_map <- setNames(as.numeric(factor(unique(stan_df$subject_id))), unique(stan_df$subject_id))
var_maps <- list("func_type"=func_to_num_map, "subject_id"=subj_to_num_map)
fit_adults <- get_posterior_hier(stan_df, 5000,1)
posterior_samples_lst <- rstan::extract(fit_adults)
posterior_samples <- as.data.frame(posterior_samples_lst)
post_adults <- refactor_posterior(posterior_samples)
write.csv(post_adults, 'posteriors_adults.csv')
```

#Load posteriors
```{r}
post_adults <- read.csv('posteriors_adults.csv')
post_kids <- read.csv('posteriors_kids.csv')
post_monkeys <- read.csv('posteriors_monkeys.csv')
```

#Expand df to include row for each guess_num
```{r}
post_monkeys <- crossing(post_monkeys, guess_num = 1:12) %>% mutate(p_true = max_p*inv_logit(use_true_icpt+use_true_icpt_kid+beta_func_type + beta_guess_num*(guess_num))) %>% mutate(agent="Monkeys") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
post_kids <- crossing(post_kids, guess_num = 1:12) %>% mutate(p_true = max_p*inv_logit(use_true_icpt+use_true_icpt_kid+beta_func_type + beta_guess_num*(guess_num))) %>% mutate(agent="Children")
post_adults <- crossing(post_adults, guess_num = 1:12) %>% mutate(p_true = max_p*inv_logit(use_true_icpt+use_true_icpt_kid+beta_func_type + beta_guess_num*(guess_num))) %>% mutate(agent="Adults") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
```


#individual monkeys
```{r}
post_bp22 <- read.csv('posteriors_monkeys_BP22.csv')
post_bp22 <- crossing(post_bp22, guess_num = 1:12) %>% mutate(p_true = max_p*inv_logit(use_true_icpt+use_true_icpt_kid+beta_func_type + beta_guess_num*(guess_num))) %>% mutate(agent="BP22") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))

post_bp24 <- read.csv('posteriors_monkeys_BP24.csv')
post_bp24 <- crossing(post_bp24, guess_num = 1:12) %>% mutate(p_true = max_p*inv_logit(use_true_icpt+use_true_icpt_kid+beta_func_type + beta_guess_num*(guess_num))) %>% mutate(agent="BP24") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
```

#concat dfs into one
```{r}
plot_df <- bind_rows(post_kids, post_monkeys, post_adults, post_bp22, post_bp24) %>%
  group_by(func_type_str, agent) %>%
  mutate(mean_by_agent = mean(p_true, na.rm = TRUE))

plot_df <- plot_df %>%
  group_by(func_type_str, agent) %>%
  mutate(mean_p_true_kid = ifelse(agent == "Children", mean(p_true, na.rm = TRUE), NA)) %>%
  group_by(func_type_str) %>%
  mutate(mean_p_true_kid = mean(mean_p_true_kid, na.rm = TRUE)) %>%
  arrange(mean_p_true_kid) %>%
  ungroup()

plot_df$func_type_str <- factor(plot_df$func_type_str, levels=unique(plot_df$func_type_str[order(1-plot_df$mean_p_true_kid)]))
```


```{r}
fname <- 'figs/p_true_over_time3.png'
p.1 <- ggplot(data=plot_df%>%filter(!(agent %in% c('BP22', 'BP24'))), aes(x = guess_num, y = p_true, color=agent)) +
      #geom_line(aes(group=subject_id), alpha=0.2) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "point", size=1) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=0.3) +
      #stat_summary(fun.data="mean_sdl", na.rm = TRUE, geom="errorbar", alpha=0.5, width=0.1) +
      coord_cartesian(xlim=c(1,13), ylim=c(-0.35,1.2)) +
      scale_color_manual(values =  c("orchid", "#106430", "cornflowerblue")) +
      #scale_x_continuous(breaks = seq(0, 13,by=5)) +
      facet_wrap(~func_type_str, ncol=7) +
      paper_theme +
      theme(legend.title=element_blank(), legend.position="top", strip.background=element_blank(), strip.text=element_blank()) +
      labs(x="Guess number", y="P(learned)")
add_png_to_facet(p.1, plot_df, "func_type_str",  1.35,.71,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```


```{r}
fname <- 'figs/p_true_over_time_ind.png'
p.1 <- ggplot(data=plot_df%>%filter(agent != 'Monkeys'), aes(x = guess_num, y = p_true, color=agent)) +
      #geom_line(aes(group=subject_id), alpha=0.2) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "point", size=1) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=0.3) +
      #stat_summary(fun.data="mean_sdl", na.rm = TRUE, geom="errorbar", alpha=0.5, width=0.1) +
      coord_cartesian(xlim=c(1,13), ylim=c(-0.4,1.3)) +
      scale_color_manual(values =  c("orchid", "dodgerblue", 'blue3', "#106430")) +
      #scale_x_continuous(breaks = seq(0, 13,by=5)) +
      facet_wrap(~func_type_str, ncol=7) +
      paper_theme +
      theme(legend.title=element_blank(), legend.position="top", strip.background=element_blank(), strip.text=element_blank()) +
      labs(x="Guess number", y="P(learned)")
add_png_to_facet(p.1, plot_df, "func_type_str",  1.35,.67,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```





###P true by guess num
```{r}
#ggplot() +
#  geom_path(data=post_adults, aes(x=guess_num, y=p_true)) +
#  facet_wrap(~func_type_str)

plot_df1 <- post_adults %>% select(p_true, subject_id, guess_num, func_type_str) %>% mutate(agent="Adults") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
plot_df2 <- post_kids %>% select(p_true, subject_id, guess_num, func_type_str) %>% mutate(agent="Children")
plot_df3 <- post_monkeys %>% select(p_true, subject_id,  guess_num, func_type_str) %>% mutate(agent="Monkeys") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))

post_all <- rbind(plot_df1, plot_df2, plot_df3)
```

```{r}
plot_df <- post_all
#take mean within each subj
#plot_df <- plot_df %>% group_by(func_type_str, agent, subject_id, guess_num) %>% summarize(p_true = mean(p_true, na.rm=T))
plot_df <- plot_df %>%
  group_by(func_type_str, agent) %>%
  mutate(mean_by_agent = mean(p_true, na.rm = TRUE))


plot_df <- plot_df %>%
  group_by(func_type_str, agent) %>%
  mutate(mean_p_true_kid = ifelse(agent == "Children", mean(p_true, na.rm = TRUE), NA)) %>%
  group_by(func_type_str) %>%
  mutate(mean_p_true_kid = mean(mean_p_true_kid, na.rm = TRUE)) %>%
  arrange(mean_p_true_kid) %>%
  ungroup()

plot_df$func_type_str <- factor(plot_df$func_type_str, levels=unique(plot_df$func_type_str[order(1-plot_df$mean_p_true_kid)]))
```

```{r}
fname <- 'figs/p_true_over_time2.png'
p.1 <- ggplot(plot_df, aes(x = guess_num, y = p_true, color=agent)) +
      #geom_line(aes(group=subject_id), alpha=0.2) +
      #geom_hline(yintercept=0, color="lightgray", linetype="dotted", size=0.4) +
      #geom_hline(yintercept=0.5, color="lightgray", linetype="dotted", size=0.4) +
      #geom_hline(yintercept=1, color="lightgray", linetype="dotted", size=0.4) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=1) +
      stat_summary(fun.data="mean_sdl", na.rm = TRUE, geom="errorbar", alpha=0.5, width=0.1) +
      coord_cartesian(xlim=c(1,13), ylim=c(-0.35,1.2)) +
      scale_color_manual(values =  c("orchid", "#106430", "cornflowerblue")) +
      #scale_x_continuous(breaks = seq(0, 13,by=5)) +
      facet_wrap(~func_type_str, ncol=7) +
      theme(legend.title=element_blank(), legend.position="top",strip.background=element_blank(), strip.text=element_blank()) +
      labs(x="Guess number", y="P(true)")
p.1
#add_png_to_facet(p.1, plot_df, "func_type_str",  1.35,.69,700/2,230/2, fname)
#print(knitr::include_graphics(fname))
```

#scatter p true by func, between agent groups
```{r}
library(ggimage)
plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T)) %>% mutate(func_type_str = if_else(func_type_str=="example_line", "line", func_type_str))
plot_df2 <- post_kids %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_kid = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=plot_df, aes(x=1-mean_p_true_kid, y=1-mean_p_true_adult, image = image_path), size=0.07) +
  coord_fixed(xlim=c(0,1),ylim=c(0,1)) +
  paper_theme +
  labs(x="Difficulty (1-p_true), children", y="Difficulty (1-p_true), adults)")
ggsave("figs/adult-kid_p_true_scatter.png", plot = last_plot(), width = 7, height = 6.5, units = "in", bg="white")
#cor(plot_df$mean_p_true_kid, plot_df$mean_p_true_adult)
```

```{r}
ggsave("figs/adult-kid_p_true_scatter.png", plot = last_plot(), width = 7, height = 6.5, units = "in", bg="white")
```

```{r}

plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T)) %>% mutate(func_type_str = if_else(func_type_str=="example_line", "line", func_type_str))
plot_df2 <- post_monkeys %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_monkey = mean(p_true, rm.na=T)) %>% mutate(func_type_str = if_else(func_type_str=="example_line", "line", func_type_str))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

  
ggplot(plot_df%>%arrange(mean_p_true_monkey), aes(x=mean_p_true_monkey, y=mean_p_true_adult)) +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  #stat_smooth(data=plot_df, aes(x=mean_p_true_monkey, y=mean_p_true_adult),color="orange", method="lm",se=TRUE, linewidth=0.8, alpha=0.2) +
  geom_image(aes(x=mean_p_true_monkey+.05, y=mean_p_true_adult+.05, image = image_path), size=0.09) +
  geom_point(color="#FF8C00") +
  coord_fixed(xlim=c(0,1),ylim=c(0,1)) +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  paper_theme +
  labs(x="P(learned)  (Monkeys)", y="P(learned)  (Adults)")
ggsave("figs/monkey-adult_scatter.png", plot = last_plot(), width = 5, height = 4.4, units = "in", bg="white")

beta(lm(data=plot_df, mean_p_true_monkey ~ mean_p_true_adult))
```

```{r}
plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T)) %>% mutate(func_type_str = if_else(func_type_str=="example_line", "line", func_type_str))
plot_df2 <- post_kids %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_kid = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))
ggplot(data=plot_df%>%arrange(mean_p_true_kid), aes(x=mean_p_true_kid, y=mean_p_true_adult)) +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  #stat_smooth(color="orange", method="lm",se=TRUE, linewidth=0.8, alpha=0.2) +
  geom_image(aes(x=mean_p_true_kid+.05, y=mean_p_true_adult+.05, image = image_path), size=0.09) +
  geom_point(color="#FF8C00") +
  coord_fixed(xlim=c(0,1),ylim=c(0,1)) +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  paper_theme +
  labs(x="P(learned)  (Children)", y="P(learned)  (Adults)")
ggsave("figs/kid-adult_scatter.png", plot = last_plot(), width = 5, height = 4.8, units = "in", bg="white")
beta(lm(data=plot_df, mean_p_true_kid ~ mean_p_true_adult))
```


```{r}
plot_df1 <- post_monkeys %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_monkey = mean(p_true, rm.na=T)) %>% mutate(func_type_str = if_else(func_type_str=="example_line", "line", func_type_str))
plot_df2 <- post_kids %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_kid = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))
ggplot(data=plot_df%>%arrange(mean_p_true_kid), aes(x=mean_p_true_monkey, y=mean_p_true_kid)) +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  #stat_smooth(color="orange", method="lm",se=TRUE, linewidth=0.8, alpha=0.2) +
  geom_image(aes(x=mean_p_true_monkey+.05, y=mean_p_true_kid+.05, image = image_path), size=0.09) +
  geom_point(color="#FF8C00") +
  coord_fixed(xlim=c(0,1),ylim=c(0,1)) +
  scale_x_continuous(breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0, 0.5, 1)) +
  paper_theme +
  labs(x="P(learned)  (Monkeys)", y="P(learned)  (Children)")
ggsave("figs/kid-monkey_scatter.png", plot = last_plot(), width = 5, height = 4.8, units = "in", bg="white")
```
```{r}
beta(lm(data=plot_df, mean_p_true_kid ~ mean_p_true_monkey))
```
#Dif bt P_true for dif groups
```{r}
add_png_to_plot <- function(ggplot_object, data, x_loc, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.9, xmax = i+.9, ymin = -2.3, ymax = -1.9)
  }
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}

plot_df1 <- post_monkeys %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_monkey = mean(p_true, rm.na=T))
plot_df2 <- post_kids %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_kid = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

plot_df <- plot_df %>% mutate(p_true_km_dif = mean_p_true_kid - mean_p_true_monkey)
p <- ggplot(plot_df, aes(x = reorder(func_type_str, p_true_km_dif ), y = p_true_km_dif )) +
  geom_point(fill="orange2", color="orange2", shape=22, size=3) +
  #scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  coord_cartesian(clip = 'off') +
  #coord_cartesian(ylim = c(0, 1), clip = 'off') +
  #theme(legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size=12))+
  paper_theme + theme(legend.title=element_blank(), plot.margin = unit(c(15, 15, 15, 15), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="Difference in p_true\n(children - monkeys)")

fname <- "figs/p_true_km_dif.png"
add_png_to_plot(p, plot_df, 1.3,1.3,340,100, fname)
print(knitr::include_graphics(fname))
```



#same things for models
```{r}
post_lot <- read.csv('posteriors_lot.csv')
post_gpsl <- read.csv('posteriors_gpsl.csv')
post_gpnc <- read.csv('posteriors_gpnc.csv')
```

```{r}
plot_df1 <- post_adults %>% select(p_true, subject_id, guess_num, func_type_str) %>% mutate(agent="Adults") %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
plot_df2 <- post_kids %>% select(p_true, subject_id, guess_num, func_type_str) %>% mutate(agent="Children")
plot_df3 <- post_lot %>% select(p_true,  guess_num, func_type_str) %>% mutate(agent="LoT",subject_id=1) %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))
plot_df4 <- post_gpsl %>% select(p_true, guess_num, func_type_str) %>% mutate(agent="GPSL", subject_id=1) %>% mutate(func_type_str = ifelse(func_type_str == "example_line", "line", func_type_str))

post_all <- rbind(plot_df1, plot_df3, plot_df4)
```

```{r}
plot_df <- post_all
#take mean within each subj
#plot_df <- plot_df %>% group_by(func_type_str, agent, subject_id, guess_num) %>% summarize(p_true = mean(p_true, na.rm=T))

plot_df$func_type_str <- factor(plot_df$func_type_str, levels=unique(plot_df$func_type_str))
fname <- 'figs/p_true_over_time_model.png'
p.1 <- ggplot(plot_df, aes(x = guess_num, y = p_true, color=agent)) +
      #geom_line(aes(group=subject_id), alpha=0.2) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "line", size=1) +
      stat_summary(fun.data="mean_sdl", na.rm = TRUE, geom="errorbar", width=0.1) +
      coord_cartesian(xlim=c(1,15)) +
      scale_color_manual(values = c("orchid", "cornflowerblue", "darkgreen")) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func_type_str, ncol=7) +
      paper_theme + theme(legend.title=element_blank(), strip.background=element_blank(), strip.text=element_blank()) +
      labs(x="Guess number", y="p_true")
#p.1
add_png_to_facet(p.1, plot_df, "func_type_str",  1.35,.69,700/2,230/2, fname)
print(knitr::include_graphics(fname))
```

#scatter p true by func, between agent groups
```{r}
library(ggimage)
plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T))
plot_df2 <- post_gpsl %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_lot = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  #geom_point(data=plot_df, aes(x=mean_p_true_lot, y=mean_p_true_adult, color=func_type_str)) +
  geom_image(data=plot_df, aes(x=mean_p_true_lot, y=mean_p_true_adult, image = image_path), size=0.07) +
  geom_smooth(data=plot_df, aes(x=mean_p_true_lot, y=mean_p_true_adult), method = "lm", se = FALSE) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1)) +
  paper_theme +
  labs(x="p_true (GPSL)", y="p_true (Adults)")
#cor(plot_df$mean_p_true_kid, plot_df$mean_p_true_adult)
ggsave("figs/adult-gpsl_p_true_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")

```
```{r}

plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str, guess_num) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T))
plot_df2 <- post_gpnc %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str, guess_num) %>% summarize(mean_p_true_lot = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by=c("func_type_str", "guess_num"))
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

beta(lm(data=plot_df, mean_p_true_lot ~ mean_p_true_adult))
```

```{r}
plot_df1 <- post_adults %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_adult = mean(p_true, rm.na=T))
plot_df2 <- post_monkeys %>% select(p_true, guess_num, func_type_str) %>% group_by(func_type_str) %>% summarize(mean_p_true_monkey = mean(p_true, rm.na=T))
plot_df <- merge(plot_df1, plot_df2, by="func_type_str")
plot_df <- plot_df %>%
            mutate(image_path = sprintf("figs/func_ims/%s.png", func_type_str))

ggplot() +
  geom_abline(slope = 1, intercept = 0, color = "gray", linetype = "dashed") +
  geom_image(data=plot_df, aes(x=mean_p_true_monkey, y=mean_p_true_adult, image = image_path), size=0.07) +
  coord_cartesian(xlim=c(0,1),ylim=c(0,1)) +
  paper_theme + 
  labs(x="p_true (Monkeys)", y="p_true (Adults)")
#cor(plot_df$mean_p_true_kid, plot_df$mean_p_true_adult)
ggsave("figs/monkey-kid_p_true_scatter.png", plot = last_plot(), width = 15, height = 10, units = "in", bg="white")
```







#write csv
```{r}
plot_df <- post %>% filter(!(func_type_str %in% c("true", "rand")))
plot_df <- plot_df %>%
  group_by(func_type_str) %>%
  summarise(
    mean_p_true = mean(p_true),
    sd_p_true = sd(p_true) #/ sqrt(length(p_true))
  )

write.csv(post %>% filter(!(func_type_str %in% c("true", "rand"))), 'kids_p_true.csv')
write.csv(plot_df, 'kids_mean_p_true.csv')
```

#histograms of posterior means by func
```{r}

plot_df <- post %>% filter(!(func_type_str %in% c("true", "rand")))

ggplot() +
  geom_histogram(data=plot_df, aes(x=p_true, y=..density..,), binwidth=0.025,  alpha=0.9) +
  coord_cartesian(xlim = c(0, 1)) +
  theme(strip.background = element_rect(fill = "white"),legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text = element_text(size = 8), panel.background = element_rect(color="black",fill = "white"), text = element_text(size=12))+
  scale_x_continuous(breaks = seq(0,1,by=0.5)) +
  xlab("p_true (max_p*inv_logit(use_true_icpt+beta_func_type))") +
  ylab("% samples") +
  #theme(panel.background = element_rect(fill = "white"), text = element_text(size=5))+
  guides(color="none") +
  facet_wrap(~func_type_str, ncol=7, scales="free")
ggsave("figs/posts_by_func.png", plot = last_plot(), width = 10, height = 6, units = "in", bg="white")
```

#Posterior means/SDs by func
```{r}
#write.csv(post %>% filter(!(func_type_str %in% c("true", "rand"))), 'kids_p_true.csv')
#write.csv(plot_df, 'kids_mean_p_true.csv')

add_png_to_plot <- function(ggplot_object, data, x_loc, y_loc, width, height, out_file) {
  labels = ggplot_build(ggplot_object)$layout$panel_params[[1]]$x$get_labels()
  print("ok")
  for (i in seq_along(labels)) {
    facet_label <- labels[i]
    img <- readPNG(paste0("figs/func_ims/", facet_label, ".png"))
    g <- rasterGrob(img, interpolate = TRUE, width = unit(0.5, "npc"), height = unit(0.8, "npc"))
    ggplot_object <- ggplot_object + annotation_custom(g, xmin = i-.9, xmax = i+.9, ymin = -0.25, ymax = -.05)
  }
  print("ok2")
  png(filename = out_file, width = width, height = height, units = 'mm', res = 400)
  grid.draw(ggplot_object)
  dev.off()
}

plot_df <- post_all %>% filter(!(func_type_str %in% c("true", "rand"))) %>% filter(agent != "Monkeys")
plot_df <- plot_df %>%
  group_by(func_type_str, agent) %>%
  summarise(
    mean_p_true = mean(p_true),
    sd_p_true = sd(p_true),
    se_p_true = sd(p_true)/ sqrt(length(p_true))
  )


#plot_df <- plot_df[order(plot_df$mean_p_true),]
#plot_df <- factor(plot_df, levels=order(plot_df$mean_p_true))
p <- ggplot(plot_df, aes(x = reorder(func_type_str, mean_p_true), y = mean_p_true)) +
  geom_point(aes(color=agent)) +
  geom_errorbar(aes(ymin = mean_p_true - sd_p_true, ymax = mean_p_true + sd_p_true, group=agent, color=agent), width = 0) +
  scale_y_continuous(breaks = seq(0,1,by=0.5)) +
  #coord_cartesian(ylim = c(0, 1)) +
  coord_cartesian(ylim = c(0, 1), clip = 'off') +
  #theme(legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size=12))+
  paper_theme + theme(legend.title=element_blank(), plot.margin = unit(c(2, 2, 15, 2), "mm"), axis.text.x = element_blank(), strip.background=element_rect(fill="white", color="white")) +
  labs(x="", y="p_true")
#p
fname <- "figs/posteriors_adult.png"
add_png_to_plot(p, plot_df, 1.3,1.3,340,120, fname)
print(knitr::include_graphics(fname))
```

#p_true vs rel err
```{r}
post_mean_kids <- post_all %>% filter(agent=="Children") %>% group_by(subject_id, func_type_str, guess_num) %>% summarize(mean_p_true = mean(p_true, na.rm=T)) %>% ungroup() %>% group_by(guess_num, func_type_str) %>% summarize(mean_p_true = mean(mean_p_true, na.rm=T)) %>% ungroup() %>% group_by(func_type_str) %>% summarize(mean_p_true = mean(mean_p_true, na.rm=T))
```
#p_true vs accuracy
```{r}
acc <- df_kd %>% group_by(func_id, subject_id) %>% 
  
  
  
df_kid <- df %>% filter(scaled_err < 3, na.rm=TRUE) %>% rename(func_id = func.type)
df_monkey <- df_monkey %>% filter(scaled_err < 3, na.rm=TRUE)
df_adult <- df_adult %>% filter(scaled_err < 3, na.rm=TRUE)

err_mean_kids <- df_kid %>% group_by(subject_id, func_id, tpt) %>% summarize(mean_err = mean(abs_rel_err, na.rm=T), mean_acc = mean(correct, na.rm=T)) %>% ungroup() %>% group_by(tpt, func_id) %>% summarize(mean_err = mean(mean_err, na.rm=T), mean_acc = mean(mean_acc, na.rm=T)) %>% ungroup() %>% group_by(func_id) %>% summarize(mean_err = mean(mean_err, na.rm=T), mean_acc = mean(mean_acc, na.rm=T))

err_mean_kids <- err_mean_kids %>% rename(func_type_str = func_id)
#plot_df <- merge(err_mean_kids, post_mean_kids, by="func_type_str")
```

```{r}
ggplot(data=plot_df, aes(x=mean_p_true, y=mean_err)) +
  geom_text(aes(label=func_type_str)) +
  geom_abline(linetype="dotted") +
  stat_smooth(method="lm",se=TRUE,alpha=0.1) +
  geom_point()
beta(lm(data=plot_df, mean_p_true ~ mean_err))
```

###mean accuracy csv
```{r}
plot_df <- df
plot_df$accuracy <- as.numeric(plot_df$success=='True')
plot_df <- plot_df %>% filter(tpt>=3)
plot_df <- plot_df %>%
  group_by(func.type, tpt) %>%
  summarise(
    mean_accuracy = mean(accuracy)
  )
write.csv(plot_df, 'mean_accuracy.csv')
```


###Rel err over time by func
```{r}
#plot_df <- df
#fname <- "figs/rel_err_kids.png"
#c <- "dodgerblue"

#plot_df <- df_adult
#fname <- "figs/rel_err_adults.png"
#c <- "chartreuse3"

plot_df <- df_monkey
fname <- "figs/rel_err_monkeys.png"
c <- "orchid3"
plot_df$func.type <- factor(plot_df$func.type, levels=unique(plot_df$func.type))
p.1 <- ggplot(plot_df, aes(x = tpt, y = abs_rel_err)) +
      stat_summary(fun = "mean", na.rm = TRUE, geom = "point", color=c, size=2) +
      stat_summary(fun.data="mean_se", na.rm = TRUE, geom="errorbar", width=0.1,  color=c) +
      coord_cartesian(xlim=c(1,15)) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func.type, ncol=7) +
      paper_theme + theme(legend.title=element_blank(), strip.background=element_rect(fill="white", color="white"), strip.text=element_blank()) +
      labs(x="Timepoint", y="Relative error")
add_png_to_facet(p.1, plot_df, "func.type",  1.35,1.3,700,230, fname)
p.1
```


```{r}
#plot_df <- df
#fname <- "figs/accuracy_kids.png"
#c <- "dodgerblue"

#plot_df <- df_adult
#fname <- "figs/accuracy_adults.png"
#c <- "chartreuse3"

plot_df <- df_monkey
fname <- "figs/accuracy_monkeys.png"
c <- "orchid3"

plot_df$success <- as.numeric(plot_df$success=='True')
plot_df$func.type <- factor(plot_df$func.type, levels=unique(plot_df$func.type))
p.1 <- ggplot(plot_df%>%filter(tpt>=3), aes(x = tpt, y = success)) +
      stat_summary(fun = "mean", geom = "point", color=c, size=2) +
      #stat_summary(fun = "mean", geom = "line", color="dodgerblue", size=0.5, alpha=0.5) +
      stat_summary(fun.data="mean_se",geom="errorbar", width=0.1,  color=c) +
      coord_cartesian(xlim=c(1,15)) +
      scale_x_continuous(breaks = seq(0,15,by=5)) +
      facet_wrap(~func.type, ncol=7) +
      paper_theme + theme(legend.title=element_blank(), strip.background=element_rect(fill="white", color="white"), strip.text=element_blank()) +
      labs(x="Timepoint", y="Accuracy")
add_png_to_facet(p.1, plot_df, "func.type", 1.35,0.69,700,230, fname)
p.1
```


Analyses on individual kids:
```{r}
plot_df <- post %>% filter(!(func_type_str %in% c("true", "rand")))

ggplot() +
  geom_histogram(data=plot_df, aes(x=p_true, y=..density.., fill=subject_id), binwidth=0.025,  alpha=0.9) +
  coord_cartesian(xlim = c(0, 1)) +
  theme(strip.background = element_rect(fill = "white"),legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text = element_text(size = 8), panel.background = element_rect(color="black",fill = "white"), text = element_text(size=12))+
  scale_x_continuous(breaks = seq(0,1,by=0.5)) +
  xlab("p_true (max_p*inv_logit(use_true_icpt))") +
  ylab("% samples") +
  #theme(panel.background = element_rect(fill = "white"), text = element_text(size=5))+
  guides(color="none") +
  facet_wrap(~subject_id, ncol=8, scales="free")
ggsave("figs/posts_by_kid.png", plot = last_plot(), width = 10, height = 6, units = "in", bg="white")
```

```{r}
#plot means by kid
p_true_means <- post_by_kid %>%
  group_by(subject_id, func_type_str) %>%
  summarize(p_true_mean = mean(p_true)) %>%
  ungroup()

plot_df <- p_true_means %>% filter(!(func_type_str %in% c("true", "rand")))

ggplot() +
  geom_histogram(data=plot_df, aes(x=p_true_mean), binwidth=0.1, fill="cornflowerblue") +
  theme( strip.background = element_rect(fill = "white"), legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text = element_text(size = 8), panel.background = element_rect(), text = element_text(size=12))+
  xlab("Mean p_true by subject") +
  ylab("Count") +
  coord_cartesian(xlim = c(0, 1)) +
  scale_x_continuous(breaks = seq(0,1,by=0.5)) +
  facet_wrap(~func_type_str, ncol=7, scales="free")
ggsave("figs/post_means.png", plot = last_plot(), width = 10, height = 6, units = "in", bg="white")
```

```{r}
ggplot(post_by_kid, aes(x = p_true, y=identity)) +
  stat_summary(fun = "mean", geom = "bar") +
  xlab("Posterior means, by subject")
```

Some other analyses:
```{r}
#rel error over time by function, with mean and ind. kids shown
ggplot(df, aes(x = tpt, y = abs_rel_err, color = subject_id)) +
  coord_cartesian(ylim=c(0,10)) + 
  geom_line(alpha = 0.6) +  # Faint lines for individual subjects
  stat_summary(fun = "mean", geom = "line", aes(group = 1), color = "black", linewidth = .5) +
  theme(legend.title=element_blank(), legend.text=element_blank(), legend.position = "none", axis.text = element_text(size =   8),  text = element_text(size=12))+
  ylab("Absolute relative error") +
  xlab("Timepoint") +
  facet_wrap(~func.type, ncol=7)

ggsave("figs/err.png", plot = last_plot(), width = 10, height = 6, units = "in", bg="white")
#ggplot() +
#  geom_line()
#  geom_histogram(data=df, aes(x=)), binwidth=0.025) +
#  theme(panel.background = element_rect(fill = "white"), text = element_text(size=5))+
#  facet_wrap(~func_type_str)
```

Probably useless shit
```{r}
post_by_kid <- data.frame()
for(i in seq_along(unique(df$subject_id))) {
  cat(sprintf("subj: %s / %s", i, length(unique(df$subject_id))))
  kid <- unique(df$subject_id)[i]
  df_kid <- df %>% filter(subject_id==kid)
  stan_df <- get_stan_df(df_kid)
  func_str_to_num <- setNames(as.numeric(factor(unique(stan_df$func.type))), unique(stan_df$func.type))
  print(func_str_to_num)
  posterior_samples <- get_posterior(stan_df, 10000, func_str_to_num)
  post <- refactor_posterior(posterior_samples, func_str_to_num)
  post$subject_id = kid
  post_by_kid <- bind_rows(post_by_kid, post)
}
#write.csv(post_by_kid, 'posteriors_by_subj.csv')
```
```{r}
for (tp in unique(df$func.type)) {
  p <- ggplot() +
    geom_point(data=df%>%filter(func.type==tp), aes(x=x_curr, y=y_curr, alpha=tpt, fill=tpt),size=15,shape=21) +
    geom_path(data=df%>%filter(func.type==tp), aes(x=x_curr, y=y_curr, alpha=tpt),size=3) + 
    theme_void() + theme(legend.title=element_blank(),plot.background = element_rect(color = "black", size=2),legend.position="none", strip.background=element_rect(fill="white", color="white"), strip.text=element_text(color="black"), plot.margin = margin(30, 30, 30, 30) ) +
    scale_fill_gradient(low = "white", high = "black")
 ggsave(sprintf("figs/func_ims/%s.png", tp), plot = p, width = 6, height = 6, units = "in", bg="white")
}
#save to func_ims

```
```{r}
#o <- opt(stan_df)
#o_w_age <- opt_w_age(stan_df)
```

#validate model
```{r}
#should we include param for trial num?
library(bayesplot)
pp_check(fit, y="pred_x", nreps = 1000)

#stan_model(your_stan_code)
#check_divergences(your_stan_model_fit)

#stan_summary(your_stan_model_fit)

#library(loo)
#loo(your_stan_model_fit)
#loo_compare(your_stan_model_fit, alternative_stan_model_fit)
```

```{r}
ggplot() +
  geom_point(data=stan_df, aes(x=x_curr, y=y_curr, alpha=tpt+1), size=3) +
  geom_point(data=stan_df_monkey, aes(x=x_curr, y=y_curr, alpha=tpt+1), color='green', size=1) +
  geom_path(data=stan_df, aes(x=x_curr, y=y_curr, alpha=tpt+1), linetype="solid") +
  #geom_rect(data=stan_df, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="blue", fill="white", alpha=0.5) +
  #geom_point(data=df_adult, aes(x=x_pred, y=y_pred), color = "cyan", size=.2, alpha=0.5) +
  geom_point(data=stan_df, aes(x=x_pred, y=y_pred), color = "pink", size=.2, alpha=0.8) +
  #geom_point(data=df_monkey, aes(x=x_curr, y=y_curr), color = "green", size=.2, alpha=0.5) +
  #geom_point(data=df_monkey, aes(x=x_pred, y=y_pred), color = "gold", size=.2, alpha=0.5) +
  #geom_rect(data=df_monkey, aes(xmin=min_x, xmax=max_x, ymin=min_y, ymax=max_y), color="gold", fill=NA, alpha=0.5) +
  theme_void() + theme(legend.title=element_blank(), legend.text=element_blank(), panel.background = element_rect(fill = "white"))+
  guides(color="none", alpha="none") +
  facet_wrap(~func.type)
```
