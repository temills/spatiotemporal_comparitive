---
title: "model comparison"
output: html_document
---

```{r, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=4, fig.height=3,fig.align = "center",cache=TRUE)
library(ggplot2)
library(reshape)
library(grid)
library(purrr)
library(extrafont)
library(dplyr)
library(RColorBrewer)
library(robustbase)
library(tidyr)
library(gridExtra)
library(ggstar)
library(patchwork)
library(readr)
library(knitr)
library(ggbeeswarm)
library(cowplot)
library(boot)
library(sysfonts)
font_add("Georgia", "Georgia.ttf")


paper_theme <- theme_light() + theme(
    axis.text.x=element_text(colour="#292929", size = 14), 
    axis.title.x = element_text(size=18, family="Georgia"),
    axis.title.y = element_text(size = 18, vjust = 1,  family="Georgia"),
    axis.text.y  = element_text(size = 14, colour="#292929", family="Georgia"),
    strip.text=element_text(size=16,color="black", family="Georgia"),
    strip.background = element_rect(colour = "grey50", fill = "white"),
    panel.background = element_rect(fill = "white", colour = "grey50"),
    axis.ticks.x=element_blank(),axis.ticks.y=element_blank(),
    axis.line.x = element_line(colour = "black"), 
    axis.line.y = element_line(colour = "black"),
    legend.title=element_text(size=18, family="Georgia"),
    legend.text=element_text(size=15, family="Georgia"),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank())

format_num <- function(x) {
  return(sprintf("%.2f", round(x, 2)))
}

logsumexp <- function(x) {
  max_x <- max(x)
  max_x + log(sum(exp(x - max_x)))
}

data_dir <- "data/"
preprocessed_data_dir <- "preprocessed_data/"
fig_dir <- "figs/"
```

# Analyze fits
```{r}
read_model_fit_data <- function(participant) {
  path <- "model_fits/"
  models = c("lot","linear", "gp", "comp_gp", "ridge", "linear_or_prev", "lot_nonrecursive", "transformer_2", "transformer_3", "transformer_13") 
  df <- data.frame()
  for (i in seq_along(models)) {
    model_name <- models[i]
    file <- paste0(preprocessed_data_dir, "model_likelihoods/", model_name, "_", participant, ".csv")
    df <- bind_rows(df, read.csv(file) %>% mutate(model=model_name)) %>% filter(!(is.na(LL)))
  }
  return(df)
}

df_kid <- read_model_fit_data("kids")  %>%
          group_by(subj_id) %>%
          mutate(n_func = length(unique(func.name)),
                 agent=paste0(as.character(age), " y/o"),
                 r_id=as.character(r_id))

df_adult <- read_model_fit_data("adults") %>%
            mutate(agent="Adults", r_id=as.character(r_id))

df_monkey <- read_model_fit_data("monkeys") %>%
             mutate(agent="Monkeys",
                    r_id=as.character(r_id))

```

# Combine data
```{r}
df_all <- bind_rows(df_adult, df_kid, df_monkey) %>%
          mutate(model = ifelse(model=="comp_gp", "Comp. GP", model),
                  model = ifelse(model=="gp", "GP", model),
                  model = ifelse(model=="linear", "Linear", model),
                  model = ifelse(model=="ridge", "Polynomial", model),
                  model = ifelse(model=="lot", "LoT", model),
                  model = ifelse(model=="linear_or_prev", "Linear + Prev.", model),
                  model = ifelse(model=="lot_nonrecursive", "Nonrecursive LoT", model),
                  model = ifelse(model=="transformer_2", "Transformer (2)", model),
                  model = ifelse(model=="transformer_3", "Transformer (3)", model),
                  model = ifelse(model=="transformer_13", "Transformer (13)", model))

df_all_nonrecursive <- df_all %>% 
                      filter(!(model %in% c("Transformer (2)", "Transformer (3)", "Transformer (13)")))
df_all_nonrecursive$model = factor(df_all_nonrecursive$model,
                                   levels = c("Linear", "Linear + Prev.",  "Polynomial",  "GP",  "Comp. GP", "LoT", "Nonrecursive LoT")) #Transformer (2)", "Transformer (3)", "Transformer (13)")) 

df_all_transformer <- df_all %>%
                      filter(model != "Nonrecursive LoT") %>% 
                      filter(!(func.name %in% c("123", "decreasing_y", "radial_increasing")))
df_all_transformer$model = factor(df_all_transformer$model, levels = c("Linear", "Linear + Prev.",  "Polynomial",  "GP",  "Comp. GP", "LoT", "Transformer (2)", "Transformer (3)", "Transformer (13)"))

df_all <- df_all %>% 
          filter(!(model %in% c("Transformer (2)", "Transformer (3)", "Transformer (13)", "Nonrecursive LoT")))
df_all$model = factor(df_all$model, levels = c("Linear", "Linear + Prev.",  "Polynomial",  "GP",  "Comp. GP", "LoT"))

```

# Likelihood and parameter table
```{r}
# Bootstrapping over all data

compute_top_model <- function(df) {
  res_df <- df %>% 
            group_by(agent, model, subj_id, r_id, func.name) %>%
            mutate(func_LL = sum(LL, na.rm = TRUE)) %>%
            group_by(agent, model, subj_id, func.name) %>%
            mutate(mean_LL = mean(func_LL)) %>%
            group_by(agent, model, func.name) %>%
            mutate(mean_LL = mean(mean_LL)) %>%
            group_by(agent, model) %>%
            mutate(mean_LL=mean(mean_LL)) %>%
            group_by(agent, subj_id, r_id, func.name, tpt) %>%
            mutate(is_top_model = mean_LL == max(mean_LL)) %>%
            ungroup()
  return(res_df)
}

compute_ll_diffs <- function(df) {
  model_means <- df %>%
                 group_by(agent, model, subj_id, r_id, func.name, is_top_model) %>%
                 summarize(func_LL = sum(LL, na.rm = TRUE), .groups="drop") %>%
                 group_by(agent, model, subj_id, func.name, is_top_model) %>%
                 summarize(LL = mean(func_LL), .groups="drop") %>%
                 group_by(agent, model, func.name, is_top_model) %>%
                 summarize(LL = mean(LL), .groups="drop") %>%
                 group_by(agent, model, is_top_model) %>%
                 summarize(mean_LL=mean(LL), .groups="drop")
  
  res_df <- model_means %>%
            group_by(agent, model) %>%
            mutate(mean_LL_top = ifelse(is_top_model, mean_LL, NA)) %>%
            group_by(agent) %>%
            mutate(mean_LL_top = mean(mean_LL_top, na.rm=T)) %>%
            mutate(diff_from_top = mean_LL - mean_LL_top)
  return (res_df)
}

resample_by_id <- function(data) {
  ids <- unique(data$data_id)
  boot_ids <- sample(ids, size = length(ids), replace = TRUE)
  return(data %>% semi_join(tibble(data_id = boot_ids), by = "data_id"))
}



set.seed(123)
n_boot <- 1000

boot_df <- df_all %>% 
           compute_top_model() %>%
           mutate(data_id = paste0(agent, "_", subj_id, "_", r_id, "_", func.name, "_", tpt))

boot_diffs <- map_dfr(1:n_boot, ~{
  resampled <- boot_df %>%
               resample_by_id()
  res_df <- resampled %>%
            compute_ll_diffs() %>%
            mutate(boot = .x)
  return(res_df)
})


ci_summary <- boot_diffs %>%
              group_by(model, agent) %>%
              summarise(
                lower_LL = quantile(mean_LL, 0.025),
                upper_LL = quantile(mean_LL, 0.975),
                mean_LL = mean(mean_LL)
              ) 

# Compute mean parameter estimates
mean_param_df <- df_all %>%
                 distinct(model, agent, subj_id, p_lapse, sd_motor, sd_prev, p_prev, p_rand) %>%
                 group_by(agent, model) %>%
                 summarize(p_lapse=mean(p_lapse),
                           sd_motor=mean(sd_motor),
                           sd_prev=mean(sd_prev),
                           p_prev=mean(p_prev),
                           p_rand=mean(p_rand))


table_df <- merge(ci_summary, mean_param_df, by=c("model", "agent")) %>%
            mutate(mean_LL=format_num(mean_LL), lower_LL=format_num(lower_LL), upper_LL=format_num(upper_LL),
                   p_lapse=format_num(p_lapse), sd_motor=format_num(sd_motor), sd_prev=format_num(sd_prev),
                   p_prev=format_num(p_prev), p_rand=format_num(p_rand))
```

```{r}
# Monkeys
monkey_table_df <- table_df %>%
       filter(agent=="Monkeys") %>%
       select(c("model", "sd_motor", "p_prev", "sd_prev", "p_rand", "lower_LL", "upper_LL", "mean_LL")) %>%
       arrange(factor(model, levels = c("LoT", "Comp. GP", "GP", "Polynomial", "Linear + Prev.", "Linear")))
cat(kable(monkey_table_df, format = "latex", booktabs = TRUE, escape = FALSE))
```

```{r}
# Adults
adult_table_df <- table_df %>%
       filter(agent=="Adults") %>%
       select(c("model", "sd_motor", "p_prev", "sd_prev", "p_rand", "lower_LL", "upper_LL", "mean_LL")) %>%
       arrange(factor(model, levels = c("LoT", "Comp. GP", "GP", "Polynomial", "Linear + Prev.", "Linear")))
cat(kable(adult_table_df, format = "latex", booktabs = TRUE, escape = FALSE)) 
```

```{r}
kids_table_df <- table_df %>%
       filter(grepl("y/o",agent)) %>%
       mutate(Age = substr(agent, 1, 1)) %>%
       select(c("model", "Age", "sd_motor", "p_prev", "sd_prev", "p_rand", "lower_LL", "upper_LL", "mean_LL")) %>%
       arrange(factor(model, levels = c("LoT", "Comp. GP", "GP", "Polynomial", "Linear + Prev.", "Linear"))) %>%
       arrange(factor(Age)) 

cat(kable(kids_table_df, format = "latex", booktabs = TRUE, escape = FALSE))
```

```{r}
top_model_df <- df_all %>%
                group_by(agent, model, subj_id, r_id, func.name) %>%
                summarize(func_LL = sum(LL, na.rm = TRUE),
                          p_lapse=mean(p_lapse),
                          sd_motor=mean(sd_motor),
                          sd_prev=mean(sd_prev),
                          p_prev=mean(p_prev),
                          p_rand=mean(p_rand),
                          .groups="drop") %>%
                group_by(agent, model, subj_id) %>%
                summarize(LL = mean(func_LL, na.rm=TRUE),
                          p_lapse=mean(p_lapse),
                          sd_motor=mean(sd_motor),
                          sd_prev=mean(sd_prev),
                          p_prev=mean(p_prev),
                          p_rand=mean(p_rand),
                          .groups="drop") %>%
                group_by(agent, subj_id) %>%
                slice_max(LL) %>%
                ungroup()


top_model_param_table_df <- top_model_df %>%
                            group_by(agent) %>%
                            summarize(p_lapse=format_num(mean(p_lapse)),
                                      sd_motor=format_num(mean(sd_motor)),
                                      sd_prev=format_num(mean(sd_prev)),
                                      p_prev=format_num(mean(p_prev)),
                                      p_rand=format_num(mean(p_rand))) %>%
                            select(c("agent", "sd_motor", "p_prev", "sd_prev", "p_rand")) %>%
                            arrange(factor(agent, levels=c("Monkeys", "3 y/o", "4 y/o", "5 y/o", "6 y/o", "7 y/o", "Adults")))
cat(kable(top_model_param_table_df, format = "latex", booktabs = TRUE, escape = FALSE))

```

```{r}
top_model_count_df <- top_model_df %>%
                      group_by(agent, model) %>%
                      summarize(model_count=n()) %>%
                      ungroup() %>%
                      complete(agent, model, fill = list(model_count = 0)) %>%
                      group_by(agent) %>%
                      mutate(tot = sum(model_count),
                             model_prop = model_count / tot) %>%
                      ungroup()
print(top_model_count_df)
```

# Visualize likelihood results
# LL boxplots
```{r, fig.width=10, fig.height=4}
make_boxplot <- function(df_all, colormap) {
  df_LL <- df_all %>%
            group_by(agent, model, subj_id, r_id, func.name) %>%
            summarize(func_LL = sum(LL, na.rm = TRUE), .groups="drop") %>%
            group_by(agent, model, subj_id, func.name) %>%
            summarize(LL = mean(func_LL), .groups="drop") %>%
            group_by(agent, model, func.name) %>%
            summarize(LL = mean(LL), .groups="drop") 
  
  df_LL$agent <- factor(df_LL$agent, levels=c("Monkeys", "3 y/o", "4 y/o", "5 y/o", "6 y/o", "7 y/o", "Adults"))

  # or baseline
  p <- ggplot(data=df_LL) +
    geom_boxplot(aes(x=agent, y=LL, fill=model), outliers=F) +
    scale_fill_manual(values = colormap) +
    ylab("Log likelihood") +
    paper_theme + 
    theme(
      axis.title.x = element_blank(),
      legend.title=element_blank()
    )
  return(p)
}
```

# Top model barplot
```{r}
make_barplot <- function(df_all, colormap) {
  # top models by subj
  df_top <- df_all %>%
    group_by(agent, model, subj_id, r_id, func.name) %>%
    summarize(func_LL = sum(LL, na.rm = TRUE), .groups="drop") %>%
    group_by(agent, model, subj_id) %>%
    summarize(LL = mean(func_LL, na.rm=TRUE), .groups="drop") %>%
    group_by(agent, subj_id) %>%
    slice_max(LL) %>%
    ungroup() %>%
    group_by(agent, model) %>%
    summarize(model_count=n()) %>%
    ungroup() %>%
    complete(agent, model, fill = list(model_count = 0)) %>%
    group_by(agent) %>%
    mutate(tot = sum(model_count),
           model_prop = model_count / tot) %>%
    ungroup()

  df_top$agent <- factor(df_top$agent, levels=c("Monkeys", "3 y/o", "4 y/o", "5 y/o", "6 y/o", "7 y/o", "Adults"))
    
  p <- ggplot(data=df_top) +
    geom_bar(aes(x=agent, y = model_prop, fill=model), color="black", stat="identity") +
    scale_fill_manual(values = colormap) +
    scale_x_discrete(labels = function(x) {
      paste0(x, "\nn=", df_top$tot[match(x, df_top$agent)])
    }) +
    scale_y_continuous(breaks = seq(0, 1, by = 0.5)) +
    paper_theme +
    ylab("Prop. participants") +
    theme(axis.title.x = element_blank(),
          legend.title=element_blank())

  return(p)
}

```

# Model example predictions
```{r, fig.height=8,fig.width=8}
make_extended_prediction_plot <- function(colormap) {
  preprocess_model_extended <- function(df) {
    df <- df %>%
          group_by(curr_tpt, prediction_tpt, seq_id) %>%
          mutate(norm = logsumexp(score)) %>%
          ungroup() %>%
          mutate(posterior = exp(score - norm))  %>%
          group_by(curr_tpt, prediction_tpt, seq_id) %>%
          mutate(r = rank(desc(posterior))) %>%
          ungroup() %>%
          rename(func.name=seq_id)
  }
  df_gpnc <- preprocess_model_extended(read.csv(paste0(data_dir, 'models/extended_predictions/gp_extended.csv'))) %>%
             mutate(model="GP") %>%
             mutate(func=paste0(func_x, "\n", func_y))
  df_lot <- preprocess_model_extended(read.csv(paste0(data_dir, 'models/extended_predictions/lot_extended.csv'))) %>% mutate(model="LoT")
  df_lin <- preprocess_model_extended(read.csv(paste0(data_dir, 'models/extended_predictions/linear_extended.csv'))) %>% mutate(model="Linear")
  df_stimuli <- read.csv(paste0(data_dir, 'stimuli.csv')) %>% rename(func.name=seq_id)
  bounds_df <- read.csv(paste0(data_dir,'participants/adults.csv')) %>%
               rename(func.name=seq_id) %>%
               group_by(func.name) %>%
               summarize(min_x=mean(min_x, na.rm=T),
                         max_x=mean(max_x, na.rm=T),
                         min_y=mean(min_y, na.rm=T),
                         max_y=mean(max_y, na.rm=T),
                         .groups="drop")
  df_stim <- df_stimuli %>%
             merge(bounds_df, by="func.name") %>%
             mutate(scale_by = (max_x-min_x)) %>%
             mutate(true_x = (true_x-min_x)/scale_by) %>%
             mutate(true_y = (true_y-min_y)/scale_by)

  df_model <- bind_rows(bind_rows(df_lot, df_gpnc), df_lin) %>%
              mutate(hyp=func) %>%
              merge(bounds_df, by="func.name") %>%
              mutate(scale_by = (max_x-min_x)) %>%
              mutate(pred_x = (pred_x-min_x)/scale_by) %>%
              mutate(pred_y = (pred_y-min_y)/scale_by) %>%
              mutate(true_x = (true_x-min_x)/scale_by) %>%
              mutate(true_y = (true_y-min_y)/scale_by)
  # custom shift and scale
  s <- 0.85
  df_model <- df_model %>%
              mutate(pred_y = ifelse(func.name=="zigzag_1", pred_y-0.15, pred_y),
                     true_y = ifelse(func.name=="zigzag_1", true_y-0.15, true_y),
                     pred_x = ifelse(func.name=="zigzag_1", pred_x-.1, pred_x),
                     true_x = ifelse(func.name=="zigzag_1", true_x-.1, true_x),
                     pred_x = ifelse(func.name=="stairs_2", pred_x+0.1, pred_x),
                     true_x = ifelse(func.name=="stairs_2", true_x+0.1, true_x),
                     pred_y = ifelse(func.name=="stairs_2", pred_y-0.05, pred_y),
                     true_y = ifelse(func.name=="stairs_2", true_y-0.05, true_y),
                     pred_y = ifelse(func.name=="plus", pred_y*s, pred_y),
                     true_y = ifelse(func.name=="plus", true_y*s, true_y),
                     pred_x = ifelse(func.name=="plus", pred_x*s, pred_x),
                     true_x = ifelse(func.name=="plus", true_x*s, true_x),
                     pred_y = ifelse(func.name=="plus", pred_y-.03, pred_y),
                     true_y = ifelse(func.name=="plus", true_y-.03, true_y))
  df_stim <- df_stim %>%
             mutate(true_y = ifelse(func.name=="zigzag_1", true_y-0.15, true_y),
                    true_x = ifelse(func.name=="zigzag_1", true_x-0.1, true_x),
                    true_x = ifelse(func.name=="stairs_2", true_x+0.1, true_x),
                    true_y = ifelse(func.name=="stairs_2", true_y-0.05, true_y),
                    true_y = ifelse(func.name=="plus", true_y*s, true_y),
                    true_x = ifelse(func.name=="plus", true_x*s, true_x),
                    true_y = ifelse(func.name=="plus", true_y-0.03, true_y))
  
  
  df_model <- df_model %>%
              mutate(hyp = ifelse(func.name=="zigzag_1",
                                  ifelse(model=="LoT", "repeat(move(), 2);\nreflect()\n", #"repeat(move(s=1), 2);\nturn(dθ=-134°)\n",
                                         ifelse(model=="GP",
                                                "kx=Linear(0.47, 1)\nky=Periodic(0.93, 0.48, 1)\n",
                                                ifelse(model=="Linear", "move(θ=248°, s=1.02)\n\n", NA))), hyp)) %>%
              mutate(hyp = ifelse(func.name=="plus",
                                  ifelse(model=="LoT", "turn(dθ=270°);\nsubprogram(repeat(move(), 2));\nstay()",
                                         ifelse(model=="GP",
                                                "kx=Periodic(0.78, 0.84, 1)\nky=Periodic(0.5, 0.15, 1)\n",
                                                ifelse(model=="Linear", "move(θ=0°, s=0.64)\n\n", NA))), hyp)) %>%
              mutate(hyp = ifelse(func.name=="stairs_2",
                                  ifelse(model=="LoT", "repeat(move(θ=0°), 2);\nmove(dy=-1.55)\n",
                                         ifelse(model=="GP",
                                                "kx=Periodic(0.97, 0.96, 1)\nky=RBF(0.37, 1)\n",
                                                ifelse(model=="Linear", "move(θ=346°, s=0.63)\n\n", NA))), hyp))
             
          
  n_extended = 10
  get_df_path <- function(seq, t, selected_particles) {
      df_model_path <- df_model %>%
                group_by(func.name, curr_tpt, model) %>%
                mutate(selected_particle = ifelse(model=="GP", selected_particles[1],
                                                  ifelse(model=="Linear", selected_particles[2],
                                                         selected_particles[3]))) %>%
                filter(r==selected_particle) %>%
                filter(func.name==seq)  %>% 
                filter(curr_tpt == t) %>%
                filter(prediction_tpt >= curr_tpt-1) %>%
                filter(prediction_tpt <= curr_tpt+n_extended) %>%
                group_by(model) %>%
                mutate(pred_x = ifelse(prediction_tpt==curr_tpt-1, true_x, pred_x)) %>%
                mutate(pred_y = ifelse(prediction_tpt==curr_tpt-1, true_y, pred_y))  %>%
                ungroup()
      
      return(df_model_path)
  }

  get_df_points <- function(seq, t, selected_particles) {
      df_model_points <- df_model %>%
                group_by(func.name, curr_tpt, model) %>%
                mutate(selected_particle = ifelse(model=="GP", selected_particles[1],
                                                  ifelse(model=="Linear", selected_particles[2],
                                                         selected_particles[3]))) %>%
                filter(r==selected_particle) %>%
                mutate(model = factor(model, levels=c("Linear", "GP", "LoT"))) %>%
                filter(func.name==seq) %>% 
                filter(curr_tpt == t) %>%
                filter(prediction_tpt >= curr_tpt) %>%
                filter(prediction_tpt <= curr_tpt+n_extended) 
      return(df_model_points)
      
  }

  get_df_true <- function(seq, t, selected_particles) {
    df_true <- df_stim %>%
               filter(func.name==seq) %>%
               filter(tpt<t) %>%
               mutate(max_tpt=t-1)
    return (df_true)
  } 
      

  plot_extended_predictions <- function(df_model_path, df_model_points, df_true) {
      x_min = min(min(df_true$true_x), min(df_model_points$pred_x)) -.02
      y_min = min(min(-(df_true$true_y)), min(-(df_model_points$pred_y)))
  
      p <- ggplot() +
          # True pattern
          geom_path(data=df_true, aes(x=true_x, y=-true_y), linetype="dotted", linewidth=0.8) +
          geom_point(data=df_true %>% filter(tpt < max_tpt), aes(x=true_x, y=-true_y, alpha=tpt), size=2.5) +
          geom_star(data=df_true %>% filter(tpt == max_tpt), aes(x=true_x, y=-true_y),size = 2.5,starshape = 1, fill="black") +
          scale_alpha_continuous(range = c(0.3, 1)) +
          # Predicted patterns
          geom_path(data=df_model_path%>%filter(prediction_tpt<=curr_tpt),
                    aes(x=pred_x, y=-pred_y, group=model, color=model),
                    linetype="solid", alpha=0.9, linewidth=0.8) +
          geom_path(data=df_model_path, aes(x=pred_x, y=-pred_y, group=model, color=model), 
                     linetype="solid", alpha=0.6, linewidth=0.8) +
          geom_point(data=df_model_points %>% filter(prediction_tpt<=curr_tpt),
                     aes(x=pred_x, y=-pred_y, group=model, color=model),
                     size=2.5, alpha=0.9) +
          geom_point(data=df_model_points,
                     aes(x=pred_x, y=-pred_y, group=model, color=model),
                     size=2.5, alpha=0.6) +
          geom_text(data=df_model_points,
                      aes(x = x_min, y = Inf, label = hyp),
                      size=3.65,
                      hjust = 0, vjust = 1.1,
                      nudge_x = -0.02) +
  
          scale_color_manual(values = colormap,
                             limits = c("LoT", "GP", "Linear"),
                             labels = c( "LoT" = "LoT", "GP" = "GP","Linear" = "Linear")) +
  
          paper_theme +
          theme(legend.title=element_blank(),
                axis.title.x = element_blank(),
                axis.title.y = element_blank(),
                axis.text.x = element_blank(),
                axis.text.y = element_blank(),
                panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
                strip.text.y.right = element_blank()
                ) +
          
          guides(alpha="none",
                 color = "none",
                 shape = "none") +
          facet_grid(rows = vars(func.name), cols = vars(model)) +
          coord_fixed(ratio=1,
                      xlim=c(x_min, 0.8),
                      ylim=c(-0.45, 0.05))
                      #ylim=c(y_min, 0.6))
      print(y_min)
      return(p)
  }
  
  arg_list <- list(list("stairs_2", 5, list(8,1,1)),
                   list("plus", 6, list(2,9,3)),
                   list("zigzag_1", 5, list(3,3,1))
                   )
  
  df_model_path <- data.frame()
  df_model_points <- data.frame()
  df_true <- data.frame()
  for (arg in arg_list) {
    df_model_path <- df_model_path %>%
                    bind_rows(do.call(get_df_path, arg))
    df_model_points <- df_model_points %>%
                    bind_rows(do.call(get_df_points, arg))
    df_true <- df_true %>%
                    bind_rows(do.call(get_df_true, arg))
  }
  model_levels <- c("Linear", "GP", "LoT")
  seq_levels <- c("zigzag_1", "stairs_2", "plus")
  
  df_true <- df_true %>% crossing(model = factor(model_levels, levels = model_levels)) %>% arrange(tpt)
  df_model_path$model = factor(df_model_path$model, levels=model_levels)
  df_model_points$model = factor(df_model_points$model, levels=model_levels)
  df_true$func.name = factor(df_true$func.name, levels=seq_levels)
  df_model_points$func.name = factor(df_model_points$func.name, levels=seq_levels)
  df_model_path$func.name = factor(df_model_path$func.name, levels=seq_levels)
  
  p <- plot_extended_predictions(df_model_path, df_model_points, df_true)
  return(p)
}

```

```{r}
# Combine plots
make_main_fig <- function(df_all, colormap) {
  p1 <- make_extended_prediction_plot(colormap)
  p2 <- make_boxplot(df_all, colormap)
  p3 <- make_barplot(df_all, colormap)

  legend <- cowplot::get_legend(p3 +
                              guides(fill = guide_legend(nrow = 3)) +
                              theme(legend.position = "right",
                                    legend.title = element_blank(),
                                    legend.text = element_text(
                                    size = 14,
                                    margin = margin(r = 15, l=5))))
  title_a <- ggdraw() + 
    draw_label("A) Example model predictions", fontfamily = "Georgia", size = 24, hjust = -0.1, x = 0)
  
  title_b <- ggdraw() + 
    draw_label("B) Model log likelihoods", fontfamily = "Georgia", size = 24, hjust = 0, x = 0)
  
  title_and_legend <- plot_grid(
    title_b, 
    ggdraw(legend), 
    nrow = 1, 
    rel_widths = c(1, 0.8),
    align = "v"
  )
  
  top <- plot_grid(
    title_a, 
    title_and_legend, 
    nrow = 1, 
    rel_widths = c(1, 1)
  )
  
  p1_nolabel <- p1 + theme(plot.title = element_blank(), plot.margin = margin(b=20))
  p2_nolabel <- p2 + theme(plot.title = element_blank(), axis.title.y=element_text(margin=margin(r=10))) + guides(fill="none")
  p3_nolabel <- p3 +
                ggtitle("C) Best fitting models") +
                theme(axis.title.y=element_text(margin=margin(r=5)),
                      plot.title = element_text(size = 24, family="Georgia",  hjust = -0.18, margin=margin(b=20, t=10))) +
                guides(fill="none")

  bottom <- plot_grid(
    p1_nolabel, 
    plot_grid(p2_nolabel, p3_nolabel, ncol = 1, rel_heights=c(1,1.2)), 
    rel_widths = c(1, 1)
  )
  
  final_plot <- plot_grid(
    top,
    bottom,
    ncol = 1,
    rel_heights = c(0.15, 1)  # adjust as needed
  )
  return(final_plot)
}

colormap <-  c(
      "LoT"    =  "#DBC740",
      "Comp. GP" = "#8cb543",
      "GP"     = "#8093D6",
      "Linear" = "#E68EAB",
      "Linear + Prev." = "#FC8D62",
      "Polynomial" = "#62C1C6"
)
p <- make_main_fig(df_all, colormap)
ggsave(plot=p, paste0(fig_dir, "model_combined.png"), bg="white", width=15, height=7)
```

# Supplementary plots
```{r}
make_supplementary_fig <- function(df_all, colormap) {
  p2 <- make_boxplot(df_all, colormap)
  p3 <- make_barplot(df_all, colormap)

  legend <- cowplot::get_legend(p3 +
                                guides(fill = guide_legend(nrow = 3)) +
                                theme(legend.position = "right",
                                      legend.title = element_blank(),
                                      legend.text = element_text(
                                      size = 14,
                                      margin = margin(r = 15, l=5))))
  title_b <- ggdraw() + 
    draw_label("A) Model log likelihoods", fontfamily = "Georgia", size = 24, hjust = -.01, x = 0)
  
  # Combine title B and legend
  title_and_legend <- plot_grid(
    title_b, 
    ggdraw(legend), 
    nrow = 1, 
    rel_widths = c(1, 1),
    align = "v"
  )

  top <- title_and_legend
  
  p2_nolabel <- p2 + theme(plot.title = element_blank(), axis.title.y=element_text(margin=margin(r=10))) + guides(fill="none")
  p3_nolabel <- p3 + ggtitle("B) Best fitting models") + theme(plot.title = element_text(size = 24, family="Georgia",  hjust = -0.1, margin=margin(b=25))) + guides(fill="none")
  
  bottom <- plot_grid(p2_nolabel, p3_nolabel, ncol = 1, rel_heights=c(1,1.2))
  
  final_plot <- plot_grid(
    top,
    bottom,
    ncol = 1,
    rel_heights = c(0.15, 1)  # adjust as needed
  )
  return(final_plot)
}
colormap <-  c(
      "LoT"    =  "#DBC740",
      "Nonrecursive LoT" = "#ba8d7d",
      "Comp. GP" = "#8cb543",
      "GP"     = "#8093D6", 
      "Linear" = "#E68EAB",
      "Linear + Prev." = "#FC8D62",
      "Polynomial" = "#62C1C6"
)
p <- make_supplementary_fig(df_all_nonrecursive, colormap)
ggsave(plot=p, paste0(fig_dir, "model_combined_nonrecursive.png"), bg="white", width=10, height=7)

colormap <-  c(
      "LoT"    =  "#DBC740",
      "Comp. GP" = "#8cb543",
      "GP"     = "#8093D6",
      "Linear" = "#E68EAB",
      "Linear + Prev." = "#FC8D62",
      "Polynomial" = "#62C1C6",
      "Transformer (2)" = "darkgrey",
      "Transformer (3)" = "lightgray",
      "Transformer (13)" = "white"
)
p <- make_supplementary_fig(df_all_transformer, colormap)
ggsave(plot=p, paste0(fig_dir, "model_combined_transformer.png"), bg="white", width=10, height=7)
```


# Monkey training data
######################

#Aggregate transformer fits to monkey training/ test
```{r}
ll_monkey_train <- data.frame()
for (i in c(1,2,3,4,5,6,8,10,13)) {
  file <- paste0("preprocessed_data/model_likelihoods/monkey_training/transformer_", i, "_monkeys_train.csv")
  ll_monkey_train <- bind_rows(ll_monkey_train, read.csv(file)%>%mutate(context_len = i))
}
ll_monkey_test <- data.frame()
for (i in c(1,2,3,4,5,6,8,10,13)) {
  file <- paste0("preprocessed_data/model_likelihoods/transformer_", i, "_monkeys.csv")
  ll_monkey_test <- bind_rows(ll_monkey_test, read.csv(file)%>%mutate(context_len = i))
}
ll_monkey_all <- bind_rows(ll_monkey_train %>% mutate(mode="train"),
                           ll_monkey_test %>% mutate(mode="test")) %>%
                           mutate(correct_distance = correct_distance/screen_w) %>%
                          mutate(correct_distance = max(correct_distance))
n_samples <- 100
n_rows <- nrow(ll_monkey_all)
all_samples_x <- rnorm(n_rows * n_samples)
all_samples_y <- rnorm(n_rows * n_samples)
ll_monkey_all <- ll_monkey_all %>%
  mutate(
    model_error_x = (model_pred_x - true_x),
    model_error_y = (model_pred_y - true_y),
    model_error = sqrt(model_error_x^2 + model_error_y^2),
    err_x = (pred_x - true_x),
    err_y = (pred_y - true_y),
    abs_err = sqrt(err_x^2 + err_y^2),
  ) %>%
  rowwise() %>%
  mutate(
    model_correct = {
      start_idx <- (row_number() - 1) * n_samples + 1
      end_idx <- row_number() * n_samples
      samples_x <- model_pred_x + model_std_x * all_samples_x[start_idx:end_idx]
      samples_y <- model_pred_y + model_std_y * all_samples_y[start_idx:end_idx]
      mask <- (samples_x > 0) & (samples_x < 1) & (samples_y > 0) & (samples_y < 1)
      samples_x <- subset(samples_x, mask)
      samples_y <- subset(samples_y, mask)
      distances <- sqrt((samples_x - true_x)^2 + (samples_y - true_y)^2)
      mean(distances < correct_distance)
    }
  ) %>%
  ungroup()
ll_monkey_delta <- ll_monkey_all %>%
  group_by(context_len, mode) %>%
  summarise(
    mean_LL = mean(LL, na.rm = TRUE),
    se_LL = sd(LL, na.rm = TRUE) / sqrt(n()),
    lower_LL = mean_LL - 1.96 * se_LL,
    upper_LL = mean_LL + 1.96 * se_LL,
    .groups = "drop"
  ) %>%
  group_by(mode) %>%
  mutate(max_LL = max(mean_LL, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    delta_LL = mean_LL - max_LL,
    delta_lower = lower_LL - max_LL,
    delta_upper = upper_LL - max_LL
  )
```
#Plot monkey LLs relative to best context length for all context lengths
```{r}
ll_monkey_transformer <- ggplot(data = ll_monkey_delta) +
  geom_ribbon(aes(x = context_len, ymin = delta_lower, ymax = delta_upper,
                  fill = mode), alpha = 0.3) +
  geom_line(aes(x = context_len, y = delta_LL,
                color = mode, linetype = mode),
            size = 1, alpha = 0.8) +
  geom_point(aes(x = context_len, y = delta_LL,
                 color = mode),
             size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  scale_color_manual(values = c("test" = "#A07CDE", "train" = "#DEA968"),
                     labels = c("Test", "Train")) +
  scale_fill_manual(values = c("test" = "#A07CDE", "train" = "#DEA968"),
                    labels = c("Test", "Train")) +
  scale_linetype_manual(values = c("test" = "solid", "train" = "dashed"),
                        labels = c("Test", "Train")) +
  scale_x_continuous(breaks = 1:13) +
  labs(x = "Transformer context length",
       y = expression("Mean LL - LL"[max]*"")) +
  paper_theme +
  theme(
    legend.title = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.85, 0.9),
    legend.justification = c(0.5, 0.5),
    legend.background = element_rect(fill = "white", color = "gray80", size = 0.3),
    legend.box.margin = margin(8, 8, 8, 8)
  )
ll_monkey_transformer
ggsave(plot=ll_monkey_transformer, paste0(fig_dir, "ll_monkey_transformer.png"), width=8, height=4, bg="white", dpi=400)
```


# NeurIPS data: Program-learning example
########################################
```{r}
preprocess_df_human_neurips <- function(df) {
  df$id <- seq_len(nrow(df))
  df$n <- df$tpt
  df <- df[order(df$tpt),] %>%
      rename(trial_idx=trial)
  return(df)
}

preprocess_df_model_neurips <- function(df_model) {
  df_model <- df_model %>%
        group_by(tpt, seq_id) %>%
        mutate(norm = logsumexp(score)) %>%
        ungroup() %>%
        mutate(posterior = exp(score - norm)) %>%
        rename(func.name = seq_id) %>%
        mutate(func.name = ifelse(func.name=="line", "line1", 
                                  ifelse(func.name=="line2", "line", func.name)))
  return(df_model)
}

df_adult <- preprocess_df_human_neurips(read.csv(paste0(data_dir, "NeurIPS_data/adults.csv"))) %>% arrange(tpt)
df_lot <- preprocess_df_model_neurips(read.csv(paste0(data_dir, "NeurIPS_data/lot.csv")))

df_stimuli <- df_lot %>%
              group_by(func.name, tpt) %>%
              summarize(true_x=mean(true_x), true_y=mean(true_y)) %>%
              group_by(func.name) %>%
              arrange(tpt)


df_stimuli <- df_stimuli %>% mutate(func_tpt = paste0(func.name, tpt)) %>% filter(func.name %in% unique(df_adult$func.name))
df_adult <- df_adult %>% mutate(func_tpt = paste0(func.name, tpt))
df_lot <- df_lot %>% mutate(func_tpt = paste0(func.name, tpt))
ex_df <- read.csv(paste0(data_dir, "NeurIPS_data/example_programs.csv")) %>%
         filter(!((func=="concat(move(), change_angle(int(-1)))") & (prediction_tpt>8))) 

```

```{r, fig.width=2.5, fig.height=2}
x_min <- -1
x_max <- 4.8
y_min <- -4.4#-1
y_max <- 1#-4.4#4.4
fig_width = 1.5
fig_height = 1.1

ex_program_plot <- function(f) {
  df <- ex_df %>%
        filter(func==f) %>%
        mutate(true_y=-true_y,
               pred_y=-pred_y)
  p <- ggplot(data=df) +
       geom_path(data=df %>% filter(prediction_tpt<curr_tpt),
                 aes(x=true_x, y=true_y), size=0.5, linetype="dotted") +
       geom_point(data=df %>% filter(prediction_tpt<curr_tpt-1),
                  aes(x=true_x, y=true_y), size=1.5, alpha=0.8, color="black") +
       geom_star(data=df %>% filter(prediction_tpt==curr_tpt-1),
                  aes(x=true_x, y=true_y), size = 2.5, starshape = 1, fill="black") +
       geom_path(data=df %>% filter(prediction_tpt>=curr_tpt-1),
                 aes(x=pred_x, y=pred_y, color="LoT"), linewidth=0.8, linetype="dotted") +
       geom_point(data=df %>% filter(prediction_tpt>=curr_tpt),
                  aes(x=pred_x, y=pred_y, color="LoT"),
                  shape=16, size=2, stroke=1) +
        scale_color_manual(values = c("Adults" = "#59ab9d", "LoT" = "#DBC740")) +
        coord_cartesian(xlim=c(x_min, x_max), ylim=c(y_min, y_max)) +
        theme_void() +
        theme(panel.background = element_rect(fill = "white"),
              plot.title = element_text(hjust = 0.5, size=18, family="Georgia")) +
        guides(alpha="none", size="none", fill="none", color="none")

  return(p)  
}

ex_data_plot <- function() {
  df <- ex_df %>%
        distinct(prediction_tpt, curr_tpt, true_x, true_y) %>%
        mutate(true_y=-true_y)
  p <- ggplot(data=df) +
       geom_path(data=df %>% filter(prediction_tpt<curr_tpt),
                 aes(x=true_x, y=true_y), size=0.5, linetype="dotted") +
       geom_point(data=df %>% filter(prediction_tpt<curr_tpt-1),
                  aes(x=true_x, y=true_y), size=1.5, alpha=0.8, color="black") +
       geom_star(data=df %>% filter(prediction_tpt==curr_tpt-1),
                  aes(x=true_x, y=true_y), size = 2.5,starshape = 1, fill="black") +
        scale_color_manual(values = c("Adults" = "#59ab9d", "LoT" = "#DBC740")) +
        coord_cartesian(xlim=c(x_min, x_max), ylim=c(y_min, y_max)) +
        theme_void() +
        theme(panel.background = element_rect(fill = "white"),
              plot.title = element_text(hjust = 0.5, size=18, family="Georgia")) +
        guides(alpha="none", size="none", fill="none", color="none")

  return(p)  
}
ex_prediction_plot <- function() {
  df <- ex_df %>%
        mutate(true_y=-true_y,
               pred_y=-pred_y)
  p <- ggplot(data=df) +
       geom_path(data=df %>%
                      distinct(prediction_tpt, curr_tpt, true_x, true_y) %>%
                      filter(prediction_tpt<curr_tpt),
                 aes(x=true_x, y=true_y), size=0.5, linetype="dotted") +
       geom_point(data=df %>%
                       distinct(prediction_tpt, curr_tpt, true_x, true_y) %>%
                       filter(prediction_tpt<curr_tpt-1),
                  aes(x=true_x, y=true_y), size=1.5, alpha=0.8, color="black") +
    geom_star(data=df %>%
                       distinct(prediction_tpt, curr_tpt, true_x, true_y) %>%
                       filter(prediction_tpt==curr_tpt-1),
                  aes(x=true_x, y=true_y), size = 2.5,starshape = 1, fill="black") +
       # Predictions
       geom_point(data=df %>% filter(prediction_tpt==curr_tpt),
                  aes(x=pred_x, y=pred_y, color="LoT",
                   alpha=log(posterior)), shape=4, size=1.5, stroke=1) +
        scale_alpha(range=c(0.3,0.8)) +
        scale_color_manual(values = c("Adults" = "#59ab9d", "LoT" = "#DBC740")) +
        coord_cartesian(xlim=c(x_min, x_max), ylim=c(y_min, y_max)) +
        theme_void() +
        theme(panel.background = element_rect(fill = "white"),
              plot.title = element_text(hjust = 0.5, size=18, family="Georgia")) +
        guides(alpha="none", size="none", fill="none", color="none")

  return(p)  
}

# plot data, predictions, programs
p <- ex_data_plot()
ggsave(paste0(fig_dir, "example_program_data.png"), width=fig_width, height=fig_height)
p <- ex_prediction_plot()
ggsave(paste0(fig_dir, "example_program_predictions.png"), width=fig_width, height=fig_height)
for (f in unique(ex_df$func)) {
  p <- ex_program_plot(f)
  ggsave(paste0(fig_dir, "example_program_", f, ".png"), width=fig_width, height=fig_height)
}
```

# LoT + Human sequences
```{r, fig.width=14, fig.height=2}
make_sequence_plots <- function(func_name, t_min=NULL, t_max=NULL, n_top=NULL) {
  if (is.null(t_min)) t_min <- min(df_adult$tpt)
  if (is.null(t_max)) t_max <- max(df_adult$tpt)
  t_min <- max(t_min, min(df_adult$tpt))
  t_max <- min(t_max, max(df_adult$tpt))
  if (is.null(n_top)) n_top <- length(unique(df_lot$particle))
  
  df_hum <- df_adult %>%
            filter((func.name == func_name) & (tpt < t_max+1) & (tpt>=t_min)) %>%
            mutate(true_y=-true_y,
                   pred_y=-pred_y)
  
  df_stim <- df_stimuli %>%
            filter((func.name == func_name) & (tpt < t_max+1)) %>%
            mutate(true_y=-true_y)
  
  df_mod <- df_lot %>%
            filter((func.name == func_name) & (tpt < t_max+1) & (tpt>=t_min)) %>%
            group_by(tpt) %>%
            slice_max(n=n_top, order_by=posterior) %>%
            mutate(true_y=-true_y,
                   pred_y=-pred_y)
  
  
            
  x_min <- min(min(min(df_stim$true_x, na.rm=TRUE), min(df_hum$pred_x, na.rm=TRUE)),
               min(df_mod$pred_x, na.rm=TRUE))
  x_max <- max(max(max(df_stim$true_x, na.rm=TRUE), max(df_hum$pred_x, na.rm=TRUE)),
               max(df_mod$pred_x, na.rm=TRUE))
  y_min <- min(min(min(df_stim$true_y, na.rm=TRUE), min(df_hum$pred_y, na.rm=TRUE)),
               min(df_mod$pred_y, na.rm=TRUE))
  y_max <- max(max(max(df_stim$true_y, na.rm=TRUE), max(df_hum$pred_y, na.rm=TRUE)),
               max(df_mod$pred_y, na.rm=TRUE))
  x_rng <- x_max - x_min
  y_rng <- y_max - y_min
  
  plots <- list()
  for (t in t_min:t_max) {
    df_tpt_hum <- subset(df_hum, (df_hum$tpt == t)) %>%
                  mutate(agent="Adults")
    
    df_tpt_mod <- subset(df_mod, (df_mod$tpt == t)) %>%
                  mutate(agent="LoT")

    df_last <- subset(df_stim, (df_stim$tpt == t-1))

    df_hist <- df_stim[order(df_stim$tpt),] %>% filter(tpt < t)
    df_prev <- df_stim[order(df_stim$tpt),] %>% filter(tpt < t-1)

    p <- ggplot() +
      geom_path(data=df_hist, aes(x=true_x, y=true_y), size=0.5, linetype="dotted") +
      geom_point(data=df_prev, aes(x=true_x, y=true_y), size=1.5, alpha=0.8, color="black") +
      geom_star(data=df_last, aes(x=true_x, y=true_y), size = 2, starshape = 1, fill="black") +
      geom_point(data=df_tpt_hum, aes(x=pred_x, y=pred_y, color="Adults"), shape=16, size=3.5, alpha=0.6) +
      
      geom_point(data=df_tpt_mod, aes(x=pred_x, y=pred_y, color="LoT", alpha=log(posterior)), shape=4, size=1.2, stroke=1.2) +
      scale_alpha(range=c(0.01,0.7)) +
      scale_color_manual(values = c("Adults" = "#59ab9d", "LoT" = "#DBC740")) + #"#FFD92F")) +
      
      coord_cartesian(xlim=c(x_min, x_max), ylim=c(y_min, y_max)) +
      theme_void() +
      theme(panel.background = element_rect(fill = "white"),
            plot.title = element_text(hjust = 0.5, size=18, family="Georgia")) +
      guides(alpha="none", size="none", fill="none", color="none")
    
    plots[[length(plots) + 1]] <- p
  }
  return(plots)
}

func <- "triangle_spiral"
plots <- make_sequence_plots(func, t_min=6, t_max=12)
plots <- lapply(plots, function(p) {
  p + theme(plot.margin = margin(0.05, 0.01, 0.05, 0.01, "in"))
})
p1 <- grid.arrange(grobs=plots, nrow=1)

func <- "alternating_diff_1"
plots <- make_sequence_plots(func, t_min=3, t_max=9)
plots <- lapply(plots, function(p) {
  p + theme(plot.margin = margin(0.05, 0.01, 0.05, 0.01, "in"))
})
p2 <- grid.arrange(grobs=plots, nrow=1)

func <- "increasing_lines"
plots <- make_sequence_plots(func, t_min=2, t_max=8)
plots <- lapply(plots, function(p) {
  p + theme(plot.margin = margin(0.05, 0.01, 0.05, 0.01, "in"))
})
p3 <- grid.arrange(grobs=plots, nrow=1)

func <- "growing_stairs_2"
plots <- make_sequence_plots(func, t_min=6, t_max=12)
plots <- lapply(plots, function(p) {
  p + theme(plot.margin = margin(0.05, 0.01, 0.05, 0.01, "in"))
})
p4 <- grid.arrange(grobs=plots, nrow=1)

p_all <- grid.arrange(grobs=list(p1, p2, p3, p4), nrow=4) 

legend <- cowplot::get_legend(plots[[1]] +
                              guides(color = guide_legend()) +
                              theme(legend.position = "top",
                                    legend.title = element_blank(),
                                    legend.text = element_text(size = 18,
                                                                margin = margin(r=15, l=5))))
final_plot <- plot_grid(
  legend,
  p_all,
  ncol = 1,
  rel_heights = c(0.08, 1) 
)

final_plot
ggsave(plot=final_plot, paste0(fig_dir, "example_neurips_predictions.png"), width=10.4, height=5.6, bg="white")
```

# Generate videos
#################

# Make videos comparing single participant with single model, overlaid
```{r, echo=F, message=F}
# Preprocessing
logsumexp <- function(x) {
  max_x <- max(x)
  max_x + log(sum(exp(x - max_x)))
}

preprocess_df_model <- function(df_model) {
  df_model <- df_model %>%
              group_by(tpt, seq_id) %>%
              mutate(norm = logsumexp(score)) %>%
              ungroup() %>%
              mutate(posterior = exp(score - norm)) %>%
              rename(func.name = seq_id) %>%
              mutate(std_x = sd_x, std_y = sd_y)
  return(df_model)
}
preprocess_df_linear_or_prev <- function(df_model) {
  # Split particle probability mass between periodic and linear predictions
  df_model <- df_model %>%
              rename(func.name = seq_id)
  
  prev_pt_df <- df_model %>%
                group_by(func.name, tpt) %>%
                summarize(true_x = mean(true_x),
                          true_y = mean(true_y),
                          .groups="drop") %>%
                arrange(tpt) %>%
                mutate(prev_x = lag(true_x), prev_y = lag(true_y)) %>%
                select(-c("true_x", "true_y"))

  df_grouped <- df_model %>%
                mutate(posterior = exp(score)) %>%
                distinct(func.name, tpt, particle, posterior) %>%
                group_by(func.name, tpt) %>%
                mutate(posterior = posterior / sum(posterior)) %>%
                ungroup()
  
  df_model <- df_model %>%
              left_join(df_grouped %>% select(func.name, tpt, particle, posterior),
                        by = c("func.name", "tpt", "particle"))

  df_model <- df_model %>%
              group_by(func.name, tpt) %>%
              mutate(expanded_particle = paste0(particle, "_", row_number())) %>%
              mutate(particle = as.integer(factor(expanded_particle))) %>%
              mutate(pred_x = mean_x, pred_y = mean_y) %>%
              group_by(func.name, tpt, particle) %>%
              mutate(sd_x = ifelse(is_periodic, sd_periodic_x, sd_vec_x),
                     sd_y = ifelse(is_periodic, sd_periodic_y, sd_vec_y)) %>%
              ungroup() %>%
              rowwise() %>%
              mutate(posterior = posterior * component_weight) %>%
              mutate(std_x = sd_x) %>%
              mutate(std_y = sd_y) %>%
              merge(prev_pt_df, by=c("func.name", "tpt"))
        
  return(df_model)
}
preprocess_df_transformer <- function(df_transformer) {
  # For each function, compute the mapping from transformer coords to reference coords
  df_ref <- read.csv(paste0(data_dir, "participants/adults.csv")) %>%
            rename(pred_x = response_x, pred_y = response_y, func.name = seq_id) %>%
            group_by(func.name, tpt) %>%
            summarize(ref_true_x = mean(true_x),
                      ref_true_y = mean(true_y),
                      .groups="drop")

  df_transformer <- df_transformer %>%
                    preprocess_df_model() %>%
                    merge(df_ref, by=c("func.name", "tpt")) %>%
                    group_by(func.name) %>%
                    mutate(
                      t1x = min(true_x), t2x = max(true_x),
                      r1x = min(ref_true_x), r2x = max(ref_true_x),
                      mx = ifelse(t2x==t1x, 1, (r2x-r1x)/(t2x-t1x)),
                      bx = r1x - mx*t1x,
                      t1y = min(true_y), t2y = max(true_y),
                      r1y = min(ref_true_y), r2y = max(ref_true_y),
                      my = ifelse(t2y==t1y, mx, (r2y-r1y)/(t2y-t1y)),
                      by = r1y - my*t1y
                    ) %>%
                    rowwise() %>%
                    mutate(true_x = true_x * mx + bx,
                           pred_x = pred_x * mx + bx,
                           std_x = std_x * mx,
                           true_y = true_y * my + by,
                           pred_y = pred_y * my + by,
                           std_y = std_y * my)
  return(df_transformer)
}

df_kid_vids <- read.csv(paste0(data_dir, "participants/kids.csv")) %>%
               rename(pred_x = response_x, pred_y = response_y, func.name = seq_id)
df_adult_vids <- read.csv(paste0(data_dir, "participants/adults.csv")) %>%
               rename(pred_x = response_x, pred_y = response_y, func.name = seq_id)
df_monkey_vids <- read.csv(paste0(data_dir, "participants/monkeys.csv")) %>%
                  rename(true_x=x_next, true_y=y_next, prev_x=x_curr, prev_y=y_curr, pred_x=x_pred,
                         subject_id = monkey_name, pred_y = y_pred, func.name = func_id, tpt=n)

out_folder <- "../videos/frames/"


model_list <- c("LoT", "Nonrecursive LoT", "GP", "Comp. GP", "Polynomial", "Linear", "Linear + Prev.", "Transformer (2)", "Transformer (3)", "Transformer (13)")
participant_list <- c("Monkeys", "Monkey 1", "Monkey 2", "3 yos", "4 yos", "5 yos", "6 yos", "7 yos", "Adults") 

participant_dfs <- list("3 yos" = df_kid_vids%>%filter(age==3),
                        "4 yos"=df_kid_vids%>%filter(age==4),
                        "5 yos"=df_kid_vids%>%filter(age==5),
                        "6 yos"=df_kid_vids%>%filter(age==6),
                        "7 yos"=df_kid_vids%>%filter(age==7),
                        "Adults"=df_adult_vids,
                        "Monkeys"=df_monkey_vids,
                        "Monkey 1"=df_monkey_vids%>%filter(subject_id=="Monkey 1"),
                        "Monkey 2"=df_monkey_vids%>%filter(subject_id=="Monkey 2"))

model_dfs <- list("LoT" = preprocess_df_model(read.csv(paste0(data_dir, "models/lot.csv"))),
                  "Nonrecursive LoT" = preprocess_df_model(read.csv(paste0(data_dir, "models/lot_nonrecursive.csv"))),
                  "GP" = preprocess_df_model(read.csv(paste0(data_dir, "models/gp.csv"))),
                  "Comp. GP" =  preprocess_df_model(read.csv(paste0(data_dir, "models/comp_gp.csv"))),
                  "Poynomial" = preprocess_df_model(read.csv(paste0(data_dir, "models/ridge.csv"))),
                  "Linear" = preprocess_df_model(read.csv(paste0(data_dir, "models/linear.csv"))),
                  "Linear + Prev." = preprocess_df_linear_or_prev(read.csv(paste0(data_dir, "models/linear_or_prev.csv"))),
                  "Transformer (2)" = preprocess_df_transformer(read.csv(paste0(data_dir, "models/transformer_2.csv"))),
                  "Transformer (3)" = preprocess_df_transformer(read.csv(paste0(data_dir, "models/transformer_3.csv"))),
                  "Transformer (13)" = preprocess_df_transformer(read.csv(paste0(data_dir, "models/transformer_13.csv"))))

```

```{r}

make_func_vid <- function(funcname, df_participant, df_model) {
  df_seq <- subset(df_participant, (df_participant$func.name == funcname))
  dir.create(paste0(out_folder, "/", funcname))
  x_min <- min(min(df_seq$true_x, na.rm=TRUE), min(df_seq$pred_x, na.rm=TRUE))
  x_max <- max(max(df_seq$true_x, na.rm=TRUE), max(df_seq$pred_x, na.rm=TRUE))
  y_min <- min(min(df_seq$true_y, na.rm=TRUE), min(df_seq$pred_y, na.rm=TRUE))
  y_max <- max(max(df_seq$true_y, na.rm=TRUE), max(df_seq$pred_y, na.rm=TRUE))
  
  range_x <- (x_max-x_min)
  range_y <- (y_max-y_min)

  shift_x<-range_x*1.5

  frame_num <- 0
  
  for (i in (min(df_participant$tpt)+1):max(df_participant$tpt)) {
    df_tpt <- subset(df_seq, (df_seq$tpt == i))
    df_hist <- df_seq[order(df_seq$tpt),] %>% filter(tpt<i)
    
    p1 <- ggplot() +
          # prev points and path
          geom_path(data=df_hist, aes(x=true_x, y=true_y), linewidth=0.25, linetype="dotted") +
          geom_point(data=df_hist%>%filter(tpt==max(tpt)), aes(x=true_x, y=true_y, color="agent1"), size=1) +
          geom_point(data=df_hist%>%filter(tpt==max(tpt)), aes(x=true_x, y=true_y, color="agent2"), size=1) +
          geom_point(data=df_hist, aes(x=true_x, y=true_y), size=3) +
          # shifted
          geom_path(data=df_hist, aes(x=true_x+shift_x, y=true_y), linewidth=0.25, linetype="dotted") +
          geom_point(data=df_hist%>%filter(tpt==max(tpt)), aes(x=true_x+shift_x, y=true_y, color="agent1"), size=1) +
          geom_point(data=df_hist%>%filter(tpt==max(tpt)), aes(x=true_x+shift_x, y=true_y, color="agent2"), size=1) +
          geom_point(data=df_hist, aes(x=true_x+shift_x, y=true_y), size=3) +
          # formatting
          scale_color_manual(labels = c("agent1"=agent1, "agent2"=agent2),
                            values=c("agent1"="maroon", "agent2"="#516797"),
                            breaks = c("agent1", "agent2")) +
          coord_equal(xlim=c(x_min-range_x*.2, x_min+(range_x*2.7)),
                      ylim=c(y_min-(range_y*.2), y_min+(range_y*1.2))) +
          theme_void() +
          theme(panel.background = element_rect(fill = "white"),
                #legend.background = element_rect(fill = "white", color=NA),
                legend.text=element_text(size=18, margin = margin(r = 20, l=10)),
                legend.title=element_blank(),
                legend.spacing.y = unit(2, "lines"),
                legend.position = "top") +
          guides(alpha="none",
                 size="none",
                 fill="none",
                 color = guide_legend(override.aes = list(size = 5)))
    
    p2 <- p1 +
            # next true point
            geom_point(data=df_tpt, aes(x=true_x, y=true_y), color="gold", shape=8, size=4, stroke=2.0) +
            geom_point(data=df_tpt, aes(x=true_x+shift_x, y=true_y), color="gold", shape=8, size=4, stroke=2.0)
          
    df_model_tpt <- df_model %>%
                    filter(tpt==i) %>%
                    filter(func.name==funcname) %>%
                    group_by(pred_x, pred_y) %>%
                    summarize(posterior=sum(posterior))
    
    if (i<3) {
      p_list <- list(p1, p2)
    } else {
      p3 <- p2 +
              # model predictions
              geom_point(data=df_model_tpt,
                         aes(x=pred_x+shift_x, y=pred_y, alpha=log(posterior), color="agent2"),
                         size=2, stroke=1) +
              # participant predictions
              geom_point(data=df_tpt, aes(x=pred_x, y=pred_y, color="agent1"), size=2, stroke=1, alpha=0.7)
      p_list <- list(p1, p2, p3, p3, p3)
    } 
    for (p in p_list) {
      f_name <- paste0(out_folder, funcname, "/", frame_num, ".png")
      frame_num <- frame_num + 1 
      ggsave(f_name, plot=p, width=10,height=5, dpi=500, bg="white")
    }
    
  }
}


for (i in (1:length(model_list))) {
  agent2 <- model_list[i]
  df_model <- model_dfs[[agent2]]
  for (j in (1:length(participant_list))) {
    agent1 <- participant_list[j]
    df_participant <- participant_dfs[[agent1]]
    out_folder <- paste0("../videos/frames/", gsub(" ", "_", agent1), "_", gsub(" ", "_", agent2), "/")

    unlink(out_folder, recursive=TRUE)
    dir.create(out_folder)
    df_participant <- df_participant[order(df_participant$tpt),]
    for (id in sort(unique(df_participant$func.name))) {
      print(id)
      make_func_vid(id, df_participant, df_model)
    }
  }
}
```


